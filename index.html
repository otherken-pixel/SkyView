<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlightScore</title>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for in-browser JSX compiling -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Google Fonts & Material Symbols (MD3) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;600;700&family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <style>
        /* Material Design 3 (Material You) Token System */
        :root {
            /* LIGHT THEME (Default) */
            --md-sys-color-primary: #0b57d0;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #d3e3fd;
            --md-sys-color-on-primary-container: #041e49;
            
            --md-sys-color-secondary: #535f70;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #d7e3f7;
            --md-sys-color-on-secondary-container: #101c2b;
            
            --md-sys-color-tertiary: #6b5778;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #f2daff;
            --md-sys-color-on-tertiary-container: #251431;

            --md-sys-color-error: #b3261e;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #f9dedc;
            --md-sys-color-on-error-container: #410e0b;

            --md-sys-color-warning: #855400;
            --md-sys-color-warning-container: #ffddb3;
            --md-sys-color-on-warning-container: #2a1700;

            --md-sys-color-background: #fdfbff;
            --md-sys-color-on-background: #1a1c1e;
            
            --md-sys-color-surface: #fdfbff;
            --md-sys-color-on-surface: #1a1c1e;
            --md-sys-color-surface-variant: #dfe2eb;
            --md-sys-color-on-surface-variant: #43474e;
            
            --md-sys-color-surface-container-lowest: #ffffff;
            --md-sys-color-surface-container-low: #f3f3fa;
            --md-sys-color-surface-container: #ece6f0;
            --md-sys-color-surface-container-high: #e6e0e9;
            --md-sys-color-surface-container-highest: #e0dce3;
            
            --md-sys-color-outline: #73777f;
            --md-sys-color-outline-variant: #c3c6cf;
            
            /* Flight Category Colors */
            --cat-vfr-color: #0f5223;
            --cat-vfr-bg: #c4eed0;
            --cat-mvfr-color: #0b57d0;
            --cat-mvfr-bg: #d3e3fd;
            --cat-ifr-color: #b3261e;
            --cat-ifr-bg: #f9dedc;
            --cat-lifr-color: #6b5778;
            --cat-lifr-bg: #f2daff;

            --font-sans: 'Roboto', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* DARK THEME */
                --md-sys-color-primary: #a8c7fa;
                --md-sys-color-on-primary: #062e6f;
                --md-sys-color-primary-container: #0842a0;
                --md-sys-color-on-primary-container: #d3e3fd;
                
                --md-sys-color-secondary: #bbc7db;
                --md-sys-color-on-secondary: #253140;
                --md-sys-color-secondary-container: #3b4858;
                --md-sys-color-on-secondary-container: #d7e3f7;
                
                --md-sys-color-tertiary: #d6bdfb;
                --md-sys-color-on-tertiary: #3a2948;
                --md-sys-color-tertiary-container: #523f5f;
                --md-sys-color-on-tertiary-container: #f2daff;

                --md-sys-color-error: #ffb4ab;
                --md-sys-color-on-error: #690005;
                --md-sys-color-error-container: #93000a;
                --md-sys-color-on-error-container: #ffdad6;

                --md-sys-color-warning: #ffb951;
                --md-sys-color-warning-container: #653e00;
                --md-sys-color-on-warning-container: #ffddb3;

                --md-sys-color-background: #111114;
                --md-sys-color-on-background: #e2e2e6;
                
                --md-sys-color-surface: #111114;
                --md-sys-color-on-surface: #e2e2e6;
                --md-sys-color-surface-variant: #43474e;
                --md-sys-color-on-surface-variant: #c3c6cf;
                
                --md-sys-color-surface-container-lowest: #0c0f12;
                --md-sys-color-surface-container-low: #191c20;
                --md-sys-color-surface-container: #1d2024;
                --md-sys-color-surface-container-high: #282a2f;
                --md-sys-color-surface-container-highest: #33353a;
                
                --md-sys-color-outline: #8d9199;
                --md-sys-color-outline-variant: #43474e;

                /* Flight Category Colors (Dark) */
                --cat-vfr-color: #6dd58c;
                --cat-vfr-bg: #0d381e;
                --cat-mvfr-color: #a8c7fa;
                --cat-mvfr-bg: #0842a0;
                --cat-ifr-color: #ffb4ab;
                --cat-ifr-bg: #93000a;
                --cat-lifr-color: #d6bdfb;
                --cat-lifr-bg: #523f5f;
            }
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            font-family: var(--font-sans);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        * {
            box-sizing: border-box;
        }

        /* Material Icons Setup */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            display: inline-block;
            vertical-align: middle;
            line-height: 1;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--md-sys-color-background); }
        ::-webkit-scrollbar-thumb { background: var(--md-sys-color-surface-variant); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--md-sys-color-outline); }

        /* General Utilities */
        .font-mono { font-family: var(--font-mono); }
        
        /* Interactive element transitions */
        button, a, .interactive {
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        }

        /* Spin animation for loading indicator */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Leaflet map overrides */
        .leaflet-container { z-index: 0; font-family: var(--font-sans); }
        .leaflet-control-attribution { font-size: 10px !important; }
        .route-icao-label {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 12px;
            color: #1a1c1e;
            text-shadow: 0 0 4px #fff, 0 0 4px #fff, 0 0 4px #fff;
            white-space: nowrap;
        }

        /* ── Manual dark / light theme overrides (JS toggle beats @media) ── */
        body.dark-theme {
            --md-sys-color-primary: #a8c7fa; --md-sys-color-on-primary: #062e6f;
            --md-sys-color-primary-container: #0842a0; --md-sys-color-on-primary-container: #d3e3fd;
            --md-sys-color-secondary: #bbc7db; --md-sys-color-on-secondary: #253140;
            --md-sys-color-secondary-container: #3b4858; --md-sys-color-on-secondary-container: #d7e3f7;
            --md-sys-color-tertiary: #d6bdfb; --md-sys-color-on-tertiary: #3a2948;
            --md-sys-color-tertiary-container: #523f5f; --md-sys-color-on-tertiary-container: #f2daff;
            --md-sys-color-error: #ffb4ab; --md-sys-color-on-error: #690005;
            --md-sys-color-error-container: #93000a; --md-sys-color-on-error-container: #ffdad6;
            --md-sys-color-warning: #ffb951; --md-sys-color-warning-container: #653e00; --md-sys-color-on-warning-container: #ffddb3;
            --md-sys-color-background: #111114; --md-sys-color-on-background: #e2e2e6;
            --md-sys-color-surface: #111114; --md-sys-color-on-surface: #e2e2e6;
            --md-sys-color-surface-variant: #43474e; --md-sys-color-on-surface-variant: #c3c6cf;
            --md-sys-color-surface-container-lowest: #0c0f12; --md-sys-color-surface-container-low: #191c20;
            --md-sys-color-surface-container: #1d2024; --md-sys-color-surface-container-high: #282a2f;
            --md-sys-color-surface-container-highest: #33353a;
            --md-sys-color-outline: #8d9199; --md-sys-color-outline-variant: #43474e;
            --cat-vfr-color: #6dd58c; --cat-vfr-bg: #0d381e;
            --cat-mvfr-color: #a8c7fa; --cat-mvfr-bg: #0842a0;
            --cat-ifr-color: #ffb4ab; --cat-ifr-bg: #93000a;
            --cat-lifr-color: #d6bdfb; --cat-lifr-bg: #523f5f;
        }
        body.light-theme {
            --md-sys-color-primary: #0b57d0; --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #d3e3fd; --md-sys-color-on-primary-container: #041e49;
            --md-sys-color-secondary: #535f70; --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #d7e3f7; --md-sys-color-on-secondary-container: #101c2b;
            --md-sys-color-tertiary: #6b5778; --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #f2daff; --md-sys-color-on-tertiary-container: #251431;
            --md-sys-color-error: #b3261e; --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #f9dedc; --md-sys-color-on-error-container: #410e0b;
            --md-sys-color-warning: #855400; --md-sys-color-warning-container: #ffddb3; --md-sys-color-on-warning-container: #2a1700;
            --md-sys-color-background: #fdfbff; --md-sys-color-on-background: #1a1c1e;
            --md-sys-color-surface: #fdfbff; --md-sys-color-on-surface: #1a1c1e;
            --md-sys-color-surface-variant: #dfe2eb; --md-sys-color-on-surface-variant: #43474e;
            --md-sys-color-surface-container-lowest: #ffffff; --md-sys-color-surface-container-low: #f3f3fa;
            --md-sys-color-surface-container: #ece6f0; --md-sys-color-surface-container-high: #e6e0e9;
            --md-sys-color-surface-container-highest: #e0dce3;
            --md-sys-color-outline: #73777f; --md-sys-color-outline-variant: #c3c6cf;
            --cat-vfr-color: #0f5223; --cat-vfr-bg: #c4eed0;
            --cat-mvfr-color: #0b57d0; --cat-mvfr-bg: #d3e3fd;
            --cat-ifr-color: #b3261e; --cat-ifr-bg: #f9dedc;
            --cat-lifr-color: #6b5778; --cat-lifr-bg: #f2daff;
        }

        /* ── Airport autocomplete dropdown ── */
        .apt-suggest-drop {
            position: absolute; top: calc(100% + 2px); left: 0; right: 0;
            background: var(--md-sys-color-surface-container-low);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 12px; overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.20);
            z-index: 9999; max-height: 240px; overflow-y: auto;
        }
        .apt-suggest-item {
            display: flex; align-items: center; gap: 10px; padding: 10px 14px;
            cursor: pointer; border-bottom: 1px solid var(--md-sys-color-outline-variant);
            transition: background 0.15s;
        }
        .apt-suggest-item:hover { background: var(--md-sys-color-secondary-container); }
        .apt-suggest-item:last-child { border-bottom: none; }

        /* ── Conversational AI chat bubbles ── */
        .chat-bubble-user {
            align-self: flex-end; max-width: 85%;
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-radius: 18px 18px 4px 18px;
            padding: 10px 14px; font-size: 13px; line-height: 1.5; white-space: pre-wrap;
        }
        .chat-bubble-ai {
            align-self: flex-start; max-width: 92%;
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
            border-radius: 18px 18px 18px 4px;
            padding: 10px 14px; font-size: 13px; line-height: 1.5; white-space: pre-wrap;
        }

        /* ── Mobile responsive: hide side rail, show bottom tabs ── */
        .mobile-bottom-nav { display: none; }
        @media (max-width: 640px) {
            .nav-rail { display: none !important; }
            .mobile-bottom-nav {
                display: flex !important;
                position: fixed; bottom: 0; left: 0; right: 0;
                background: var(--md-sys-color-surface);
                border-top: 1px solid var(--md-sys-color-outline-variant);
                justify-content: space-around; align-items: center;
                height: 60px; z-index: 200;
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }
            .briefing-content { padding: 16px 12px 80px !important; }
        }

        /* ── Print: hide everything except the export region ───────────────── */
        @media print {
            .no-print { display: none !important; }
            body * { visibility: hidden; }
            #export-printable, #export-printable * { visibility: visible; }
            #export-printable {
                position: fixed;
                top: 0; left: 0; right: 0;
                background: #fff;
                color: #1a1a1a;
                font-family: Roboto, Arial, sans-serif;
                z-index: 9999;
                border: none !important;
                border-radius: 0 !important;
            }
            @page { size: A4 portrait; margin: 12mm 15mm; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        /* =========================================
           DATA & UTILITIES
        ========================================= */
        const AIRPORTS = {
            KCLT: { name: "Charlotte Douglas Intl", city: "Charlotte", state: "NC", lat: 35.214, lon: -80.943, elev: 748, rwy: ["18L/36R", "18C/36C", "18R/36L"], artcc: "Washington Ctr", freq: { atis: "127.235", twr: "119.9", gnd: "121.9", app: "124.0", dep: "120.05", clnc: "118.55" } },
            KATL: { name: "Hartsfield-Jackson Atlanta", city: "Atlanta", state: "GA", lat: 33.641, lon: -84.428, elev: 1026, rwy: ["08L/26R", "08R/26L", "09L/27R"], artcc: "Atlanta Ctr", freq: { atis: "125.55", twr: "119.1", gnd: "121.9", app: "119.8", dep: "125.0", clnc: "121.65" } },
            KJFK: { name: "John F Kennedy Intl", city: "New York", state: "NY", lat: 40.641, lon: -73.778, elev: 13, rwy: ["04L/22R", "04R/22L", "13L/31R"], artcc: "New York Ctr", freq: { atis: "128.725", twr: "119.1", gnd: "121.9", app: "120.8", dep: "123.7", clnc: "135.05" } },
            KORD: { name: "O'Hare Intl", city: "Chicago", state: "IL", lat: 41.974, lon: -87.907, elev: 672, rwy: ["09L/27R", "09C/27C", "10L/28R"], artcc: "Chicago Ctr", freq: { atis: "135.4", twr: "120.75", gnd: "121.75", app: "124.35", dep: "125.0", clnc: "118.95" } },
            KLAX: { name: "Los Angeles Intl", city: "Los Angeles", state: "CA", lat: 33.943, lon: -118.408, elev: 128, rwy: ["06L/24R", "07L/25R", "07R/25L"], artcc: "Los Angeles Ctr", freq: { atis: "133.8", twr: "120.95", gnd: "121.75", app: "124.5", dep: "125.2", clnc: "133.65" } },
            KSFO: { name: "San Francisco Intl", city: "San Francisco", state: "CA", lat: 37.621, lon: -122.379, elev: 13, rwy: ["01L/19R", "10L/28R", "10R/28L"], artcc: "Oakland Ctr", freq: { atis: "118.85", twr: "120.5", gnd: "121.8", app: "120.35", dep: "120.9", clnc: "118.2" } },
            KDFW: { name: "Dallas/Fort Worth Intl", city: "Dallas", state: "TX", lat: 32.9, lon: -97.04, elev: 607, rwy: ["13L/31R", "17C/35C", "18L/36R"], artcc: "Fort Worth Ctr", freq: { atis: "134.9", twr: "118.75", gnd: "121.65", app: "124.15", dep: "119.2", clnc: "128.25" } },
            KDEN: { name: "Denver Intl", city: "Denver", state: "CO", lat: 39.856, lon: -104.674, elev: 5431, rwy: ["07/25", "08/26", "16L/34R", "17L/35R"], artcc: "Denver Ctr", freq: { atis: "132.35", twr: "118.3", gnd: "121.85", app: "120.8", dep: "128.25", clnc: "134.0" } },
            KMIA: { name: "Miami Intl", city: "Miami", state: "FL", lat: 25.796, lon: -80.287, elev: 8, rwy: ["08L/26R", "08R/26L", "12/30"], artcc: "Miami Ctr", freq: { atis: "132.45", twr: "118.3", gnd: "121.8", app: "124.6", dep: "125.2", clnc: "130.45" } },
            KSEA: { name: "Seattle-Tacoma Intl", city: "Seattle", state: "WA", lat: 47.45, lon: -122.309, elev: 433, rwy: ["16C/34C", "16L/34R"], artcc: "Seattle Ctr", freq: { atis: "118.0", twr: "119.9", gnd: "121.7", app: "120.4", dep: "120.1", clnc: "128.0" } },
            KBOS: { name: "Boston Logan Intl", city: "Boston", state: "MA", lat: 42.366, lon: -71.01, elev: 20, rwy: ["04L/22R", "09/27", "15L/33R"], artcc: "Boston Ctr", freq: { atis: "128.8", twr: "119.1", gnd: "121.9", app: "120.6", dep: "133.0", clnc: "121.65" } },
            KPHX: { name: "Phoenix Sky Harbor", city: "Phoenix", state: "AZ", lat: 33.437, lon: -112.008, elev: 1135, rwy: ["07L/25R", "07R/25L"], artcc: "Albuquerque Ctr", freq: { atis: "127.575", twr: "118.7", gnd: "119.75", app: "119.2", dep: "120.7", clnc: "120.65" } },
            KMCO: { name: "Orlando Intl", city: "Orlando", state: "FL", lat: 28.431, lon: -81.308, elev: 96, rwy: ["17L/35R", "17R/35L"], artcc: "Jacksonville Ctr", freq: { atis: "124.8", twr: "118.45", gnd: "121.8", app: "124.8", dep: "125.85", clnc: "121.15" } },
            KCHS: { name: "Charleston Intl", city: "Charleston", state: "SC", lat: 32.899, lon: -80.041, elev: 46, rwy: ["03/21", "15/33"], artcc: "Jacksonville Ctr", freq: { atis: "128.475", twr: "118.6", gnd: "121.8", app: "119.3", dep: "126.0", clnc: "121.75" } },
            KGSP: { name: "Greenville-Spartanburg", city: "Greenville", state: "SC", lat: 34.896, lon: -82.219, elev: 964, rwy: ["04/22"], artcc: "Atlanta Ctr", freq: { atis: "121.1", twr: "120.5", gnd: "121.7", app: "119.0", dep: "124.4", clnc: "121.8" } },
            KCAE: { name: "Columbia Metropolitan", city: "Columbia", state: "SC", lat: 33.939, lon: -81.12, elev: 236, rwy: ["05/23", "11/29"], artcc: "Atlanta Ctr", freq: { atis: "119.3", twr: "119.5", gnd: "121.9", app: "119.0", dep: "124.4", clnc: "124.0" } },
            KRDU: { name: "Raleigh-Durham Intl", city: "Raleigh", state: "NC", lat: 35.878, lon: -78.788, elev: 435, rwy: ["05L/23R", "05R/23L"], artcc: "Washington Ctr", freq: { atis: "128.0", twr: "118.3", gnd: "121.9", app: "124.8", dep: "125.3", clnc: "121.15" } },
            KIAD: { name: "Washington Dulles Intl", city: "Washington", state: "DC", lat: 38.947, lon: -77.46, elev: 313, rwy: ["01L/19R", "01C/19C"], artcc: "Washington Ctr", freq: { atis: "134.85", twr: "120.1", gnd: "121.9", app: "120.45", dep: "125.05", clnc: "118.55" } },
            KMSY: { name: "New Orleans Intl", city: "New Orleans", state: "LA", lat: 29.993, lon: -90.258, elev: 4, rwy: ["02/20", "11/29"], artcc: "Houston Ctr", freq: { atis: "128.35", twr: "119.45", gnd: "121.9", app: "123.8", dep: "120.6", clnc: "119.05" } },
            KCVG: { name: "Cincinnati/N Kentucky", city: "Cincinnati", state: "OH", lat: 39.049, lon: -84.662, elev: 896, rwy: ["09/27", "18C/36C"], artcc: "Indianapolis Ctr", freq: { atis: "127.375", twr: "118.3", gnd: "121.7", app: "119.7", dep: "125.8", clnc: "121.75" } },
            KUZA: { name: "Rock Hill/York County", city: "Rock Hill", state: "SC", lat: 34.987, lon: -81.057, elev: 666, rwy: ["02/20", "15/33"], artcc: "Charlotte Ctr", freq: { atis: "122.7", twr: "122.8", gnd: "122.8", app: "124.0", dep: "124.0", clnc: "122.8" }, tafRef: "KCLT" }
        };

        // FBO data per airport: name, phone, fuel types, hours, services.
        // Fuel prices change daily — link to AOPA for live pricing.
        const FBO_DATA = {
            KCLT: [{ name: "Signature Flight Support", phone: "(704) 359-4730", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Crew Car", "Rental Car", "WiFi", "Catering"] }],
            KATL: [{ name: "Signature Flight Support", phone: "(404) 530-2750", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Crew Car", "Rental Car", "Catering"] }],
            KJFK: [{ name: "Signature Flight Support", phone: "(718) 553-1200", fuel: [{ type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Rental Car", "Catering"] }],
            KORD: [{ name: "Signature Flight Support", phone: "(847) 671-4100", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Crew Car", "Rental Car"] }],
            KLAX: [{ name: "Signature Aviation", phone: "(310) 417-1750", fuel: [{ type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Rental Car", "Catering"] }],
            KSFO: [{ name: "Signature Flight Support", phone: "(650) 877-6800", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Crew Car", "Rental Car"] }],
            KDFW: [{ name: "Signature Flight Support", phone: "(972) 615-7800", fuel: [{ type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Rental Car", "Catering"] }],
            KDEN: [{ name: "Signature Flight Support", phone: "(303) 342-5600", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Crew Car", "Rental Car"] }],
            KMIA: [{ name: "Signature Flight Support", phone: "(305) 526-2000", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Crew Car", "Rental Car", "Catering"] }],
            KSEA: [{ name: "Signature Flight Support", phone: "(206) 433-5481", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Crew Car", "Rental Car"] }],
            KBOS: [{ name: "Signature Flight Support", phone: "(617) 561-2500", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Crew Car", "Rental Car"] }],
            KPHX: [{ name: "Million Air", phone: "(602) 997-5800", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Crew Car", "Rental Car"] }],
            KMCO: [{ name: "Signature Flight Support", phone: "(407) 855-3830", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Crew Car", "Rental Car"] }],
            KCHS: [{ name: "Signature Flight Support", phone: "(843) 767-8200", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "Daily 0600–2200", services: ["GPU", "Crew Car", "Rental Car"] }],
            KGSP: [{ name: "Signature Flight Support", phone: "(864) 848-6700", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "Daily 0600–2100", services: ["GPU", "Crew Car", "Rental Car"] }],
            KCAE: [{ name: "Signature Flight Support", phone: "(803) 794-3400", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "Daily 0600–2100", services: ["GPU", "Crew Car", "Rental Car"] }],
            KRDU: [{ name: "Signature Flight Support", phone: "(919) 840-0073", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "Daily 0600–2200", services: ["GPU", "Crew Car", "Rental Car"] }],
            KIAD: [{ name: "Signature Flight Support", phone: "(703) 572-0001", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Crew Car", "Rental Car", "Catering"] }],
            KMSY: [{ name: "Signature Flight Support", phone: "(504) 468-7722", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Crew Car", "Rental Car"] }],
            KCVG: [{ name: "Signature Flight Support", phone: "(859) 767-2360", fuel: [{ type: "100LL", service: "Full Serve" }, { type: "Jet-A", service: "Full Serve" }], hours: "24/7", services: ["GPU", "Crew Car", "Rental Car"] }],
            KUZA: [{ name: "Skytech, Inc.", phone: "(803) 366-5108", fuel: [{ type: "100LL", service: "Full Serve & Self-Serve (24/7)" }, { type: "Jet-A", service: "Full Serve" }], hours: "M–F 7am–8pm · Sa–Su 8am–7pm", services: ["FAA Repair Station", "Pilot Shop", "Crew Car", "Rental Car", "Tie-Down", "Volume Discounts"] }],
        };

        const AIRCRAFT = [
            { id: "c172", name: "Cessna 172 Skyhawk", cat: "SEL", kts: 120 },
            { id: "c182", name: "Cessna 182 Skylane", cat: "SEL", kts: 145 },
            { id: "pa28", name: "Piper Cherokee", cat: "SEL", kts: 128 },
            { id: "be36", name: "Bonanza A36", cat: "SEL", kts: 170 },
            { id: "sr22", name: "Cirrus SR22", cat: "SEL", kts: 180 },
            { id: "pa44", name: "Piper Seminole", cat: "MEL", kts: 163 },
            { id: "be58", name: "Baron 58", cat: "MEL", kts: 200 },
            { id: "tbm9", name: "TBM 960", cat: "SET", kts: 330 },
            { id: "pc12", name: "Pilatus PC-12", cat: "SET", kts: 280 },
            { id: "other", name: "Other", cat: "-", kts: 150 },
        ];

        // Returns airport from cache (sync). Trims whitespace before lookup.
        function getAirport(icao) {
            if (!icao) return null;
            icao = icao.trim().toUpperCase();
            return AIRPORTS[icao] || null;
        }

        // In-flight fetch guard to prevent duplicate API calls
        const _fetchingIcaos = new Set();

        // Fetch real airport data from Aviation Weather Center API and cache it.
        // Returns a promise that resolves with the airport object (or null on failure).
        async function fetchAirportInfo(icao) {
            if (!icao) return null;
            icao = icao.trim().toUpperCase();
            if (icao.length !== 4) return null;
            if (AIRPORTS[icao]) return AIRPORTS[icao];
            if (_fetchingIcaos.has(icao)) return null;
            _fetchingIcaos.add(icao);
            try {
                const res = await timeoutFetch(
                    `https://aviationweather.gov/api/data/airport?ids=${icao}&format=json`,
                    {}, 6000
                );
                if (!res.ok) return null;
                const data = await res.json();
                if (!data || data.length === 0) return null;
                const a = data[0];
                if (!a.lat || !a.lon) return null;
                const apt = {
                    name: a.name || icao + " Airport",
                    city: a.city || icao,
                    state: a.state || "US",
                    lat: parseFloat(a.lat),
                    lon: parseFloat(a.lon),
                    elev: parseInt(a.elev) || 0,
                    rwy: ["18/36", "09/27"],
                    artcc: "Center",
                    freq: { atis: "120.0", twr: "118.0", gnd: "121.9", app: "124.0", dep: "125.0", clnc: "121.5" }
                };
                AIRPORTS[icao] = apt;
                return apt;
            } catch(e) {
                return null;
            } finally {
                _fetchingIcaos.delete(icao);
            }
        }

        function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function randInt(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }

        function calcDist(lat1, lon1, lat2, lon2) {
            var R = 3440.065;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function calcBearing(lat1, lon1, lat2, lon2) {
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
            var x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) - Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
            return ((Math.atan2(y, x) * 180 / Math.PI) + 360) % 360;
        }

        function makeMetar(icao) {
            var apt = getAirport(icao);
            if (!apt) { return null; }
            var now = new Date();
            var dd = String(now.getUTCDate()).padStart(2, "0");
            var hh = String(now.getUTCHours()).padStart(2, "0");
            var mm = String(now.getUTCMinutes()).padStart(2, "0");
            var wdir = pick(["18", "24", "27", "33", "36", "09", "VRB"]);
            var wspd = randInt(4, 22);
            var gust = wspd > 12 ? "G" + (wspd + randInt(5, 12)) : "";
            var wind = wdir === "VRB" ? "VRB" + String(wspd).padStart(2, "0") + "KT" : wdir + "0" + String(wspd).padStart(2, "0") + gust + "KT";
            var vis = pick(["10SM", "10SM", "P6SM", "8SM", "6SM", "3SM", "1 1/2SM"]);
            var skyOptions = [
                { raw: "CLR", cat: "VFR" }, { raw: "FEW040", cat: "VFR" }, { raw: "FEW250", cat: "VFR" },
                { raw: "SCT025", cat: "MVFR" }, { raw: "SCT045 BKN120", cat: "MVFR" },
                { raw: "BKN015", cat: "MVFR" }, { raw: "BKN030", cat: "MVFR" },
                { raw: "OVC008", cat: "IFR" }, { raw: "OVC004", cat: "LIFR" }
            ];
            var sky = pick(skyOptions);
            var temp = randInt(5, 35);
            var dewp = temp - randInt(2, 10);
            var tempStr = (temp < 10 ? "0" : "") + temp + "/" + (dewp < 0 ? "M" : "") + (Math.abs(dewp) < 10 ? "0" : "") + Math.abs(dewp);
            var alt = "A" + pick(["2976", "2985", "2992", "2998", "3001", "3005", "3012"]);
            var cat = sky.cat;
            if (vis === "3SM" || vis === "1 1/2SM") { cat = "IFR"; }
            var wdirNum = wdir === "VRB" ? null : parseInt(wdir) * 10;
            return {
                raw: icao + " " + dd + hh + mm + "Z " + wind + " " + vis + " " + sky.raw + " " + tempStr + " " + alt + " RMK AO2",
                wind: wind, vis: vis, sky: sky.raw, temp: tempStr, alt: alt, cat: cat, wspd: wspd, wdir: wdirNum
            };
        }

        function makeTaf(icao) {
            var now = new Date();
            var dd = String(now.getUTCDate()).padStart(2, "0");
            var hh = String(now.getUTCHours()).padStart(2, "0");
            var h6 = String((parseInt(hh) + 6) % 24).padStart(2, "0");
            var h12 = String((parseInt(hh) + 12) % 24).padStart(2, "0");
            var h18 = String((parseInt(hh) + 18) % 24).padStart(2, "0");
            return "TAF " + icao + " " + dd + hh + "00Z 24012KT P6SM FEW040 SCT250 TEMPO 28015G22KT BKN030 FM" + h12 + "00 18008KT P6SM SCT060 BECMG " + h18 + "00 VRB05KT FEW250";
        }

        function makeNotams(icao) {
            var all = [
                { type: "RWY", severity: "warning", text: "!" + icao + " RWY 18L/36R CLSD MAINT 0600-1400Z" },
                { type: "OBST", severity: "tertiary", text: "!" + icao + " CRANE 450FT AGL 1.2NM NW LGTD" },
                { type: "TFR", severity: "error", text: "!" + icao + " TFR 3NM SFC-3000FT VIP" }
            ];
            return all.slice(0, 1 + randInt(0, 2));
        }

        function makePireps(dep, arr) {
            return [
                { type: "UA", text: "/OV " + dep + "-" + arr + "/FL085/TP C172/SK SCT045/TB LGT/RM SMOOTH ABV 060" },
                { type: "UA", text: "/OV " + dep + "090020/FL120/TP B738/TB MDT 080-120/IC LGT RIME" }
            ].slice(0, 1 + randInt(0, 1));
        }

        function makeForecast(icao) {
            var forecasts = [];
            var now = new Date();
            for (var i = 0; i < 7; i++) {
                var dt = new Date(now);
                dt.setDate(dt.getDate() + i);
                var seed = (icao.charCodeAt(1) + i * 7) % 10;
                var cat, hi, lo, ws, pr;
                if (seed <= 4) { cat = "VFR"; hi = randInt(65, 85); lo = hi - randInt(12, 20); ws = randInt(4, 12); pr = 0; }
                else if (seed <= 6) { cat = "MVFR"; hi = randInt(55, 75); lo = hi - randInt(10, 18); ws = randInt(8, 18); pr = randInt(10, 40); }
                else if (seed <= 8) { cat = "IFR"; hi = randInt(45, 65); lo = hi - randInt(8, 15); ws = randInt(12, 25); pr = randInt(50, 80); }
                else { cat = "LIFR"; hi = randInt(40, 60); lo = hi - randInt(5, 12); ws = randInt(5, 15); pr = randInt(60, 95); }
                forecasts.push({
                    dayName: dt.toLocaleDateString("en-US", { weekday: "short" }),
                    dateStr: dt.toLocaleDateString("en-US", { month: "short", day: "numeric" }),
                    cat: cat, hi: hi, lo: lo, ws: ws, pr: pr
                });
            }
            return forecasts;
        }

        function calcGoScore(dep, arr) {
            var dm = makeMetar(dep);
            var am = makeMetar(arr);
            if (!dm || !am) { return 50; }
            var catScores = { VFR: 95, MVFR: 65, IFR: 30, LIFR: 10 };
            var windPen = Math.max(0, (dm.wspd - 15) * 3) + Math.max(0, (am.wspd - 15) * 3);
            var score = Math.round((catScores[dm.cat] || 50) * 0.45 + (catScores[am.cat] || 50) * 0.45 - windPen + randInt(-5, 5));
            return Math.max(5, Math.min(99, score));
        }

        function getGoColor(s) { return s >= 75 ? "var(--md-sys-color-primary)" : s >= 50 ? "var(--md-sys-color-warning)" : "var(--md-sys-color-error)"; }

        // Cross-browser fetch with timeout — AbortSignal.timeout is not supported on older iOS Safari
        function timeoutFetch(url, opts, ms) {
            var ctrl = new AbortController();
            var id = setTimeout(function() { ctrl.abort(); }, ms || 8000);
            var merged = Object.assign({}, opts || {}, { signal: ctrl.signal });
            return fetch(url, merged).then(
                function(r)  { clearTimeout(id); return r; },
                function(e)  { clearTimeout(id); throw e; }
            );
        }

        // Derive VFR/MVFR/IFR/LIFR from raw ceiling array and visibility miles
        // Derive VFR/MVFR/IFR/LIFR from ceiling (feet, or null = clear) and visibility (statute miles)
        function deriveCat(ceilingFt, visMi) {
            var v = visMi != null ? visMi : 10;
            var c = ceilingFt; // null = no ceiling (SKC/CLR/FEW)
            if ((c !== null && c < 500)  || v < 1) return 'LIFR';
            if ((c !== null && c < 1000) || v < 3) return 'IFR';
            if ((c !== null && c < 3000) || v < 5) return 'MVFR';
            return 'VFR';
        }

        // Fetch live METAR via NWS api.weather.gov — proper CORS support, no API key needed.
        // aviationweather.gov omits Access-Control-Allow-Origin, making it unusable from browsers.
        async function fetchLiveMetar(icao) {
            if (!icao) return null;
            icao = icao.trim().toUpperCase();
            try {
                // NWS requires Accept header but NOT a custom User-Agent (that triggers CORS preflight failure)
                const res = await timeoutFetch(
                    `https://api.weather.gov/stations/${icao}/observations/latest`,
                    { headers: { 'Accept': 'application/geo+json' } },
                    10000
                );
                if (!res.ok) { console.warn('[METAR] NWS HTTP', res.status, icao); return null; }
                const data = await res.json();
                const p = data && data.properties;
                if (!p) return null;

                // Wind — NWS returns speed in km_h-1 or m_s-1 depending on version
                function nwsKts(ws) {
                    if (!ws || ws.value == null) return 0;
                    const u = ws.unitCode || '';
                    if (u.includes('km_h') || u.includes('kmh')) return Math.round(ws.value / 1.852);
                    if (u.includes('mi_h') || u.includes('mph')) return Math.round(ws.value * 0.868976);
                    return Math.round(ws.value * 1.944); // assume m/s
                }
                const wspd   = nwsKts(p.windSpeed);
                const wgst   = nwsKts(p.windGust);
                const wdirRaw = (p.windDirection && p.windDirection.value != null) ? Math.round(p.windDirection.value) : 0;
                const isVrb  = (wspd === 0 && wdirRaw === 0);
                const wdirStr = isVrb ? 'VRB' : String(wdirRaw).padStart(3, '0');
                const wind   = `${wdirStr}${String(wspd).padStart(2,'0')}${wgst > 0 ? 'G'+String(wgst).padStart(2,'0') : ''}KT`;

                // Visibility — NWS returns meters
                const visM  = (p.visibility && p.visibility.value != null) ? p.visibility.value : 16093;
                const visMi = visM / 1609.34;
                const visStr = visMi >= 6 ? 'P6SM' : `${Math.round(visMi)}SM`;

                // Cloud layers — base in meters, amount as SKC/CLR/FEW/SCT/BKN/OVC/VV
                const coverMap = { CLR:'CLR', SKC:'CLR', NSC:'CLR', CAVOK:'CLR',
                                   FEW:'FEW', SCT:'SCT', BKN:'BKN', OVC:'OVC', VV:'OVC' };
                const layers = Array.isArray(p.cloudLayers) ? p.cloudLayers : [];
                let skyStr = 'CLR', ceilingFt = null;
                if (layers.length > 0) {
                    const parts = layers.map(layer => {
                        const cover  = coverMap[layer.amount] || layer.amount || '';
                        const baseM  = (layer.base && layer.base.value != null) ? layer.base.value : null;
                        const baseFt = baseM != null ? Math.round(baseM * 3.281) : null;
                        if ((cover === 'BKN' || cover === 'OVC') && baseFt != null)
                            if (ceilingFt === null || baseFt < ceilingFt) ceilingFt = baseFt;
                        if (cover === 'CLR') return '';
                        return `${cover}${baseFt != null ? String(Math.round(baseFt/100)).padStart(3,'0') : ''}`;
                    }).filter(Boolean);
                    if (parts.length > 0) skyStr = parts.join(' ');
                }

                // Temperature / Dewpoint (Celsius)
                const tempC = (p.temperature && p.temperature.value != null) ? p.temperature.value : 15;
                const dewpC = (p.dewpoint  && p.dewpoint.value  != null) ? p.dewpoint.value  : 5;
                const tI = Math.round(tempC), dI = Math.round(dewpC);
                const tempStr = `${tI<0?'M':''}${Math.abs(tI)<10?'0':''}${Math.abs(tI)}/${dI<0?'M':''}${Math.abs(dI)<10?'0':''}${Math.abs(dI)}`;

                // Altimeter — NWS returns barometric pressure in Pascals
                const pressurePa = (p.barometricPressure && p.barometricPressure.value != null)
                    ? p.barometricPressure.value : 101325;
                const altStr = `A${String(Math.round(pressurePa / 3386.39 * 100)).padStart(4,'0')}`;

                return {
                    raw:  p.rawMessage || `${icao} METAR`,
                    wind, vis: visStr, sky: skyStr, temp: tempStr, alt: altStr,
                    cat:  deriveCat(ceilingFt, visMi),
                    wspd, wdir: (!isVrb && wdirRaw > 0) ? wdirRaw : null
                };
            } catch(e) { console.warn('[METAR] Exception for', icao, e); return null; }
        }

        // Fetch live TAF from Aviation Weather Center API
        // Returns full TAF object: { rawTAF, forecast: [{timeFrom, timeTo, wdir, wspd, wgst, visib, skyCondition[]}] }
        async function fetchLiveTaf(icao) {
            if (!icao) return null;
            icao = icao.trim().toUpperCase();
            async function fetchTafById(id) {
                try {
                    const res = await timeoutFetch(
                        `https://aviationweather.gov/api/data/taf?ids=${id}&format=json`,
                        {}, 8000
                    );
                    if (!res.ok) return null;
                    const data = await res.json();
                    if (!Array.isArray(data) || data.length === 0) return null;
                    var obj = data[0];
                    return (obj && (obj.forecast || obj.rawTAF)) ? obj : null;
                } catch(e) { return null; }
            }
            // Try the exact station first
            var taf = await fetchTafById(icao);
            if (taf) return taf;
            // No TAF for this station (common for small GA airports like KUZA).
            // Use the explicit tafRef from the airport record when present — this is
            // the same approach ForeFlight uses (e.g. it shows "KCLT TAF 14 nm NE"
            // for KUZA because KCLT is the nearest TAF-issuing station).
            var apt = getAirport(icao);
            if (apt && apt.tafRef) {
                var refTaf = await fetchTafById(apt.tafRef);
                if (refTaf) return { ...refTaf, _nearbyStation: refTaf.stationId };
            }
            // Last resort: check the nearest airport in the static AIRPORTS dict
            // that differs from the queried ICAO and lies within ~25 nm.
            if (apt) {
                var nearby = Object.entries(AIRPORTS)
                    .filter(([id]) => id !== icao)
                    .map(([id, a]) => ({ id, d: Math.hypot(a.lat - apt.lat, a.lon - apt.lon) }))
                    .sort((a, b) => a.d - b.d)
                    .slice(0, 3); // only try the 3 nearest to avoid excess API calls
                for (var nb of nearby) {
                    if (nb.d > 0.5) break; // > ~30 nm — not useful
                    var nbTaf = await fetchTafById(nb.id);
                    if (nbTaf) return { ...nbTaf, _nearbyStation: nbTaf.stationId };
                }
            }
            return null;
        }

        // Fetch GFS MOS data from Aviation Weather Center (extended forecast, up to ~72h)
        // Returns full MOS object with data[] array of 6-hourly forecast periods
        async function fetchLiveMos(icao) {
            if (!icao) return null;
            icao = icao.trim().toUpperCase();
            try {
                const res = await timeoutFetch(
                    `https://aviationweather.gov/api/data/mos?ids=${icao}&format=json`,
                    {}, 10000
                );
                if (!res.ok) return null;
                const data = await res.json();
                if (!Array.isArray(data) || data.length === 0) return null;
                return data[0];  // { stationId, model, runtime, data: [...] }
            } catch(e) { return null; }
        }

        // Fetch 7-day forecast from NWS API for a lat/lon
        async function fetchNwsForecast(lat, lon) {
            if (lat == null || lon == null) return null;
            try {
                const pointsRes = await timeoutFetch(
                    `https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`,
                    { headers: { "Accept": "application/geo+json" } }, 8000
                );
                if (!pointsRes.ok) return null;
                const pointsData = await pointsRes.json();
                const forecastUrl = pointsData?.properties?.forecast;
                if (!forecastUrl) return null;
                const forecastRes = await timeoutFetch(forecastUrl, { headers: { "Accept": "application/geo+json" } }, 8000);
                if (!forecastRes.ok) return null;
                const forecastData = await forecastRes.json();
                const periods = forecastData?.properties?.periods;
                if (!periods || periods.length === 0) return null;
                var days = [];
                for (var i = 0; i < periods.length && days.length < 7; i++) {
                    var p = periods[i];
                    if (p.isDaytime) {
                        var dt = new Date(p.startTime);
                        var cat = "VFR";
                        var name = (p.shortForecast || "").toLowerCase();
                        if (name.includes("fog") || name.includes("freezing")) cat = "LIFR";
                        else if (name.includes("rain") || name.includes("snow") || name.includes("storm") || name.includes("shower")) cat = "IFR";
                        else if (name.includes("cloud") || name.includes("overcast") || name.includes("drizzle")) cat = "MVFR";
                        days.push({
                            dayName: dt.toLocaleDateString("en-US", { weekday: "short" }),
                            dateStr: dt.toLocaleDateString("en-US", { month: "short", day: "numeric" }),
                            cat, hi: p.temperature,
                            lo: periods[i + 1]?.temperature || (p.temperature - 15),
                            ws: parseInt(p.windSpeed) || 0, pr: 0
                        });
                    }
                }
                return days.length > 0 ? days : null;
            } catch(e) { return null; }
        }

        // Calculate Go/No-Go score from live METAR objects
        function calcGoScoreFromMetars(depMetar, arrMetar) {
            if (!depMetar || !arrMetar) return 50;
            var catScores = { VFR: 95, MVFR: 65, IFR: 30, LIFR: 10 };
            var windPen = Math.max(0, (depMetar.wspd - 15) * 3) + Math.max(0, (arrMetar.wspd - 15) * 3);
            var score = Math.round(
                (catScores[depMetar.cat] || 50) * 0.45 +
                (catScores[arrMetar.cat] || 50) * 0.45 - windPen
            );
            return Math.max(5, Math.min(99, score));
        }

        /* =========================================
           TRIP-TIME WEATHER HELPERS
        ========================================= */

        // Rough UTC offset (hours) from airport longitude — US-focused
        // ── Composite Safety Score (0-100) with per-factor breakdown ────────────
        function calcDetailedScore(effectiveWxData, routeDist) {
            if (!effectiveWxData || effectiveWxData.length === 0) return { total: 50, breakdown: [] };
            function parseT(ts) {
                if (!ts) return null;
                var m = ts.match(/^(M?)(\d+)\//);
                return m ? (m[1] === 'M' ? -parseInt(m[2]) : parseInt(m[2])) : null;
            }
            var breakdown = [];

            // 1. Flight category (0-25 pts)
            var catRank = { VFR: 0, MVFR: 1, IFR: 2, LIFR: 3 };
            var worstCat = effectiveWxData.reduce(function(w, e) {
                if (!e.effectiveWx) return w;
                return (catRank[e.effectiveWx.cat] || 0) > (catRank[w] || 0) ? e.effectiveWx.cat : w;
            }, 'VFR');
            var catPts = { VFR: 25, MVFR: 16, IFR: 7, LIFR: 0 }[worstCat] || 25;
            var catCol = { VFR: 'var(--cat-vfr-color)', MVFR: 'var(--cat-mvfr-color)', IFR: 'var(--cat-ifr-color)', LIFR: 'var(--cat-lifr-color)' }[worstCat] || 'var(--cat-vfr-color)';
            breakdown.push({ label: 'Flight Category', score: catPts, max: 25, icon: 'cloud', color: catCol, detail: 'Worst case: ' + worstCat });

            // 2. Visibility (0-20 pts)
            // vis strings can be "10SM", "P6SM" (>6SM), "1 1/2SM", etc.
            function parseVisSM(s) {
                if (!s) return NaN;
                if (/^P/i.test(s)) return 10; // "P6SM" = "plus 6 SM" → treat as 10
                var m = s.match(/([\d.]+)\s*(?:\/\s*([\d.]+))?\s*SM/i);
                if (!m) return NaN;
                return m[2] ? parseInt(m[1]) / parseInt(m[2]) : parseFloat(m[1]);
            }
            var minVis = Infinity;
            effectiveWxData.forEach(function(e) {
                if (!e.effectiveWx) return;
                var v = parseVisSM(e.effectiveWx.vis);
                if (!isNaN(v)) minVis = Math.min(minVis, v);
            });
            var visPts = minVis === Infinity ? 20 : minVis >= 10 ? 20 : minVis >= 5 ? 16 : minVis >= 3 ? 10 : minVis >= 1 ? 4 : 0;
            var visCol = visPts >= 16 ? 'var(--cat-vfr-color)' : visPts >= 10 ? 'var(--cat-mvfr-color)' : 'var(--cat-ifr-color)';
            breakdown.push({ label: 'Visibility', score: visPts, max: 20, icon: 'visibility', color: visCol, detail: minVis === Infinity ? 'No data' : (minVis.toFixed(1) + ' SM') });

            // 3. Wind & gusts (0-20 pts)
            var maxWind = 0;
            effectiveWxData.forEach(function(e) {
                if (!e.effectiveWx) return;
                var ws = e.effectiveWx.wind || '';
                var wm = ws.match(/(\d{2,3})KT/); if (wm) maxWind = Math.max(maxWind, parseInt(wm[1]));
                var gm = ws.match(/G(\d+)KT/); if (gm) maxWind = Math.max(maxWind, parseInt(gm[1]));
            });
            var windPts = maxWind <= 10 ? 20 : maxWind <= 15 ? 17 : maxWind <= 20 ? 12 : maxWind <= 25 ? 6 : 0;
            var windCol = windPts >= 17 ? 'var(--cat-vfr-color)' : windPts >= 12 ? 'var(--cat-mvfr-color)' : 'var(--cat-ifr-color)';
            breakdown.push({ label: 'Winds / Gusts', score: windPts, max: 20, icon: 'air', color: windCol, detail: maxWind > 0 ? ('Max ' + maxWind + ' kts') : 'Calm' });

            // 4. Route length complexity (0-15 pts)
            var rd = routeDist || 0;
            var rtPts = rd <= 50 ? 15 : rd <= 150 ? 13 : rd <= 300 ? 10 : rd <= 500 ? 7 : 4;
            var rtCol = rtPts >= 13 ? 'var(--cat-vfr-color)' : rtPts >= 10 ? 'var(--cat-mvfr-color)' : 'var(--md-sys-color-warning)';
            breakdown.push({ label: 'Route Length', score: rtPts, max: 15, icon: 'route', color: rtCol, detail: rd + ' NM total' });

            // 5. Data confidence (0-10 pts)
            var noLive = effectiveWxData.some(function(e) { return !e.metarLive; });
            var isMos  = effectiveWxData.some(function(e) { return e.source === 'mos'; });
            var isTaf  = effectiveWxData.some(function(e) { return e.source === 'taf'; });
            var confPts = noLive ? 4 : isMos ? 5 : isTaf ? 8 : 10;
            var confCol = confPts >= 8 ? 'var(--cat-vfr-color)' : confPts >= 5 ? 'var(--cat-mvfr-color)' : 'var(--cat-ifr-color)';
            var confTxt = noLive ? 'Simulated stations present' : isMos ? 'GFS model (72h+ horizon)' : isTaf ? 'TAF forecast' : 'Live METAR';
            breakdown.push({ label: 'Data Quality', score: confPts, max: 10, icon: 'verified', color: confCol, detail: confTxt });

            // 6. Icing / freezing risk (0-10 pts)
            var icingRisk = 0;
            effectiveWxData.forEach(function(e) {
                if (!e.effectiveWx) return;
                var tc = parseT(e.effectiveWx.temp);
                if (tc !== null && tc <= 2 && tc >= -22) icingRisk = Math.max(icingRisk, 2);
                else if (e.effectiveWx.sky && /FZRA|FZDZ|SN|RASN/.test(e.effectiveWx.sky)) icingRisk = Math.max(icingRisk, 1);
            });
            var icPts = icingRisk === 0 ? 10 : icingRisk === 1 ? 6 : 2;
            var icCol = icPts === 10 ? 'var(--cat-vfr-color)' : icPts === 6 ? 'var(--cat-mvfr-color)' : 'var(--cat-ifr-color)';
            var icTxt = icingRisk === 0 ? 'No indicators' : icingRisk === 1 ? 'Precip type — check PIREPs' : 'Near-freezing temps + moisture';
            breakdown.push({ label: 'Icing Risk', score: icPts, max: 10, icon: 'ac_unit', color: icCol, detail: icTxt });

            var total = Math.round(Math.min(100, breakdown.reduce(function(s, f) { return s + f.score; }, 0)));
            return { total: total, breakdown: breakdown };
        }

        // ── Live PIREPs from AviationWeather.gov ─────────────────────────────────
        async function fetchLivePireps(lat, lon, radiusNm) {
            try {
                var url = 'https://aviationweather.gov/api/data/pirep?format=json&distance=' + (radiusNm || 150) + '&lat=' + lat.toFixed(3) + '&lon=' + lon.toFixed(3) + '&age=3';
                var res = await timeoutFetch(url, {}, 8000);
                if (!res.ok) return null;
                var data = await res.json();
                return Array.isArray(data) ? data : null;
            } catch(e) { return null; }
        }

        // ── SIGMETs (airsigmet) ──────────────────────────────────────────────────
        async function fetchSigmets() {
            try {
                var res = await timeoutFetch('https://aviationweather.gov/api/data/airsigmet?format=json', {}, 10000);
                if (!res.ok) return [];
                var data = await res.json();
                // Returns GeoJSON FeatureCollection
                return (data && data.features) ? data.features : [];
            } catch(e) { return []; }
        }

        // ── G-AIRMETs ────────────────────────────────────────────────────────────
        async function fetchGairmets() {
            try {
                var res = await timeoutFetch('https://aviationweather.gov/api/data/gairmet?format=json', {}, 10000);
                if (!res.ok) return [];
                var data = await res.json();
                return Array.isArray(data) ? data : [];
            } catch(e) { return []; }
        }

        // ── Center Weather Advisories ────────────────────────────────────────────
        async function fetchCwas() {
            try {
                var res = await timeoutFetch('https://aviationweather.gov/api/data/cwa?format=json', {}, 10000);
                if (!res.ok) return [];
                var data = await res.json();
                return Array.isArray(data) ? data : [];
            } catch(e) { return []; }
        }

        // ── Winds & Temperatures Aloft ───────────────────────────────────────────
        async function fetchWindsAloft(region) {
            try {
                var url = 'https://aviationweather.gov/api/data/windtemp?format=json&region=' + (region||'us') + '&level=low&fcst=06';
                var res = await timeoutFetch(url, {}, 10000);
                if (!res.ok) return [];
                var data = await res.json();
                return Array.isArray(data) ? data : [];
            } catch(e) { return []; }
        }

        // ── Geographic helpers for route corridor filtering ───────────────────────
        // Build a bounding box from route airport coordinates + padding degrees
        function routeBboxFromPts(aptPts, padDeg) {
            var pad = padDeg || 3;
            var lats = aptPts.map(function(a) { return a.lat; });
            var lons = aptPts.map(function(a) { return a.lon; });
            return { minLat: Math.min.apply(null,lats)-pad, maxLat: Math.max.apply(null,lats)+pad,
                     minLon: Math.min.apply(null,lons)-pad, maxLon: Math.max.apply(null,lons)+pad };
        }
        function ptInBbox(lat, lon, bb) {
            return lat >= bb.minLat && lat <= bb.maxLat && lon >= bb.minLon && lon <= bb.maxLon;
        }
        // GeoJSON coords: [[lon,lat],...]  (outer ring = coords[0])
        function geojsonPolyInBbox(coords, bb) {
            var ring = (coords && coords[0]) ? coords[0] : coords;
            if (!ring) return false;
            return ring.some(function(pt) { return ptInBbox(pt[1], pt[0], bb); });
        }
        // G-AIRMET area: [{lat,lon},...]
        function latLonPolyInBbox(area, bb) {
            if (!Array.isArray(area)) return false;
            return area.some(function(pt) { return ptInBbox(pt.lat, pt.lon, bb); });
        }
        // CWA polygon: "lat,lon lat,lon ..." string
        function cwaPolyInBbox(polyStr, bb) {
            if (!polyStr) return false;
            return polyStr.trim().split(/\s+/).some(function(pair) {
                var parts = pair.split(',');
                if (parts.length < 2) return false;
                return ptInBbox(parseFloat(parts[0]), parseFloat(parts[1]), bb);
            });
        }

        // ── Wind station helpers ─────────────────────────────────────────────────
        function closestWindStation(stations, lat, lon) {
            var best = null, bestD = Infinity;
            stations.forEach(function(s) {
                if (s.lat == null || s.lon == null) return;
                var d = (s.lat-lat)*(s.lat-lat) + (s.lon-lon)*(s.lon-lon);
                if (d < bestD) { bestD = d; best = s; }
            });
            return best;
        }
        // Return wind data at (or nearest to) altFt from a windtemp station record
        function getWindAtAlt(stn, altFt) {
            if (!stn) return null;
            var levels = [3,6,9,12,18,24,30,34,39]; // thousands of feet
            var altK = altFt / 1000;
            var closest = levels.reduce(function(prev, cur) { return Math.abs(cur-altK) < Math.abs(prev-altK) ? cur : prev; });
            var wdir = stn['wdir'+closest], wspd = stn['wspd'+closest], temp = stn['temp'+closest];
            if (wdir == null) return null;
            var lv = wdir === 990 || wdir === '990';
            return { altFt: closest*1000, wdir: lv ? 'LV' : String(wdir).padStart(3,'0'), wspd: wspd || 0, temp: temp != null ? temp : null, lv: lv };
        }
        // Map route longitude to the best windtemp region string
        function windRegionForLon(lon) {
            if (lon > -67) return 'bos';    // New England
            if (lon > -82) return 'mia';    // SE / Florida
            if (lon > -96) return 'chi';    // NC / Great Lakes
            if (lon > -104) return 'dfw';   // SC / Texas
            if (lon > -112) return 'slc';   // Rockies
            return 'sfo';                    // Pacific Coast
        }

        function estimateUtcOffsetHours(lon) {
            if (!lon) return -5;
            // Approximate US timezone longitude boundaries
            // Eastern/Central divide is ~87°W; Central/Mountain ~102°W; Mountain/Pacific ~115°W
            if (lon > -87)  return -5;   // Eastern (SC, NC, FL, GA, NY, etc.)
            if (lon > -102) return -6;   // Central
            if (lon > -115) return -7;   // Mountain
            return -8;                    // Pacific
        }

        // Convert trip local date+time to a UTC Date object.
        // The stored time is LOCAL time at the departure airport.
        // Date.UTC() avoids browser-timezone double-counting:
        //   new Date(y,m,d,h,min) shifts by the *browser* TZ; subtracting the
        //   airport offset on top would then double-count the offset.
        function getTripTargetUtc(trip, depLon) {
            if (!trip || !trip.date || !trip.time) return null;
            var offset = estimateUtcOffsetHours(depLon);
            var parts  = trip.date.split('-').map(Number);
            var tparts = trip.time.split(':').map(Number);
            // Treat the stored time as airport-local by first anchoring it to UTC
            // via Date.UTC, then shifting by the airport's UTC offset.
            var localAsUtcMs = Date.UTC(parts[0], parts[1] - 1, parts[2], tparts[0], tparts[1], 0);
            return new Date(localAsUtcMs - offset * 3600000);
        }

        // Build a METAR-like weather object from a structured TAF forecast period
        function parseTafPeriod(fp, icao) {
            if (!fp) return null;
            var wspd = fp.wspd || 0, wdir = fp.wdir || 0, wgst = fp.wgst || 0;
            var wdirStr = wdir === 0 ? "VRB" : String(wdir).padStart(3, "0");
            var wind = `${wdirStr}${String(wspd).padStart(2,"0")}${wgst > 0 ? "G" + String(wgst).padStart(2,"0") : ""}KT`;
            // AWC returns visib as a string like "6+", "3", "1/2" — parseFloat handles
            // all of these: "6+" → 6, "3" → 3, "1/2" → 0.5.  Numeric values pass through.
            var visib = fp.visib != null ? parseFloat(fp.visib) : 6;
            if (isNaN(visib)) visib = 6;
            var vis = visib >= 6 ? "P6SM" : `${visib}SM`;
            var skyArr = fp.skyCondition || [];
            var skyStr = skyArr.length > 0
                ? skyArr.map(s => `${s.skyCover}${s.cloudBase != null ? String(Math.round(s.cloudBase / 100)).padStart(3,"0") : ""}`).join(" ")
                : "CLR";
            // Ceiling and flight category
            var ceiling = null;
            skyArr.forEach(s => {
                if ((s.skyCover === 'BKN' || s.skyCover === 'OVC') && s.cloudBase != null)
                    if (ceiling === null || s.cloudBase < ceiling) ceiling = s.cloudBase;
            });
            var visMi = visib >= 6 ? 10 : visib;
            var cat = 'VFR';
            if ((ceiling !== null && ceiling < 500) || visMi < 1) cat = 'LIFR';
            else if ((ceiling !== null && ceiling < 1000) || visMi < 3) cat = 'IFR';
            else if ((ceiling !== null && ceiling < 3000) || visMi < 5) cat = 'MVFR';
            return { raw: `TAF ${icao || ''}`, wind, vis, sky: skyStr, cat, wspd };
        }

        // Convert AWC TAF time field to Unix seconds.
        // AWC returns timeFrom/timeTo as ISO-8601 strings ("2026-03-02T09:00:00Z") even
        // though the old ADDS API used integer seconds.  Comparing an ISO string directly
        // against a numeric Unix timestamp gives NaN (always false), so we must coerce.
        function tafTs(t) {
            if (t == null) return null;
            if (typeof t === 'number') return t;
            var d = new Date(t);
            return isNaN(d.getTime()) ? null : d.getTime() / 1000;
        }

        // Find the TAF period that covers a target UTC date, return weather object.
        // Step 1: find the base FM period whose window contains targetTs.
        // Step 2: if a TEMPO is active at targetTs and is worse, use that instead.
        function parseTafForTime(tafObj, targetUtc) {
            if (!tafObj || !tafObj.forecast || !tafObj.forecast.length) return null;
            var targetTs = targetUtc.getTime() / 1000;
            var periods = tafObj.forecast;
            var catRank = { VFR: 0, MVFR: 1, IFR: 2, LIFR: 3 };

            // Step 1: last FM/base period whose start ≤ targetTs (these set the persistent fcst)
            var base = null;
            for (var p of periods) {
                var ci = (p.changeIndicator || '').toUpperCase();
                if (ci === 'TEMPO' || ci === 'PROB30' || ci === 'PROB40') continue;
                var ft = tafTs(p.timeFrom);
                if (ft !== null && ft <= targetTs) base = p;
            }
            if (!base) base = periods[0];

            // Step 2: apply any active TEMPO that is worse than the base (conservative go/no-go)
            var active = base;
            for (var p of periods) {
                if ((p.changeIndicator || '').toUpperCase() !== 'TEMPO') continue;
                var ft = tafTs(p.timeFrom), tt = tafTs(p.timeTo);
                if (ft == null || tt == null) continue;
                if (ft <= targetTs && targetTs < tt) {
                    var tempoCat  = (parseTafPeriod(p,    tafObj.stationId || '') || {}).cat || 'VFR';
                    var activeCat = (parseTafPeriod(active, tafObj.stationId || '') || {}).cat || 'VFR';
                    if ((catRank[tempoCat] || 0) > (catRank[activeCat] || 0)) active = p;
                }
            }
            return parseTafPeriod(active, tafObj.stationId || "");
        }

        /* ------ GFS MOS helpers ------ */

        // NWS MOS ceiling category → representative height in feet
        // Categories: 1=<200 2=200-399 3=400-899 4=900-1999 5=2000-3099 6=3100-6599 7=6600+ 8=CLR
        function mosCigFt(cat) {
            var map = { 1: 100, 2: 300, 3: 650, 4: 1400, 5: 2500, 6: 4800, 7: 8000, 8: null };
            return (cat != null && map[cat] !== undefined) ? map[cat] : null;
        }

        // NWS MOS visibility category → representative miles
        // Categories: 1=<0.25 2=0.25-0.49 3=0.5-0.99 4=1-1.99 5=2-2.99 6=3-3.99 7=4-4.99 8=5-5.99 9=6+
        function mosVisMi(cat) {
            var map = { 1: 0.1, 2: 0.35, 3: 0.75, 4: 1.5, 5: 2.5, 6: 3.5, 7: 4.5, 8: 5.5, 9: 7 };
            return (cat != null && map[cat] !== undefined) ? map[cat] : 7;
        }

        // Derive standard flight category from MOS ceiling + visibility categories
        function mosToCat(cigCat, visCat) {
            var cft = mosCigFt(cigCat);
            var vmi = mosVisMi(visCat);
            var cRank = cft === null ? 0 : cft < 500 ? 3 : cft < 1000 ? 2 : cft < 3000 ? 1 : 0;
            var vRank = vmi < 1 ? 3 : vmi < 3 ? 2 : vmi < 5 ? 1 : 0;
            return ['VFR', 'MVFR', 'IFR', 'LIFR'][Math.max(cRank, vRank)];
        }

        // Build a METAR-like weather object from a single MOS forecast period
        function buildMosWx(period, icao) {
            if (!period) return null;
            var wspd = period.wspd || 0, wdir = period.wdir || 0, wgst = period.wgst || 0;
            var wdirStr = wdir === 0 ? "VRB" : String(wdir).padStart(3, "0");
            var wind = `${wdirStr}${String(wspd).padStart(2,"0")}${wgst > 0 ? "G" + String(wgst).padStart(2,"0") : ""}KT`;
            // Ceiling and visibility — prefer named fields, fall back to alternates
            var cigCat = period.cigs ?? period.cig ?? 8;
            var visCat = period.vsby ?? period.vis ?? 9;
            var cft = mosCigFt(cigCat);
            var vmi = mosVisMi(visCat);
            var sky = cft !== null ? `BKN${String(Math.round(cft / 100)).padStart(3, "0")}` : "CLR";
            var vis = vmi >= 6 ? "P6SM" : `${vmi}SM`;
            var cat = mosToCat(cigCat, visCat);
            return {
                raw: `GFS MOS ${icao}`,
                wind, vis, sky, cat, wspd,
                t06: period.t06 ?? period.t12 ?? 0,   // thunderstorm probability %
                p06: period.p06 ?? period.p12 ?? 0,   // precipitation probability %
                obv: period.obv || 'N',                // obstruction: N,F,PF,HZ,K,BS,BD
                mosRuntime: period._runtime || null,
            };
        }

        // Fetch and resolve weather for a trip at its departure time.
        // Returns effectiveWxData array compatible with calcDetailedScore:
        //   TAF  — used when departure is 2–30 h away
        //   MOS  — used when departure is >30 h away
        //   METAR — used for current/past departures or as fallback
        async function fetchEffectiveWxForTrip(trip, allPts) {
            var depApt = getAirport(trip.dep);
            var depLon = depApt ? depApt.lon : -80;
            var targetUtc = getTripTargetUtc(trip, depLon);
            var hoursUntil = targetUtc ? (targetUtc.getTime() - Date.now()) / 3600000 : null;

            if (hoursUntil !== null && hoursUntil > 30) {
                // Extended range — GFS MOS + METAR fallback
                var [metarArr, mosArr] = await Promise.all([
                    Promise.all(allPts.map(icao => fetchLiveMetar(icao).catch(() => null))),
                    Promise.all(allPts.map(icao => fetchLiveMos(icao).catch(() => null)))
                ]);
                return allPts.map((icao, idx) => {
                    var m = metarArr[idx], mosObj = mosArr[idx];
                    var metarLive = !!m, metar = m || makeMetar(icao);
                    if (mosObj) {
                        var mosPeriod = parseMosForTime(mosObj, targetUtc);
                        if (mosPeriod) {
                            var mosWx = buildMosWx(mosPeriod, icao);
                            if (mosWx) return { icao, effectiveWx: mosWx, metarLive, source: 'mos', sourceLabel: 'GFS Fcst' };
                        }
                    }
                    return { icao, effectiveWx: metar, metarLive, source: 'metar', sourceLabel: metarLive ? 'METAR (no model)' : 'No data' };
                }).filter(e => e.effectiveWx);

            } else if (hoursUntil !== null && hoursUntil > 2) {
                // Near-future — TAF preferred, MOS fallback, then METAR
                var [metarArr, tafArr, mosArr] = await Promise.all([
                    Promise.all(allPts.map(icao => fetchLiveMetar(icao).catch(() => null))),
                    Promise.all(allPts.map(icao => fetchLiveTaf(icao).catch(() => null))),
                    Promise.all(allPts.map(icao => fetchLiveMos(icao).catch(() => null)))
                ]);
                return allPts.map((icao, idx) => {
                    var m = metarArr[idx], taf = tafArr[idx], mosObj = mosArr[idx];
                    var metarLive = !!m, metar = m || makeMetar(icao);
                    if (taf) {
                        var tafWx = parseTafForTime(taf, targetUtc);
                        if (tafWx) {
                            var lbl = taf._nearbyStation ? `TAF ${taf._nearbyStation}` : 'TAF';
                            return { icao, effectiveWx: tafWx, metarLive, source: 'taf', sourceLabel: lbl };
                        }
                    }
                    // No TAF (small airport) — try GFS MOS before falling back to live METAR
                    if (mosObj) {
                        var mosPeriod = parseMosForTime(mosObj, targetUtc);
                        if (mosPeriod) {
                            var mosWx = buildMosWx(mosPeriod, icao);
                            if (mosWx) return { icao, effectiveWx: mosWx, metarLive, source: 'mos', sourceLabel: 'GFS Fcst' };
                        }
                    }
                    return { icao, effectiveWx: metar, metarLive, source: 'metar', sourceLabel: metarLive ? 'METAR (no fcst)' : 'No data' };
                }).filter(e => e.effectiveWx);

            } else {
                // Current/past departure — live METAR only
                var metarArr = await Promise.all(allPts.map(icao => fetchLiveMetar(icao).catch(() => null)));
                return allPts.map((icao, idx) => ({
                    icao, effectiveWx: metarArr[idx] || null,
                    metarLive: !!metarArr[idx], source: 'metar',
                    sourceLabel: metarArr[idx] ? 'Live METAR' : 'No data'
                })).filter(e => e.effectiveWx);
            }
        }

        // Find the MOS period whose valid time is closest to targetUtc
        // Handles both array format (data:[{ftime,...}]) and keyed-object format
        function parseMosForTime(mosData, targetUtc) {
            if (!mosData) return null;
            var targetTs = targetUtc.getTime() / 1000;
            var periods = [];
            var rt = mosData.runtime || mosData.cycleTime || null;
            if (Array.isArray(mosData.data)) {
                periods = mosData.data.map(p => ({ ...p, _runtime: rt }));
            } else if (mosData.data && typeof mosData.data === 'object') {
                periods = Object.entries(mosData.data).map(([k, v]) => ({ ...v, ftime: k, _runtime: rt }));
            } else if (mosData.wspd !== undefined || mosData.wdir !== undefined) {
                // mosData is the period directly
                return buildMosWx(mosData, '');
            }
            if (!periods.length) return null;
            var closest = null, minDiff = Infinity;
            for (var p of periods) {
                var t = p.ftime || p.validTime || p.utcTime;
                if (!t) continue;
                var diff = Math.abs(new Date(t).getTime() / 1000 - targetTs);
                if (diff < minDiff) { minDiff = diff; closest = p; }
            }
            return closest ? buildMosWx(closest, '') : null;
        }

        /* =========================================
           MATERIAL DESIGN 3 REACT COMPONENTS
        ========================================= */

        const MdIcon = ({ name, style, className = '' }) => (
            <span className={`material-symbols-outlined ${className}`} style={style}>{name}</span>
        );

        const MdButton = ({ onClick, variant = 'primary', icon, children, disabled, style = {} }) => {
            const baseStyle = {
                display: 'inline-flex', alignItems: 'center', justifyContent: 'center', gap: '8px',
                padding: '10px 24px', borderRadius: '9999px', fontSize: '14px', fontWeight: '500',
                border: 'none', cursor: disabled ? 'not-allowed' : 'pointer',
                fontFamily: 'inherit', letterSpacing: '0.1px',
                opacity: disabled ? 0.5 : 1, ...style
            };

            const variants = {
                primary: {
                    background: 'var(--md-sys-color-primary)',
                    color: 'var(--md-sys-color-on-primary)'
                },
                tonal: {
                    background: 'var(--md-sys-color-secondary-container)',
                    color: 'var(--md-sys-color-on-secondary-container)'
                },
                text: {
                    background: 'transparent',
                    color: 'var(--md-sys-color-primary)',
                    padding: '10px 16px'
                },
                sparkle: {
                    background: 'linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary))',
                    color: 'var(--md-sys-color-on-primary)',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
                }
            };

            return (
                <button 
                    onClick={onClick} 
                    disabled={disabled}
                    style={{ ...baseStyle, ...variants[variant] }}
                    onMouseOver={(e) => { if (!disabled) e.currentTarget.style.filter = 'brightness(0.9)'; }}
                    onMouseOut={(e) => { if (!disabled) e.currentTarget.style.filter = 'none'; }}
                >
                    {icon && <MdIcon name={icon} style={{ fontSize: '18px' }} />}
                    {children}
                </button>
            );
        };

        const MdCard = ({ children, style = {}, onClick }) => {
            return (
                <div 
                    onClick={onClick}
                    style={{
                        background: 'var(--md-sys-color-surface-container)',
                        borderRadius: '16px',
                        padding: '16px',
                        color: 'var(--md-sys-color-on-surface)',
                        cursor: onClick ? 'pointer' : 'default',
                        transition: 'background 0.2s',
                        ...style
                    }}
                    onMouseOver={(e) => { if (onClick) e.currentTarget.style.background = 'var(--md-sys-color-surface-container-high)'; }}
                    onMouseOut={(e) => { if (onClick) e.currentTarget.style.background = 'var(--md-sys-color-surface-container)'; }}
                >
                    {children}
                </div>
            );
        };

        const MdInput = ({ label, value, onChange, type = "text", placeholder, maxLength, containerStyle = {} }) => {
            return (
                <div style={{ display: "flex", flexDirection: "column", gap: "4px", minWidth: 0, ...containerStyle }}>
                    {label && <label style={{ fontSize: "12px", fontWeight: "500", color: "var(--md-sys-color-on-surface-variant)" }}>{label}</label>}
                    <input 
                        type={type} value={value} onChange={onChange} placeholder={placeholder} maxLength={maxLength}
                        style={{
                            background: "var(--md-sys-color-surface-variant)",
                            border: "none",
                            borderBottom: "2px solid var(--md-sys-color-outline)",
                            borderRadius: "4px 4px 0 0",
                            padding: "12px 16px",
                            color: "var(--md-sys-color-on-surface)",
                            fontFamily: "inherit", fontSize: "16px", outline: "none",
                            width: "100%", boxSizing: "border-box"
                        }}
                        onFocus={(e) => e.target.style.borderBottomColor = "var(--md-sys-color-primary)"}
                        onBlur={(e) => e.target.style.borderBottomColor = "var(--md-sys-color-outline)"}
                    />
                </div>
            );
        };

        const MdSelect = ({ label, value, onChange, options, containerStyle = {} }) => {
            return (
                <div style={{ display: "flex", flexDirection: "column", gap: "4px", minWidth: 0, ...containerStyle }}>
                    {label && <label style={{ fontSize: "12px", fontWeight: "500", color: "var(--md-sys-color-on-surface-variant)" }}>{label}</label>}
                    <select 
                        value={value} onChange={onChange}
                        style={{
                            background: "var(--md-sys-color-surface-variant)",
                            border: "none", borderBottom: "2px solid var(--md-sys-color-outline)",
                            borderRadius: "4px 4px 0 0", padding: "12px 16px",
                            color: "var(--md-sys-color-on-surface)",
                            fontFamily: "inherit", fontSize: "16px", outline: "none",
                            width: "100%", boxSizing: "border-box"
                        }}
                        onFocus={(e) => e.target.style.borderBottomColor = "var(--md-sys-color-primary)"}
                        onBlur={(e) => e.target.style.borderBottomColor = "var(--md-sys-color-outline)"}
                    >
                        {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                    </select>
                </div>
            );
        };

        /* =========================================
           VOICE INPUT BUTTON (Web Speech API)
        ========================================= */
        function VoiceInputButton({ onResult, style }) {
            var [listening, setListening] = useState(false);
            var canListen = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
            if (!canListen) return null;
            var PHONETIC = { ALPHA:'A',BRAVO:'B',CHARLIE:'C',DELTA:'D',ECHO:'E',FOXTROT:'F',GOLF:'G',HOTEL:'H',INDIA:'I',JULIET:'J',KILO:'K',LIMA:'L',MIKE:'M',NOVEMBER:'N',OSCAR:'O',PAPA:'P',QUEBEC:'Q',ROMEO:'R',SIERRA:'S',TANGO:'T',UNIFORM:'U',VICTOR:'V',WHISKEY:'W',XRAY:'X',YANKEE:'Y',ZULU:'Z' };
            function start() {
                var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                var rec = new SR();
                rec.lang = 'en-US'; rec.continuous = false; rec.interimResults = false;
                rec.onresult = function(e) {
                    var t = e.results[0][0].transcript.trim().toUpperCase();
                    var direct = t.replace(/\s+/g, '');
                    if (/^[A-Z]{4}$/.test(direct)) { onResult(direct); setListening(false); return; }
                    var words = t.split(/\s+/);
                    var conv = words.map(function(w) { return PHONETIC[w] || (w.length === 1 ? w : null); }).filter(Boolean).join('');
                    if (/^[A-Z]{4}$/.test(conv)) { onResult(conv); setListening(false); return; }
                    var match = Object.entries(AIRPORTS).find(function([, a]) {
                        return a.city.toUpperCase() === t || a.name.toUpperCase().includes(t);
                    });
                    if (match) onResult(match[0]);
                    setListening(false);
                };
                rec.onerror = function() { setListening(false); };
                rec.onend = function() { setListening(false); };
                rec.start(); setListening(true);
            }
            return (
                <button onClick={start} title={listening ? 'Listening…' : 'Voice input'} style={{ background:'none', border:'none', cursor:'pointer', padding:'4px', display:'inline-flex', alignItems:'center', ...(style || {}) }}>
                    <MdIcon name={listening ? 'mic' : 'mic_none'} style={{ fontSize:20, color: listening ? 'var(--md-sys-color-error)' : 'var(--md-sys-color-outline)', transition:'color 0.2s' }} />
                </button>
            );
        }

        /* =========================================
           AIRPORT INPUT WITH AUTOCOMPLETE
        ========================================= */
        function AirportInput({ label, value, onChange, placeholder, containerStyle }) {
            var [open, setOpen] = useState(false);
            var [suggestions, setSuggestions] = useState([]);
            useEffect(() => {
                var q = (value || '').trim().toUpperCase();
                if (q.length < 2) { setSuggestions([]); return; }
                var matches = Object.entries(AIRPORTS)
                    .filter(function([k, a]) {
                        return k.startsWith(q) || a.city.toUpperCase().startsWith(q) || a.name.toUpperCase().includes(q) || k === q;
                    })
                    .slice(0, 6)
                    .map(function([k, a]) { return { icao: k, name: a.name, city: a.city, state: a.state }; });
                setSuggestions(matches);
            }, [value]);

            function pick(icao) { onChange(icao); setSuggestions([]); setOpen(false); }

            return (
                <div style={{ position:'relative', flex:1, ...(containerStyle || {}) }}>
                    <div style={{ display:'flex', alignItems:'center', gap:0 }}>
                        <MdInput
                            label={label} value={value} placeholder={placeholder} maxLength={4}
                            containerStyle={{ flex:1 }}
                            onChange={function(e) { onChange(e.target.value.trim().toUpperCase()); setOpen(true); }}
                            onFocus={function() { setOpen(true); }}
                            onBlur={function() { setTimeout(function() { setOpen(false); }, 160); }}
                        />
                        <VoiceInputButton onResult={function(v) { onChange(v); setSuggestions([]); }} style={{ marginLeft:4 }} />
                    </div>
                    {open && suggestions.length > 0 && (
                        <div className="apt-suggest-drop">
                            {suggestions.map(function(s) {
                                return (
                                    <div key={s.icao} className="apt-suggest-item" onMouseDown={function() { pick(s.icao); }}>
                                        <span className="font-mono" style={{ fontWeight:700, fontSize:14, color:'var(--md-sys-color-primary)', minWidth:46 }}>{s.icao}</span>
                                        <div>
                                            <div style={{ fontSize:12, color:'var(--md-sys-color-on-surface)', lineHeight:1.3 }}>{s.name}</div>
                                            <div style={{ fontSize:11, color:'var(--md-sys-color-on-surface-variant)' }}>{s.city}, {s.state}</div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        /* =========================================
           SEMICIRCLE SAFETY GAUGE (SVG)
        ========================================= */
        function SemiGauge({ score, size }) {
            size = size || 180;
            var cx = size / 2, cy = size * 0.58, r = size * 0.40;
            var arcLen = Math.PI * r;
            var col = score >= 75 ? 'var(--cat-vfr-color)' : score >= 50 ? 'var(--cat-mvfr-color)' : 'var(--cat-ifr-color)';
            var pathD = 'M ' + (cx - r).toFixed(1) + ' ' + cy.toFixed(1) + ' A ' + r.toFixed(1) + ' ' + r.toFixed(1) + ' 0 0 1 ' + (cx + r).toFixed(1) + ' ' + cy.toFixed(1);
            return (
                <div style={{ position:'relative', width:size, margin:'0 auto' }}>
                    <svg width={size} height={Math.round(cy + 20)} viewBox={'0 0 ' + size + ' ' + Math.round(cy + 20)} style={{ display:'block' }}>
                        <path d={pathD} fill="none" stroke="var(--md-sys-color-surface-container-highest)" strokeWidth="10" strokeLinecap="round" />
                        <path d={pathD} fill="none" stroke={col} strokeWidth="10" strokeLinecap="round"
                            strokeDasharray={arcLen.toFixed(1)} strokeDashoffset={(arcLen * (1 - score / 100)).toFixed(1)}
                            style={{ transition:'stroke-dashoffset 0.9s ease-out' }} />
                        <text x={cx - r - 2} y={cy + 16} textAnchor="middle" fontSize="10" fill="var(--md-sys-color-on-surface-variant)" fontFamily="sans-serif">0</text>
                        <text x={cx + r + 2} y={cy + 16} textAnchor="middle" fontSize="10" fill="var(--md-sys-color-on-surface-variant)" fontFamily="sans-serif">100</text>
                        <text x={cx} y={cy - r * 0.1} textAnchor="middle" fontSize={Math.round(size * 0.18)} fontWeight="800" fill={col} fontFamily="monospace">{score}</text>
                        <text x={cx} y={cy + 8} textAnchor="middle" fontSize="9" fill="var(--md-sys-color-on-surface-variant)" fontFamily="sans-serif" letterSpacing="1">SAFETY SCORE</text>
                    </svg>
                </div>
            );
        }

        /* =========================================
           SCORE BREAKDOWN PANEL
        ========================================= */
        function ScoreBreakdown({ breakdown, total }) {
            return (
                <div style={{ background:'var(--md-sys-color-surface-container)', borderRadius:16, padding:'16px 20px', marginBottom:16 }}>
                    <div style={{ display:'flex', alignItems:'center', gap:8, marginBottom:16 }}>
                        <MdIcon name="analytics" style={{ color:'var(--md-sys-color-primary)', fontSize:18 }} />
                        <span style={{ fontWeight:700, fontSize:13, textTransform:'uppercase', letterSpacing:'0.5px', color:'var(--md-sys-color-primary)' }}>Composite Safety Score</span>
                    </div>
                    <SemiGauge score={total} size={180} />
                    <div style={{ marginTop:16, display:'flex', flexDirection:'column', gap:12 }}>
                        {breakdown.map(function(f) {
                            return (
                                <div key={f.label} style={{ display:'flex', alignItems:'flex-start', gap:10 }}>
                                    <MdIcon name={f.icon} style={{ fontSize:16, color:f.color, flexShrink:0, marginTop:3 }} />
                                    <div style={{ flex:1 }}>
                                        <div style={{ display:'flex', justifyContent:'space-between', marginBottom:4 }}>
                                            <span style={{ fontSize:12, fontWeight:500, color:'var(--md-sys-color-on-surface)' }}>{f.label}</span>
                                            <span className="font-mono" style={{ fontSize:12, fontWeight:700, color:f.color }}>
                                                {f.score}<span style={{ fontWeight:400, color:'var(--md-sys-color-on-surface-variant)' }}>/{f.max}</span>
                                            </span>
                                        </div>
                                        <div style={{ height:6, background:'var(--md-sys-color-surface-container-highest)', borderRadius:3, overflow:'hidden', marginBottom:3 }}>
                                            <div style={{ width:(f.score/f.max*100)+'%', height:'100%', background:f.color, borderRadius:3, transition:'width 0.9s ease-out' }} />
                                        </div>
                                        <div style={{ fontSize:11, color:'var(--md-sys-color-on-surface-variant)' }}>{f.detail}</div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        /* =========================================
           LIVE PIREPS (from AviationWeather.gov)
        ========================================= */
        function LivePireps({ dep, arr }) {
            var [pireps, setPireps] = useState(null);
            var [loading, setLoading] = useState(true);
            useEffect(() => {
                setLoading(true); setPireps(null);
                var depApt = getAirport(dep), arrApt = getAirport(arr);
                if (!depApt) { setLoading(false); return; }
                var lat = depApt.lat, lon = depApt.lon;
                if (arrApt) { lat = (depApt.lat + arrApt.lat) / 2; lon = (depApt.lon + arrApt.lon) / 2; }
                fetchLivePireps(lat, lon, 200).then(function(data) {
                    setPireps(data); setLoading(false);
                }).catch(function() { setLoading(false); });
            }, [dep, arr]);

            if (loading) return (
                <div style={{ padding:'24px', textAlign:'center', color:'var(--md-sys-color-on-surface-variant)' }}>
                    <MdIcon name="sync" style={{ animation:'spin 1s linear infinite', fontSize:24 }} />
                    <div style={{ marginTop:8, fontSize:13 }}>Fetching live PIREPs…</div>
                </div>
            );
            var sim = makePireps(dep, arr);
            if (!pireps || pireps.length === 0) {
                return (
                    <MdCard style={{ padding:12 }}>
                        <div style={{ fontSize:11, color:'var(--md-sys-color-on-surface-variant)', marginBottom:8, display:'flex', alignItems:'center', gap:6 }}>
                            <MdIcon name="info" style={{ fontSize:14 }} />No live PIREPs within 200 NM — representative samples shown
                        </div>
                        {sim.map(function(p, i) {
                            return (
                                <div key={i} className="font-mono" style={{ background:'var(--md-sys-color-surface-container-highest)', borderRadius:8, padding:12, marginBottom:i<sim.length-1?8:0, borderLeft:'4px solid var(--md-sys-color-outline)', fontSize:12, color:'var(--md-sys-color-on-surface)', lineHeight:1.6 }}>
                                    <span style={{ color:'var(--md-sys-color-outline)', fontWeight:700, marginRight:8 }}>{p.type}</span>{p.text}
                                </div>
                            );
                        })}
                    </MdCard>
                );
            }
            return (
                <MdCard style={{ padding:12 }}>
                    <div style={{ fontSize:11, color:'var(--cat-vfr-color)', marginBottom:8, display:'flex', alignItems:'center', gap:6 }}>
                        <MdIcon name="verified" style={{ fontSize:14 }} />
                        Live PIREPs — AviationWeather.gov ({pireps.length} report{pireps.length !== 1 ? 's' : ''} within 200 NM)
                    </div>
                    {pireps.slice(0, 8).map(function(p, i) {
                        var raw = p.rawOb || p.rawPirep || '';
                        var type = (p.reportType === 'PIREP' || !p.reportType) ? 'UA' : 'UUA';
                        var fallback = [p.acId, p.altitudeFtMsl ? ('FL' + Math.round(p.altitudeFtMsl / 100)) : null, p.turbIntensity ? ('TB ' + p.turbIntensity) : null, p.icingIntensity ? ('IC ' + p.icingIntensity) : null].filter(Boolean).join(' ');
                        return (
                            <div key={i} className="font-mono" style={{ background:'var(--md-sys-color-surface-container-highest)', borderRadius:8, padding:12, marginBottom:i<Math.min(pireps.length,8)-1?8:0, borderLeft:'4px solid var(--md-sys-color-primary)', fontSize:12, color:'var(--md-sys-color-on-surface)', lineHeight:1.6 }}>
                                <span style={{ color:'var(--md-sys-color-primary)', fontWeight:700, marginRight:8 }}>{type}</span>
                                {raw || fallback || 'No detail available'}
                            </div>
                        );
                    })}
                </MdCard>
            );
        }

        // ── HazardAdvisories component ───────────────────────────────────────────
        // Shows active SIGMETs, G-AIRMETs, and CWAs along the route corridor
        function HazardAdvisories({ sigmets, gairmets, cwas, loading }) {
            if (loading) return (
                <div style={{ display:'flex', alignItems:'center', gap:8, padding:'10px 14px', background:'var(--md-sys-color-surface-container)', borderRadius:12, marginBottom:12, fontSize:13, color:'var(--md-sys-color-on-surface-variant)' }}>
                    <MdIcon name="sync" style={{ fontSize:16, animation:'spin 1s linear infinite', flexShrink:0 }} />
                    <span>Fetching SIGMETs, AIRMETs, CWAs…</span>
                </div>
            );
            var items = [];
            sigmets.forEach(function(f) {
                var p = f.properties || {};
                var hz = (p.hazard || '').toUpperCase();
                var icon = hz === 'CONVECTIVE' ? 'thunderstorm' : hz === 'TURB' ? 'air' : hz === 'ICE' ? 'ac_unit' : 'warning';
                var color = hz === 'CONVECTIVE' ? 'var(--md-sys-color-error)' : hz === 'ICE' ? 'var(--cat-mvfr-color)' : 'var(--md-sys-color-warning)';
                var label = 'SIGMET';
                var isConv = hz === 'CONVECTIVE';
                items.push({ icon, color, label: isConv ? 'CONVECTIVE SIGMET' : ('SIGMET · ' + hz), text: p.rawAirSigmet || ('Hazard: ' + hz + (p.severity ? ' SEV:'+p.severity : '')), isConv });
            });
            gairmets.forEach(function(g) {
                var hz = (g.hazard || '').toUpperCase();
                var icon = hz.includes('TURB') ? 'air' : hz.includes('ICE') ? 'ac_unit' : hz.includes('IFR') || hz.includes('MTN') ? 'cloud' : hz.includes('LLWS') ? 'swap_vert' : 'warning';
                var color = hz.includes('TURB') ? 'var(--md-sys-color-warning)' : hz.includes('ICE') ? 'var(--cat-mvfr-color)' : 'var(--md-sys-color-on-surface-variant)';
                var sev = g.severity ? (' · ' + g.severity) : '';
                var alt = (g.base != null && g.top != null) ? (' · ' + (g.base*100) + '-' + (g.top*100) + 'ft') : '';
                items.push({ icon, color, label: 'AIRMET ' + (g.tag||'') + ' · ' + hz + sev, text: 'Valid: ' + (g.validTime||'') + alt });
            });
            cwas.forEach(function(c) {
                var hz = (c.hazard || '').toUpperCase();
                var icon = hz === 'TS' ? 'thunderstorm' : hz === 'TURB' ? 'air' : hz === 'ICE' ? 'ac_unit' : hz === 'IFR' ? 'cloud' : 'warning';
                var color = hz === 'TS' ? 'var(--md-sys-color-error)' : 'var(--md-sys-color-warning)';
                var top = c.top ? (' · Top ' + c.top + 'ft') : '';
                items.push({ icon, color, label: 'CWA · ' + (c.cwsuId||'') + ' · ' + hz + (c.qualifier ? ' ' + c.qualifier : ''), text: (c.rawCWA || ('Hazard: ' + hz)) + top });
            });
            if (items.length === 0) return null;
            return (
                <div style={{ background:'var(--md-sys-color-surface-container)', borderRadius:16, padding:16, marginBottom:16 }}>
                    <div style={{ display:'flex', alignItems:'center', gap:8, marginBottom:12 }}>
                        <MdIcon name="notifications_active" style={{ color:'var(--md-sys-color-error)', fontSize:18 }} />
                        <span style={{ fontWeight:700, fontSize:13, textTransform:'uppercase', letterSpacing:'0.5px', color:'var(--md-sys-color-error)' }}>
                            Active Hazard Advisories ({items.length})
                        </span>
                    </div>
                    <div style={{ display:'flex', flexDirection:'column', gap:10 }}>
                        {items.map(function(item, i) {
                            return (
                                <div key={i} style={{ background: item.isConv ? 'var(--md-sys-color-error-container)' : 'var(--md-sys-color-surface-container-high)', borderRadius:10, padding:'10px 12px', borderLeft:'3px solid '+item.color }}>
                                    <div style={{ display:'flex', alignItems:'center', gap:7, marginBottom:4 }}>
                                        <MdIcon name={item.icon} style={{ fontSize:15, color:item.color, flexShrink:0 }} />
                                        <span style={{ fontSize:11, fontWeight:700, color:item.color, textTransform:'uppercase', letterSpacing:'0.4px' }}>{item.label}</span>
                                    </div>
                                    <div className="font-mono" style={{ fontSize:11, color:'var(--md-sys-color-on-surface)', lineHeight:1.5, whiteSpace:'pre-wrap', wordBreak:'break-word' }}>{item.text}</div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // ── WindsAloftCard component ─────────────────────────────────────────────
        // Shows FD winds & temps aloft at cruise altitude for each route waypoint
        function WindsAloftCard({ allRoutePts, stations, cruiseAlt }) {
            if (!stations || stations.length === 0) return null;
            var alt = cruiseAlt || 6000;
            var rows = allRoutePts.map(function(icao) {
                var apt = getAirport(icao);
                if (!apt) return null;
                var stn = closestWindStation(stations, apt.lat, apt.lon);
                var w = stn ? getWindAtAlt(stn, alt) : null;
                return { icao, apt, w, stnId: stn ? (stn.icaoId || stn.stn || '') : '' };
            }).filter(Boolean);
            if (rows.every(function(r) { return !r.w; })) return null;
            return (
                <div style={{ background:'var(--md-sys-color-surface-container)', borderRadius:16, padding:16, marginBottom:16 }}>
                    <div style={{ display:'flex', alignItems:'center', gap:8, marginBottom:12 }}>
                        <MdIcon name="air" style={{ color:'var(--md-sys-color-secondary)', fontSize:18 }} />
                        <span style={{ fontWeight:700, fontSize:13, textTransform:'uppercase', letterSpacing:'0.5px', color:'var(--md-sys-color-secondary)' }}>Winds Aloft</span>
                        <span style={{ fontSize:10, fontWeight:700, background:'var(--md-sys-color-secondary-container)', color:'var(--md-sys-color-on-secondary-container)', borderRadius:4, padding:'2px 6px', letterSpacing:'0.5px' }}>
                            {(alt/1000).toFixed(0)}K FT · FD WINDS
                        </span>
                    </div>
                    <div style={{ display:'flex', flexDirection:'column', gap:8 }}>
                        {rows.map(function(r) {
                            return (
                                <div key={r.icao} style={{ display:'grid', gridTemplateColumns:'50px 1fr', gap:'6px 12px', alignItems:'center', padding:'6px 0', borderBottom:'1px solid var(--md-sys-color-outline-variant)' }}>
                                    <span className="font-mono" style={{ fontWeight:700, fontSize:13 }}>{r.icao}</span>
                                    {r.w ? (
                                        <div className="font-mono" style={{ fontSize:12, color:'var(--md-sys-color-on-surface)' }}>
                                            {r.w.lv ? 'LGT & VRB' : (r.w.wdir + '° @ ' + r.w.wspd + 'kt')}
                                            {r.w.temp != null && <span style={{ marginLeft:10, color:'var(--md-sys-color-on-surface-variant)' }}>{r.w.temp > 0 ? '+' : ''}{r.w.temp}°C</span>}
                                            <span style={{ marginLeft:8, fontSize:10, color:'var(--md-sys-color-on-surface-variant)' }}>(via {r.stnId})</span>
                                        </div>
                                    ) : (
                                        <span style={{ fontSize:11, color:'var(--md-sys-color-on-surface-variant)' }}>No FD data</span>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                    <div style={{ fontSize:10, color:'var(--md-sys-color-on-surface-variant)', marginTop:8, lineHeight:1.5 }}>
                        Nearest FD reporting station used per waypoint. Source: AviationWeather.gov /api/data/windtemp.
                    </div>
                </div>
            );
        }

        function CatBadge({ cat }) {
            const lc = cat.toLowerCase();
            return (
                <span className="font-mono" style={{ 
                    display: "inline-flex", padding: "2px 12px", borderRadius: "12px", 
                    fontSize: "11px", fontWeight: "700",
                    background: `var(--cat-${lc}-bg)`, color: `var(--cat-${lc}-color)` 
                }}>{cat}</span>
            );
        }

        /* =========================================
           APP COMPONENTS
        ========================================= */

        function GoScoreRing({ score, size = 100 }) {
            var r = (size - 10) / 2;
            var circ = 2 * Math.PI * r;
            var col = getGoColor(score);
            return (
                <div style={{ position: "relative", width: size, height: size }}>
                    <svg width={size} height={size} style={{ transform: "rotate(-90deg)" }}>
                        <circle cx={size / 2} cy={size / 2} r={r} fill="none" stroke="var(--md-sys-color-surface-container-highest)" strokeWidth="6" />
                        <circle cx={size / 2} cy={size / 2} r={r} fill="none" stroke={col} strokeWidth="6" strokeDasharray={circ} strokeDashoffset={circ * (1 - score / 100)} strokeLinecap="round" style={{ transition: "stroke-dashoffset 0.8s ease-out" }} />
                    </svg>
                    <div style={{ position: "absolute", inset: 0, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center" }}>
                        <div style={{ fontSize: size * 0.3, fontWeight: 700, color: col, lineHeight: 1 }}>{score}</div>
                        <div className="font-mono" style={{ fontSize: size * 0.1, color: "var(--md-sys-color-on-surface-variant)", fontWeight: 600, letterSpacing: "0.05em", marginTop: 2 }}>SCORE</div>
                    </div>
                </div>
            );
        }

        function RouteMap({ dep, arr, wps }) {
            const { useRef: useRefMap, useEffect: useEffectMap } = React;
            const mapContainerRef = useRefMap(null);
            const leafletMapRef = useRefMap(null);
            const layersRef = useRefMap([]);

            var allCodes = [dep].concat(wps || []).concat([arr]).filter(c => c && c.trim().length === 4);
            var allPts = allCodes.map(c => getAirport(c)).filter(Boolean);

            var totalDist = 0;
            var heading = 0;
            if (allPts.length >= 2) {
                for (var di = 0; di < allPts.length - 1; di++) {
                    totalDist += calcDist(allPts[di].lat, allPts[di].lon, allPts[di+1].lat, allPts[di+1].lon);
                }
                heading = calcBearing(allPts[0].lat, allPts[0].lon, allPts[allPts.length-1].lat, allPts[allPts.length-1].lon);
            }

            useEffectMap(() => {
                const L = window.L;
                if (!L || !mapContainerRef.current) return;

                // Initialize map once
                if (!leafletMapRef.current) {
                    leafletMapRef.current = L.map(mapContainerRef.current, { zoomControl: true });
                    L.tileLayer(
                        'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
                        { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>', subdomains: 'abcd', maxZoom: 19 }
                    ).addTo(leafletMapRef.current);
                }
                const map = leafletMapRef.current;

                // Remove previous route layers
                layersRef.current.forEach(l => map.removeLayer(l));
                layersRef.current = [];

                if (allPts.length < 2) return;

                const latLngs = allPts.map(p => [p.lat, p.lon]);

                // Route polyline
                const line = L.polyline(latLngs, { color: '#0b57d0', weight: 3, dashArray: '8 5', opacity: 0.9 });
                line.addTo(map);
                layersRef.current.push(line);

                // Waypoint markers
                const colors = { dep: '#0b57d0', arr: '#6b5778', wp: '#535f70' };
                allPts.forEach((p, i) => {
                    const isDep = i === 0, isArr = i === allPts.length - 1;
                    const color = isDep ? colors.dep : isArr ? colors.arr : colors.wp;
                    const marker = L.circleMarker([p.lat, p.lon], {
                        radius: (isDep || isArr) ? 9 : 7,
                        fillColor: color, color: '#fff', weight: 2, fillOpacity: 1
                    });
                    marker.addTo(map);
                    marker.bindTooltip(allCodes[i], { permanent: true, direction: 'top', offset: [0, -8], className: 'route-icao-label' });
                    layersRef.current.push(marker);
                });

                map.fitBounds(latLngs, { padding: [50, 50] });
            }, [dep, arr, JSON.stringify(wps), allPts.length]);

            // Cleanup on unmount
            useEffectMap(() => {
                return () => {
                    if (leafletMapRef.current) {
                        leafletMapRef.current.remove();
                        leafletMapRef.current = null;
                    }
                };
            }, []);

            if (allPts.length < 2) {
                return (
                    <div style={{ display: "flex", alignItems: "center", justifyContent: "center", background: "var(--md-sys-color-surface-container-lowest)", borderRadius: "16px", minHeight: "420px" }}>
                        <span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: "14px" }}>Enter valid route to view map</span>
                    </div>
                );
            }

            return (
                <div style={{ position: "relative", borderRadius: "16px", overflow: "hidden" }}>
                    <div ref={mapContainerRef} style={{ width: "100%", height: "420px" }} />
                    <div className="font-mono" style={{ position: "absolute", bottom: 36, left: 12, zIndex: 1000, display: "flex", gap: 8, fontSize: 12, pointerEvents: "none" }}>
                        <div style={{ background: "rgba(255,255,255,0.95)", borderRadius: "8px", padding: "6px 12px", color: "#1a1c1e", boxShadow: "0 2px 6px rgba(0,0,0,0.18)" }}>
                            <span style={{ color: "#73777f" }}>DIST </span><span style={{ fontWeight: 700 }}>{Math.round(totalDist)} NM</span>
                        </div>
                        <div style={{ background: "rgba(255,255,255,0.95)", borderRadius: "8px", padding: "6px 12px", color: "#1a1c1e", boxShadow: "0 2px 6px rgba(0,0,0,0.18)" }}>
                            <span style={{ color: "#73777f" }}>HDG </span><span style={{ fontWeight: 700 }}>{String(Math.round(heading)).padStart(3, "0")}&deg;</span>
                        </div>
                    </div>
                </div>
            );
        }

        function ForecastStrip({ icao, selectedDay, onSelect }) {
            const [forecasts, setForecasts] = useState(null);
            const [isLive, setIsLive] = useState(false);

            useEffect(() => {
                setForecasts(null);
                setIsLive(false);
                var apt = getAirport(icao);
                if (apt) {
                    fetchNwsForecast(apt.lat, apt.lon).then(data => {
                        if (data) { setForecasts(data); setIsLive(true); }
                        else setForecasts(makeForecast(icao));
                    }).catch(() => setForecasts(makeForecast(icao)));
                } else {
                    fetchAirportInfo(icao).then(a => {
                        if (a) {
                            fetchNwsForecast(a.lat, a.lon).then(data => {
                                if (data) { setForecasts(data); setIsLive(true); }
                                else setForecasts(makeForecast(icao));
                            }).catch(() => setForecasts(makeForecast(icao)));
                        } else {
                            setForecasts(makeForecast(icao));
                        }
                    }).catch(() => setForecasts(makeForecast(icao)));
                }
            }, [icao]);

            var items = forecasts || makeForecast(icao);

            return (
                <div>
                    <div style={{ fontSize: 11, color: "var(--md-sys-color-on-surface-variant)", marginBottom: 6, display: "flex", alignItems: "center", gap: 4 }}>
                        <MdIcon name="calendar_month" style={{ fontSize: 13 }} />
                        7-Day Forecast
                        {isLive && <span style={{ color: "var(--md-sys-color-primary)", fontWeight: 700, fontSize: 10, background: "var(--md-sys-color-primary-container)", borderRadius: 4, padding: "1px 5px", marginLeft: 4 }}>NWS LIVE</span>}
                    </div>
                    <div style={{ display: "flex", gap: 8, overflowX: "auto", padding: "4px 0", WebkitOverflowScrolling: "touch" }}>
                        {items.map((f, i) => {
                            var selected = selectedDay === i;
                            var lc = f.cat.toLowerCase();
                            return (
                                <button key={i} onClick={() => onSelect(i)} style={{
                                    flex: "0 0 auto", minWidth: 72, padding: "12px 8px", borderRadius: "12px",
                                    border: selected ? `2px solid var(--cat-${lc}-color)` : "2px solid transparent",
                                    background: selected ? `var(--cat-${lc}-bg)` : "var(--md-sys-color-surface-container-high)",
                                    cursor: "pointer", textAlign: "center", transition: "all 0.2s"
                                }}>
                                    <div style={{ fontSize: 12, fontWeight: 700, color: selected ? `var(--cat-${lc}-color)` : "var(--md-sys-color-on-surface)", marginBottom: 2 }}>{f.dayName}</div>
                                    <div style={{ fontSize: 10, color: "var(--md-sys-color-on-surface-variant)", marginBottom: 8 }}>{f.dateStr}</div>
                                    <CatBadge cat={f.cat} />
                                    <div style={{ fontSize: 12, color: "var(--md-sys-color-on-surface)", marginTop: 8, fontWeight: 500 }}>{f.hi}&deg; <span style={{color: "var(--md-sys-color-on-surface-variant)"}}>{f.lo}&deg;</span></div>
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function WindyMap({ dep, arr, wps }) {
            var allPts = useMemo(() => [dep, ...(wps || []), arr].map(getAirport).filter(Boolean), [dep, arr, JSON.stringify(wps)]);
            if (allPts.length < 2) return null;
            var midLat = allPts.reduce((s, p) => s + p.lat, 0) / allPts.length;
            var midLon = allPts.reduce((s, p) => s + p.lon, 0) / allPts.length;
            var src = `https://embed.windy.com/embed2.html?lat=${midLat.toFixed(2)}&lon=${midLon.toFixed(2)}&detailLat=${midLat.toFixed(2)}&detailLon=${midLon.toFixed(2)}&zoom=6&level=surface&overlay=wind&product=ecmwf&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=kt&metricTemp=%C2%B0F&radarRange=-1`;
            return (
                <div style={{ marginTop: 24 }}>
                    <h2 style={{ fontSize: 16, fontWeight: 500, margin: "0 0 12px", color: "var(--md-sys-color-on-surface)", display: "flex", alignItems: "center", gap: 8 }}>
                        <MdIcon name="storm" style={{ color: "var(--md-sys-color-primary)" }} />
                        Live Wind &amp; Weather Radar
                    </h2>
                    <div style={{ borderRadius: "16px", overflow: "hidden", border: "1px solid var(--md-sys-color-outline-variant)" }}>
                        <iframe src={src} style={{ width: "100%", height: "450px", border: "none" }} allowFullScreen title="Windy Weather Radar" />
                    </div>
                </div>
            );
        }

        // Returns the best runway and crosswind component given a metar and airport.
        // Picks the runway end with the smallest crosswind component.
        function getRunwayRecommendation(metar, apt) {
            if (!metar || !apt || !apt.rwy || apt.rwy.length === 0) return null;
            if (metar.wdir == null || !metar.wspd || metar.wspd < 3) return null;
            var windDir = metar.wdir;
            var windSpd = metar.wspd;
            var best = null;
            var bestCross = Infinity;
            apt.rwy.forEach(function(rwyPair) {
                rwyPair.split("/").forEach(function(rwyEnd) {
                    var m = rwyEnd.match(/^(\d+)/);
                    if (!m) return;
                    var rwyHdg = parseInt(m[1]) * 10;
                    var angle = ((windDir - rwyHdg) % 360 + 360) % 360;
                    if (angle > 180) angle -= 360;
                    var rad = angle * Math.PI / 180;
                    var cross = Math.abs(windSpd * Math.sin(rad));
                    var head = windSpd * Math.cos(rad);
                    if (cross < bestCross) {
                        bestCross = cross;
                        best = { rwy: rwyEnd, crosswind: Math.round(cross), headwind: Math.round(head) };
                    }
                });
            });
            return best;
        }

        function WeatherDetail({ icao, label }) {
            const [expanded, setExpanded] = useState(false);
            const [aptReady, setAptReady] = useState(!!AIRPORTS[icao]);
            const [liveMetar, setLiveMetar] = useState(null);
            const [liveTaf, setLiveTaf] = useState(null);
            const [loadingWx, setLoadingWx] = useState(true);

            useEffect(() => {
                if (!AIRPORTS[icao]) {
                    fetchAirportInfo(icao).then(a => { if (a) setAptReady(true); });
                }
            }, [icao]);

            useEffect(() => {
                setLoadingWx(true);
                setLiveMetar(null);
                setLiveTaf(null);
                Promise.all([fetchLiveMetar(icao), fetchLiveTaf(icao)]).then(([m, t]) => {
                    setLiveMetar(m);
                    setLiveTaf(t);
                    setLoadingWx(false);
                });
            }, [icao]);

            var metar = liveMetar || (aptReady ? makeMetar(icao) : null);
            var taf = (liveTaf && liveTaf.rawTAF) ? liveTaf.rawTAF : makeTaf(icao);
            var apt = getAirport(icao);
            if (!apt && !loadingWx) { return null; }
            if (!metar && !loadingWx) { return null; }

            return (
                <MdCard style={{ marginBottom: '16px' }}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 16 }}>
                        <div>
                            <div style={{ fontSize: 12, fontWeight: 600, color: "var(--md-sys-color-primary)", textTransform: "uppercase", letterSpacing: "0.5px", marginBottom: 4 }}>{label}</div>
                            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                <span className="font-mono" style={{ fontSize: 20, fontWeight: 700 }}>{icao}</span>
                                {apt && <span style={{ fontSize: 14, color: "var(--md-sys-color-on-surface-variant)" }}>{apt.city}, {apt.state}</span>}
                                {liveMetar && <span style={{ fontSize: 10, color: "var(--md-sys-color-primary)", background: "var(--md-sys-color-primary-container)", borderRadius: 4, padding: "2px 6px", fontWeight: 700, letterSpacing: "0.5px" }}>LIVE</span>}
                                {loadingWx && <MdIcon name="sync" style={{ fontSize: 14, color: "var(--md-sys-color-on-surface-variant)", animation: "spin 1s linear infinite" }} />}
                            </div>
                        </div>
                        {metar && <CatBadge cat={metar.cat} />}
                    </div>

                    {loadingWx && !metar && (
                        <div style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 13, padding: "8px 0" }}>Fetching live weather data...</div>
                    )}

                    {metar && (
                        <>
                            <div className="font-mono" style={{ background: "var(--md-sys-color-surface-container-lowest)", borderRadius: "8px", padding: "12px", fontSize: 13, color: "var(--md-sys-color-on-surface)", lineHeight: 1.6, wordBreak: "break-all", marginBottom: 16, border: "1px solid var(--md-sys-color-outline-variant)" }}>{metar.raw}</div>

                            <div className="font-mono" style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(100px, 1fr))", gap: "12px 16px", fontSize: 13 }}>
                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 11, display: 'block' }}>WIND</span><span style={{ fontWeight: 600 }}>{metar.wind}</span></div>
                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 11, display: 'block' }}>VIS</span><span style={{ fontWeight: 600 }}>{metar.vis}</span></div>
                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 11, display: 'block' }}>SKY</span><span style={{ fontWeight: 600 }}>{metar.sky}</span></div>
                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 11, display: 'block' }}>TEMP</span><span style={{ fontWeight: 600 }}>{metar.temp}</span></div>
                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 11, display: 'block' }}>ALTM</span><span style={{ fontWeight: 600 }}>{metar.alt}</span></div>
                            </div>

                            {(() => {
                                var rec = getRunwayRecommendation(metar, apt);
                                if (!rec) return null;
                                var crossColor = rec.crosswind <= 10
                                    ? "var(--md-sys-color-primary)"
                                    : rec.crosswind <= 15
                                        ? "var(--cat-mvfr-color)"
                                        : "var(--md-sys-color-error)";
                                return (
                                    <div style={{ marginTop: 12, paddingTop: 12, borderTop: "1px solid var(--md-sys-color-outline-variant)", display: "flex", alignItems: "center", gap: 24, flexWrap: "wrap" }}>
                                        <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                                            <MdIcon name="airline_stops" style={{ fontSize: 16, color: "var(--md-sys-color-on-surface-variant)" }} />
                                            <span style={{ fontSize: 11, color: "var(--md-sys-color-on-surface-variant)", textTransform: "uppercase", letterSpacing: "0.5px" }}>Recommended Runway</span>
                                        </div>
                                        <span className="font-mono" style={{ fontWeight: 700, fontSize: 15 }}>{rec.rwy}</span>
                                        <div>
                                            <span style={{ fontSize: 11, color: "var(--md-sys-color-on-surface-variant)", textTransform: "uppercase", letterSpacing: "0.5px" }}>Crosswind </span>
                                            <span className="font-mono" style={{ fontWeight: 700, fontSize: 14, color: crossColor }}>{rec.crosswind}KT</span>
                                        </div>
                                        {rec.headwind > 0 && (
                                            <div>
                                                <span style={{ fontSize: 11, color: "var(--md-sys-color-on-surface-variant)", textTransform: "uppercase", letterSpacing: "0.5px" }}>Headwind </span>
                                                <span className="font-mono" style={{ fontWeight: 700, fontSize: 14 }}>{rec.headwind}KT</span>
                                            </div>
                                        )}
                                    </div>
                                );
                            })()}

                            <div style={{ marginTop: 16, paddingTop: 16, borderTop: "1px solid var(--md-sys-color-outline-variant)" }}>
                                <MdButton variant="text" onClick={() => setExpanded(!expanded)} icon={expanded ? "expand_less" : "expand_more"} style={{ padding: '4px 8px', margin: '-4px -8px' }}>
                                    {expanded ? "Hide TAF" : "View TAF"}
                                </MdButton>
                                {expanded && <div className="font-mono" style={{ background: "var(--md-sys-color-surface-container-lowest)", borderRadius: "8px", padding: "12px", fontSize: 12, color: "var(--md-sys-color-on-surface)", lineHeight: 1.8, marginTop: 12 }}>{taf}</div>}
                            </div>
                        </>
                    )}
                </MdCard>
            );
        }

        function NotamsPanel({ icao }) {
            var notams = useMemo(() => makeNotams(icao), [icao]);
            var sevColors = { 
                warning: "var(--md-sys-color-error)", 
                tertiary: "var(--md-sys-color-tertiary)", 
                error: "var(--md-sys-color-error)" 
            };
            
            return (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {notams.map((n, i) => (
                        <div key={i} style={{ 
                            background: "var(--md-sys-color-surface-container)", 
                            borderRadius: "12px", padding: "12px", 
                            borderLeft: `4px solid ${sevColors[n.severity] || "var(--md-sys-color-outline)"}` 
                        }}>
                            <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4 }}>
                                <MdIcon name={n.type === 'RWY' ? 'edit_road' : n.type === 'TFR' ? 'block' : 'warning'} style={{ fontSize: 16, color: sevColors[n.severity] }} />
                                <span className="font-mono" style={{ fontSize: 12, fontWeight: 700, color: sevColors[n.severity] }}>{n.type}</span>
                            </div>
                            <div className="font-mono" style={{ fontSize: 12, color: "var(--md-sys-color-on-surface)", lineHeight: 1.5 }}>{n.text}</div>
                        </div>
                    ))}
                </div>
            );
        }

        function FBOPanel({ icao, label }) {
            var apt = getAirport(icao);
            var fbos = FBO_DATA[icao] || [];
            var aopaUrl = "https://www.aopa.org/destinations/airports/" + icao + "/details";

            // Fuel type badge colors
            function fuelColor(type) {
                if (type.startsWith("100LL")) return { bg: "var(--cat-mvfr-bg)", color: "var(--cat-mvfr-color)" };
                if (type.startsWith("Jet-A"))  return { bg: "var(--cat-ifr-bg)", color: "var(--cat-ifr-color)" };
                if (type.startsWith("MOGAS"))   return { bg: "var(--cat-vfr-bg)", color: "var(--cat-vfr-color)" };
                return { bg: "var(--md-sys-color-surface-container)", color: "var(--md-sys-color-on-surface)" };
            }

            return (
                <MdCard style={{ marginBottom: 16 }}>
                    {/* Header */}
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 16 }}>
                        <div>
                            <div style={{ fontSize: 12, fontWeight: 600, color: "var(--md-sys-color-primary)", textTransform: "uppercase", letterSpacing: "0.5px", marginBottom: 4 }}>{label}</div>
                            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                <span className="font-mono" style={{ fontSize: 20, fontWeight: 700 }}>{icao}</span>
                                {apt && <span style={{ fontSize: 14, color: "var(--md-sys-color-on-surface-variant)" }}>{apt.city}, {apt.state}</span>}
                            </div>
                        </div>
                        <a href={aopaUrl} target="_blank" rel="noopener noreferrer" style={{ display: "flex", alignItems: "center", gap: 5, fontSize: 12, fontWeight: 600, color: "var(--md-sys-color-primary)", textDecoration: "none", background: "var(--md-sys-color-primary-container)", borderRadius: 8, padding: "6px 10px" }}>
                            <MdIcon name="open_in_new" style={{ fontSize: 14 }} />
                            AOPA
                        </a>
                    </div>

                    {fbos.length === 0 && (
                        <div style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 13, padding: "8px 0" }}>
                            No FBO data on file for {icao}. View current operators and fuel prices on AOPA.
                        </div>
                    )}

                    {fbos.map((fbo, i) => (
                        <div key={i} style={{ borderTop: i > 0 ? "1px solid var(--md-sys-color-outline-variant)" : "none", paddingTop: i > 0 ? 16 : 0 }}>
                            {/* FBO name + phone */}
                            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 12, flexWrap: "wrap", gap: 8 }}>
                                <div>
                                    <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4 }}>
                                        <MdIcon name="local_gas_station" style={{ fontSize: 18, color: "var(--md-sys-color-secondary)" }} />
                                        <span style={{ fontSize: 17, fontWeight: 700, color: "var(--md-sys-color-on-surface)" }}>{fbo.name}</span>
                                    </div>
                                    <a href={"tel:" + fbo.phone.replace(/\D/g, "")} style={{ display: "flex", alignItems: "center", gap: 6, textDecoration: "none", color: "var(--md-sys-color-primary)", fontSize: 15, fontWeight: 600, marginLeft: 26 }}>
                                        <MdIcon name="call" style={{ fontSize: 16 }} />
                                        {fbo.phone}
                                    </a>
                                </div>
                                <div style={{ display: "flex", alignItems: "center", gap: 6, color: "var(--md-sys-color-on-surface-variant)", fontSize: 13, marginLeft: 26 }}>
                                    <MdIcon name="schedule" style={{ fontSize: 15 }} />
                                    <span>{fbo.hours}</span>
                                </div>
                            </div>

                            {/* Fuel types */}
                            <div style={{ marginBottom: 14 }}>
                                <div style={{ fontSize: 11, fontWeight: 600, textTransform: "uppercase", letterSpacing: "0.5px", color: "var(--md-sys-color-on-surface-variant)", marginBottom: 8 }}>Fuel Available</div>
                                <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                                    {fbo.fuel.map((f, fi) => {
                                        var c = fuelColor(f.type);
                                        return (
                                            <div key={fi} style={{ display: "flex", alignItems: "center", gap: 10 }}>
                                                <span className="font-mono" style={{ fontWeight: 700, fontSize: 13, background: c.bg, color: c.color, borderRadius: 6, padding: "3px 8px", minWidth: 52, textAlign: "center" }}>{f.type}</span>
                                                <span style={{ fontSize: 13, color: "var(--md-sys-color-on-surface-variant)" }}>{f.service}</span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Live prices call-out */}
                            <a href={aopaUrl} target="_blank" rel="noopener noreferrer" style={{ display: "flex", alignItems: "center", gap: 10, textDecoration: "none", background: "var(--md-sys-color-surface-container-high)", borderRadius: 10, padding: "10px 14px", marginBottom: 14 }}>
                                <MdIcon name="price_check" style={{ fontSize: 20, color: "var(--md-sys-color-primary)", flexShrink: 0 }} />
                                <div style={{ flex: 1 }}>
                                    <div style={{ fontSize: 13, fontWeight: 600, color: "var(--md-sys-color-on-surface)" }}>View Live Fuel Prices</div>
                                    <div style={{ fontSize: 11, color: "var(--md-sys-color-on-surface-variant)" }}>Current 100LL &amp; Jet-A prices at {icao} on AOPA</div>
                                </div>
                                <MdIcon name="chevron_right" style={{ fontSize: 18, color: "var(--md-sys-color-on-surface-variant)" }} />
                            </a>

                            {/* Services */}
                            {fbo.services.length > 0 && (
                                <div>
                                    <div style={{ fontSize: 11, fontWeight: 600, textTransform: "uppercase", letterSpacing: "0.5px", color: "var(--md-sys-color-on-surface-variant)", marginBottom: 8 }}>Services</div>
                                    <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
                                        {fbo.services.map((s, si) => (
                                            <span key={si} style={{ fontSize: 12, background: "var(--md-sys-color-surface-container)", color: "var(--md-sys-color-on-surface-variant)", borderRadius: 6, padding: "3px 8px" }}>{s}</span>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    ))}

                    <div style={{ marginTop: 14, paddingTop: 12, borderTop: "1px solid var(--md-sys-color-outline-variant)", fontSize: 11, color: "var(--md-sys-color-on-surface-variant)", lineHeight: 1.5 }}>
                        Verify phone &amp; hours before flight. Fuel prices change daily — always confirm with the FBO.
                    </div>
                </MdCard>
            );
        }

        function FreqPanel({ icao }) {
            const [aptReady, setAptReady] = useState(!!AIRPORTS[icao]);
            useEffect(() => {
                if (!AIRPORTS[icao]) {
                    fetchAirportInfo(icao).then(a => { if (a) setAptReady(true); });
                }
            }, [icao]);
            var apt = getAirport(icao);
            if (!apt) return null;
            var labels = { atis: "ATIS", twr: "Tower", gnd: "Ground", app: "Approach", dep: "Departure", clnc: "Clearance" };
            
            return (
                <MdCard style={{ marginBottom: '16px' }}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                            <MdIcon name="cell_tower" style={{ color: 'var(--md-sys-color-primary)' }} />
                            <span className="font-mono" style={{ fontSize: 18, fontWeight: 700 }}>{icao}</span>
                        </div>
                        <span style={{ fontSize: 12, color: "var(--md-sys-color-on-surface-variant)" }}>{apt.artcc}</span>
                    </div>
                    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "12px 24px" }}>
                        {Object.entries(apt.freq).map(([key, val]) => (
                            <div key={key} style={{ display: "flex", justifyContent: "space-between", alignItems: 'center', borderBottom: '1px solid var(--md-sys-color-outline-variant)', paddingBottom: 4 }}>
                                <span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 13 }}>{labels[key] || key}</span>
                                <span className="font-mono" style={{ color: "var(--md-sys-color-primary)", fontWeight: 600, fontSize: 15 }}>{val}</span>
                            </div>
                        ))}
                    </div>
                </MdCard>
            );
        }

        // Windy.com embedded forecast widget centered on an airport
        function WindyEmbed({ icao, tripTargetUtc }) {
            var apt = getAirport(icao);
            if (!apt) return null;
            var lat = apt.lat.toFixed(3), lon = apt.lon.toFixed(3);
            var windyUrl = [
                `https://embed.windy.com/embed2.html`,
                `?lat=${lat}&lon=${lon}`,
                `&detailLat=${lat}&detailLon=${lon}`,
                `&width=650&height=340&pview=0`,
                `&level=surface&overlay=wind&product=ecmwf`,
                `&menu=&message=true&marker=true&calendar=now`,
                `&type=map&location=coordinates&detail=true`,
                `&metricWind=kt&metricTemp=%C2%B0C&radarRange=-1`
            ].join('');
            var windyFullUrl = `https://www.windy.com/?wind,surface,${lat},${lon},8`;
            return (
                <div>
                    <iframe
                        src={windyUrl}
                        title="Windy.com forecast"
                        style={{ width: '100%', height: 340, border: 'none', borderRadius: 10, display: 'block' }}
                        allow="geolocation"
                        loading="lazy"
                    />
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: 8, flexWrap: 'wrap', gap: 6 }}>
                        <span style={{ fontSize: 11, color: 'var(--md-sys-color-on-surface-variant)' }}>
                            ECMWF model · wind/clouds overlay · centered on <strong>{icao}</strong>
                        </span>
                        <a href={windyFullUrl} target="_blank" rel="noopener noreferrer"
                            style={{ fontSize: 11, fontWeight: 600, color: 'var(--md-sys-color-primary)', textDecoration: 'none', display: 'flex', alignItems: 'center', gap: 4 }}>
                            <MdIcon name="open_in_new" style={{ fontSize: 13 }} />
                            Open Windy.com
                        </a>
                    </div>
                </div>
            );
        }

        function BriefingPanel({ trip, onScoreUpdate }) {
            // --- Auto-briefing state ---
            var [wxData, setWxData] = useState(null);
            var [loadingWx, setLoadingWx] = useState(true);
            // Extended forecast from GFS MOS (>30h trips)
            var [mosData, setMosData] = useState({});   // { ICAO: mosObj }
            var [loadingMos, setLoadingMos] = useState(false);

            // --- AI Enhanced section state ---
            var [aiResult, setAiResult] = useState(null);
            var [aiLoading, setAiLoading] = useState(false);
            var [aiError, setAiError] = useState(null);
            var [apiKey, setApiKey] = useState("");
            var [showAI, setShowAI] = useState(false);
            var [aiFeedback, setAiFeedback] = useState(null); // 'up' | 'down'

            // --- Conversational AI Chat ---
            var [chatMessages, setChatMessages] = useState([]);
            var [chatInput, setChatInput] = useState('');
            var [chatLoading, setChatLoading] = useState(false);
            var chatEndRef = React.useRef(null);

            // --- Voice output ---
            var [speaking, setSpeaking] = useState(false);

            // --- Advisory data (SIGMETs, G-AIRMETs, CWAs, Winds Aloft) ---
            var [sigmets, setSigmets] = useState([]);
            var [gairmets, setGairmets] = useState([]);
            var [cwas, setCwas] = useState([]);
            var [windsAloft, setWindsAloft] = useState([]);
            var [loadingAdvisory, setLoadingAdvisory] = useState(true);

            var ac = AIRCRAFT.find(a => a.id === trip.aircraft) || AIRCRAFT[0];
            var allRoutePts = useMemo(() =>
                [trip.dep].concat(trip.wps || []).concat([trip.arr]),
                [trip.dep, trip.arr, JSON.stringify(trip.wps)]
            );

            // Trip departure time in UTC (estimated from local + lon-based timezone)
            var tripTargetUtc = useMemo(() => {
                var apt = getAirport(trip.dep);
                var depLon = apt ? apt.lon : -80;
                return getTripTargetUtc(trip, depLon);
            }, [trip.dep, trip.date, trip.time]);

            // Route distance and ETE (used in trip details card)
            var routeDist = useMemo(() => {
                var d = 0;
                for (var i = 0; i < allRoutePts.length - 1; i++) {
                    var p1 = getAirport(allRoutePts[i]);
                    var p2 = getAirport(allRoutePts[i + 1]);
                    if (p1 && p2) d += calcDist(p1.lat, p1.lon, p2.lat, p2.lon);
                }
                return Math.round(d);
            }, [allRoutePts]);

            var eteStr = useMemo(() => {
                if (!routeDist || !ac || !ac.kts) return '--';
                var h = routeDist / ac.kts;
                return Math.floor(h) + 'h ' + Math.round((h % 1) * 60) + 'm';
            }, [routeDist, ac]);

            // Hours from now until departure (negative = past/now)
            var hoursUntilTrip = useMemo(() => {
                if (!tripTargetUtc) return null;
                return (tripTargetUtc.getTime() - Date.now()) / 3600000;
            }, [tripTargetUtc]);

            // Auto-fetch weather for all waypoints on mount
            useEffect(() => {
                setLoadingWx(true);
                setWxData(null);
                Promise.all(allRoutePts.map(async icao => {
                    var [m, t] = await Promise.all([fetchLiveMetar(icao), fetchLiveTaf(icao)]).catch(() => [null, null]);
                    // If no live METAR (airport has no ASOS/AWOS), fall back to simulated weather
                    // so the briefing panel has something to display and analyze
                    var metarLive = !!m;
                    var metar = m || makeMetar(icao);
                    return { icao, metar, taf: t, metarLive };
                })).then(data => { setWxData(data); setLoadingWx(false); })
                  .catch(() => setLoadingWx(false));
            }, [allRoutePts.join(',')]);

            // Fetch GFS MOS extended forecast for all route points
            // Used for trips >30h out where TAF coverage ends
            useEffect(() => {
                setMosData({});
                setLoadingMos(true);
                Promise.all(allRoutePts.map(async icao => {
                    var mos = await fetchLiveMos(icao).catch(() => null);
                    return [icao, mos];
                })).then(entries => {
                    var result = {};
                    entries.forEach(([icao, mos]) => { if (mos) result[icao] = mos; });
                    setMosData(result);
                    setLoadingMos(false);
                }).catch(() => { setMosData({}); setLoadingMos(false); });
            }, [allRoutePts.join(',')]);

            // Fetch SIGMETs, G-AIRMETs, CWAs, and Winds Aloft once on mount
            useEffect(() => {
                setLoadingAdvisory(true);
                var aptPts = allRoutePts.map(getAirport).filter(Boolean);
                var bb = aptPts.length ? routeBboxFromPts(aptPts, 3) : null;
                // Pick wind region from midpoint longitude
                var midLon = aptPts.length ? aptPts.reduce(function(s,a){return s+a.lon;},0)/aptPts.length : -90;
                var region = windRegionForLon(midLon);
                Promise.all([fetchSigmets(), fetchGairmets(), fetchCwas(), fetchWindsAloft(region)])
                    .then(function(results) {
                        var rawSig = results[0], rawG = results[1], rawC = results[2], rawW = results[3];
                        if (bb) {
                            setSigmets(rawSig.filter(function(f) {
                                return f.geometry && geojsonPolyInBbox(f.geometry.coordinates, bb);
                            }));
                            setGairmets(rawG.filter(function(g) { return latLonPolyInBbox(g.area, bb); }));
                            setCwas(rawC.filter(function(c) { return cwaPolyInBbox(c.polygon, bb); }));
                        } else {
                            setSigmets(rawSig);
                            setGairmets(rawG);
                            setCwas(rawC);
                        }
                        setWindsAloft(rawW);
                        setLoadingAdvisory(false);
                    }).catch(function() { setLoadingAdvisory(false); });
            }, [allRoutePts.join(',')]);

            // Effective weather per station resolved to the trip departure time:
            //   • METAR  — trip is now/within 2 h, or no forecast data available
            //   • TAF    — trip is 2–30 h away; extract the forecast period at departure
            //   • MOS    — trip is >30 h away; use GFS MOS 6-hourly model forecast
            var effectiveWxData = useMemo(() => {
                if (!wxData) return null;
                var hh = tripTargetUtc ? String(tripTargetUtc.getUTCHours()).padStart(2, '0') : '';
                var mm = tripTargetUtc ? String(tripTargetUtc.getUTCMinutes()).padStart(2, '0') : '';
                return wxData.map(w => {
                    // Label suffix when METAR is simulated (no live ASOS/AWOS at this airport)
                    var simSuffix = w.metarLive ? '' : ' (sim)';
                    if (hoursUntilTrip !== null && hoursUntilTrip > 2 && tripTargetUtc) {
                        if (hoursUntilTrip > 30) {
                            // Try GFS MOS first for extended range
                            var mosObj = mosData[w.icao];
                            if (mosObj) {
                                var mosPeriod = parseMosForTime(mosObj, tripTargetUtc);
                                if (mosPeriod) {
                                    var mosWx = buildMosWx(mosPeriod, w.icao);
                                    if (mosWx) return { ...w, effectiveWx: mosWx, source: 'mos', sourceLabel: 'GFS Fcst' };
                                }
                            }
                            // MOS unavailable — fall back to current METAR with note
                            return { ...w, effectiveWx: w.metar, source: 'metar', sourceLabel: 'METAR (no model)' + simSuffix };
                        }
                        // 2–30 h: TAF preferred, GFS MOS fallback (for airports with no TAF), then METAR
                        if (w.taf) {
                            var tafWx = parseTafForTime(w.taf, tripTargetUtc);
                            if (tafWx) {
                                var tafLbl = w.taf._nearbyStation
                                    ? `TAF ${w.taf._nearbyStation} ${hh}${mm}Z`
                                    : `TAF ${hh}${mm}Z`;
                                return { ...w, effectiveWx: tafWx, source: 'taf', sourceLabel: tafLbl };
                            }
                        }
                        var mosObj2 = mosData[w.icao];
                        if (mosObj2) {
                            var mosPeriod2 = parseMosForTime(mosObj2, tripTargetUtc);
                            if (mosPeriod2) {
                                var mosWx2 = buildMosWx(mosPeriod2, w.icao);
                                if (mosWx2) return { ...w, effectiveWx: mosWx2, source: 'mos', sourceLabel: 'GFS Fcst' };
                            }
                        }
                        return { ...w, effectiveWx: w.metar, source: 'metar', sourceLabel: 'METAR (no fcst)' + simSuffix };
                    }
                    // Trip is current/imminent — live METAR is the best data
                    return { ...w, effectiveWx: w.metar, source: 'metar', sourceLabel: 'METAR' + simSuffix };
                });
            }, [wxData, mosData, tripTargetUtc, hoursUntilTrip]);

            // --- Helpers ---
            function parseCeiling(sky) {
                if (!sky) return null;
                var min = Infinity;
                sky.split(' ').forEach(p => {
                    var m = p.match(/^(BKN|OVC)(\d{3})/);
                    if (m) min = Math.min(min, parseInt(m[2]) * 100);
                });
                return min === Infinity ? null : min;
            }
            function parseGust(windStr) {
                var m = windStr ? windStr.match(/G(\d+)KT/) : null;
                return m ? parseInt(m[1]) : null;
            }
            function parseTempC(tempStr) {
                if (!tempStr) return null;
                var m = tempStr.match(/^(M?)(\d+)\//);
                if (!m) return null;
                return m[1] === 'M' ? -parseInt(m[2]) : parseInt(m[2]);
            }
            function catColor(cat) {
                return { VFR: 'var(--cat-vfr-color)', MVFR: 'var(--cat-mvfr-color)', IFR: 'var(--cat-ifr-color)', LIFR: 'var(--cat-lifr-color)' }[cat] || 'var(--md-sys-color-on-surface-variant)';
            }

            // --- Auto analysis (time-aware: METAR → TAF → GFS MOS as horizon extends) ---
            var analysis = useMemo(() => {
                if (!effectiveWxData) return null;

                var isFutureFlight = hoursUntilTrip !== null && hoursUntilTrip > 2;
                var anyTaf = effectiveWxData.some(e => e.source === 'taf');
                var anyMos = effectiveWxData.some(e => e.source === 'mos');
                var allMos  = effectiveWxData.every(e => e.source === 'mos');
                var anySim  = effectiveWxData.some(e => !e.metarLive);
                var depUtcLabel = tripTargetUtc
                    ? `${String(tripTargetUtc.getUTCHours()).padStart(2,'0')}${String(tripTargetUtc.getUTCMinutes()).padStart(2,'0')}Z ${trip.date}`
                    : trip.date;

                // Build a human-readable description of the data sources used
                var dataContext = allMos   ? `GFS model forecast · ${depUtcLabel}`
                    : anyMos   ? `GFS/TAF mixed forecast · ${depUtcLabel}`
                    : anyTaf   ? `TAF forecast · ${depUtcLabel}`
                    : isFutureFlight ? `current METAR (no forecast available · ${depUtcLabel})`
                    : anySim ? 'current METAR (⚠ some stations simulated — no live ASOS/AWOS)'
                    : 'current METAR';

                var cats = effectiveWxData.filter(e => e.effectiveWx).map(e => e.effectiveWx.cat);
                var hasLIFR = cats.some(c => c === 'LIFR');
                var hasIFR  = cats.some(c => c === 'IFR');
                var hasMVFR = cats.some(c => c === 'MVFR');

                // Source qualifier for verdict text
                var srcQual = anyMos ? 'GFS model forecasts'
                    : anyTaf ? 'TAF forecasts'
                    : isFutureFlight ? 'METAR shows'
                    : 'METAR reports';

                var verdict, verdictColor, verdictBg, verdictIcon, verdictDesc;
                if (hasLIFR) {
                    verdict = 'NO-GO'; verdictColor = 'var(--cat-lifr-color)'; verdictBg = 'var(--cat-lifr-bg)';
                    verdictIcon = 'cancel';
                    verdictDesc = `${srcQual} LIFR at one or more stations (${dataContext}) — flight not recommended.`;
                } else if (hasIFR) {
                    verdict = 'NO-GO'; verdictColor = 'var(--cat-ifr-color)'; verdictBg = 'var(--cat-ifr-bg)';
                    verdictIcon = 'cancel';
                    verdictDesc = `${srcQual} IFR conditions en route (${dataContext}) — instrument currency required.`;
                } else if (hasMVFR) {
                    verdict = 'CAUTION'; verdictColor = 'var(--cat-mvfr-color)'; verdictBg = 'var(--cat-mvfr-bg)';
                    verdictIcon = 'warning';
                    verdictDesc = `${srcQual} Marginal VFR along the route (${dataContext}) — monitor closely before departure.`;
                } else {
                    verdict = 'GO'; verdictColor = 'var(--cat-vfr-color)'; verdictBg = 'var(--cat-vfr-bg)';
                    verdictIcon = 'check_circle';
                    verdictDesc = `${srcQual} VFR at all stations (${dataContext}) — conditions appear favorable.`;
                }

                var concerns = [];

                // ── MOS/forecast coverage warnings (very long-range only) ───────────
                if (isFutureFlight) {
                    effectiveWxData.forEach(e => {
                        if (e.source === 'metar' && hoursUntilTrip > 30) {
                            concerns.push({ level: 'medium', icon: 'update', text: `${e.icao}: GFS MOS forecast unavailable — showing current METAR only (beyond TAF range)` });
                        }
                        // "No TAF" is already shown in the weather source label — omit from Key Concerns
                    });
                }

                // ── Simulated-data warning (no ASOS/AWOS at airport) ────────────────
                effectiveWxData.forEach(e => {
                    if (!e.metarLive) {
                        concerns.push({ level: 'medium', icon: 'sensors_off', text: `${e.icao}: No live weather station — conditions are estimated. Call FSS or check 1800wxbrief.com before departure.` });
                    }
                });

                // ── Per-station weather concerns ─────────────────────────────────────
                effectiveWxData.forEach(e => {
                    var src = e.source === 'mos' ? 'GFS' : e.source === 'taf' ? 'TAF' : 'METAR';
                    if (!e.effectiveWx) {
                        concerns.push({ level: 'medium', icon: 'cloud_off', text: `${e.icao}: No weather data available — verify conditions before flight` });
                        return;
                    }
                    var m = e.effectiveWx;

                    // MOS-specific probabilistic concerns
                    if (e.source === 'mos') {
                        var t06 = m.t06 || 0, p06 = m.p06 || 0;
                        if (t06 >= 20) concerns.push({ level: t06 >= 40 ? 'high' : 'medium', icon: 'thunderstorm', text: `${e.icao}: GFS model shows ${t06}% thunderstorm probability at departure time` });
                        if (p06 >= 40) concerns.push({ level: p06 >= 70 ? 'high' : 'medium', icon: 'water_drop', text: `${e.icao}: GFS model shows ${p06}% precipitation probability at departure time` });
                        var obvLabels = { F: 'fog', PF: 'patchy fog', BS: 'blowing snow', BD: 'blowing dust', HZ: 'haze', K: 'smoke' };
                        if (m.obv && m.obv !== 'N' && obvLabels[m.obv]) {
                            concerns.push({ level: 'medium', icon: 'visibility', text: `${e.icao}: GFS model forecasts ${obvLabels[m.obv]} (${m.obv}) — expect reduced visibility` });
                        }
                    }

                    // TS/CB (METAR and TAF)
                    if (e.source !== 'mos' && ((m.raw || '').includes(' TS') || m.sky.includes('CB') || (e.taf && (e.taf.rawTAF || '').includes(' TS')))) {
                        concerns.push({ level: 'high', icon: 'thunderstorm', text: `${e.icao}: ${src} indicates thunderstorm activity — check convective SIGMETs` });
                    }

                    // Ceiling
                    var ceiling = parseCeiling(m.sky);
                    if (ceiling !== null && ceiling < 1000) {
                        concerns.push({ level: 'high', icon: 'cloud', text: `${e.icao}: ${src} ceiling ${ceiling}ft — IFR conditions forecast (${m.sky})` });
                    } else if (ceiling !== null && ceiling < 3000) {
                        concerns.push({ level: 'medium', icon: 'cloud', text: `${e.icao}: ${src} ceiling ${ceiling}ft — MVFR, monitor for deterioration` });
                    }

                    // Visibility
                    if (!m.vis.includes('P6') && !m.vis.startsWith('10')) {
                        var visNum = parseFloat(m.vis) || 10;
                        if (visNum < 1) concerns.push({ level: 'high', icon: 'visibility_off', text: `${e.icao}: ${src} visibility ${m.vis} — very low, LIFR/IFR conditions` });
                        else if (visNum < 3) concerns.push({ level: 'medium', icon: 'visibility', text: `${e.icao}: ${src} visibility ${m.vis} — reduced` });
                    }

                    // Wind
                    var gust = parseGust(m.wind);
                    if (m.wspd > 20 || (gust && gust > 25)) {
                        concerns.push({ level: 'high', icon: 'air', text: `${e.icao}: ${src} strong winds ${m.wind}` });
                    } else if (m.wspd > 15 || (gust && gust > 20)) {
                        concerns.push({ level: 'medium', icon: 'air', text: `${e.icao}: ${src} gusty conditions ${m.wind}` });
                    }

                    // Crosswind (not available for MOS — wind direction is less precise)
                    if (e.source !== 'mos') {
                        var apt = getAirport(e.icao);
                        var rwyRec = getRunwayRecommendation(m, apt);
                        if (rwyRec && rwyRec.crosswind > 15) {
                            concerns.push({ level: 'high', icon: 'flight_takeoff', text: `${e.icao}: ${src} high crosswind ${rwyRec.crosswind}kt on Rwy ${rwyRec.rwy}` });
                        } else if (rwyRec && rwyRec.crosswind > 10) {
                            concerns.push({ level: 'medium', icon: 'flight_takeoff', text: `${e.icao}: ${src} crosswind ${rwyRec.crosswind}kt on Rwy ${rwyRec.rwy}` });
                        }
                    }

                    // Freezing temps (METAR only)
                    if (e.source === 'metar' && e.metar) {
                        var tempC = parseTempC(e.metar.temp);
                        if (tempC !== null && tempC <= 2) {
                            concerns.push({ level: 'medium', icon: 'ac_unit', text: `${e.icao}: Current temp near/below freezing — ${e.metar.temp}` });
                        }
                    }
                });
                concerns.sort((a, b) => (a.level === 'high' ? 0 : 1) - (b.level === 'high' ? 0 : 1));

                var recs = [];
                // Model forecast disclaimer (highest priority for long-range)
                if (anyMos) {
                    recs.push(`⚠ Based on GFS model data (${depUtcLabel}) — model accuracy decreases with time. Re-evaluate using TAF data 24h before departure.`);
                } else if (isFutureFlight && anyTaf) {
                    recs.push(`Assessment based on TAF forecast for ${depUtcLabel} — conditions may change. Re-check closer to departure.`);
                }
                if (hasIFR || hasLIFR) recs.push('IFR rating and current instrument currency required for this flight.');
                if (hasMVFR && !hasIFR && !hasLIFR) recs.push('Consider filing IFR or delaying departure until conditions improve to VFR.');
                if (concerns.some(c => c.icon === 'thunderstorm')) recs.push('Check convective SIGMETs and avoid areas with reported thunderstorm activity.');
                if (concerns.some(c => c.icon === 'water_drop')) recs.push('GFS indicates precipitation — review AIRMETs for IFR/turbulence and check PIREPs.');
                if (concerns.some(c => c.icon === 'ac_unit')) recs.push('Check PIREPs for airframe icing; confirm aircraft icing certification if applicable.');
                if (concerns.some(c => c.level === 'high' && c.icon === 'air')) recs.push('Verify crosswind does not exceed aircraft published limits; identify an alternate airport.');
                if (anySim) recs.push('⚠ One or more airports have no automated weather station. Contact FSS (1-800-WX-BRIEF) or check notam.faa.gov for current conditions at those fields.');
                if (recs.filter(r => !r.startsWith('⚠')).length === 0) recs.push('Conditions appear favorable — complete standard preflight checks and file a flight plan.');
                recs.push('Always obtain an official briefing at 1800wxbrief.com before departure.');

                return { verdict, verdictColor, verdictBg, verdictIcon, verdictDesc, concerns, recs, dataContext, isFutureFlight, anyTaf, anyMos, allMos };
            }, [effectiveWxData, hoursUntilTrip, tripTargetUtc]);

            // --- Composite Safety Score breakdown ---
            var detailedScore = useMemo(function() {
                if (!effectiveWxData) return null;
                return calcDetailedScore(effectiveWxData, routeDist);
            }, [effectiveWxData, routeDist]);

            // Propagate the authoritative score up to the trip header ring
            useEffect(function() {
                if (detailedScore && onScoreUpdate) onScoreUpdate(detailedScore.total);
            }, [detailedScore && detailedScore.total]);

            // finalVerdict: convective SIGMET or CWA thunderstorm overrides weather-based verdict
            var finalVerdict = useMemo(function() {
                if (!analysis) return null;
                var hasConvSigmet = sigmets.some(function(f) {
                    var h = ((f.properties || {}).hazard || '').toUpperCase();
                    return h === 'CONVECTIVE';
                });
                var hasCwaTstorm = cwas.some(function(c) {
                    return (c.hazard || '').toUpperCase() === 'TS';
                });
                if (hasConvSigmet || hasCwaTstorm) {
                    return {
                        verdict: 'NO-GO',
                        verdictColor: 'var(--cat-lifr-color)',
                        verdictBg: 'var(--cat-lifr-bg)',
                        verdictIcon: 'thunderstorm',
                        verdictDesc: hasConvSigmet
                            ? 'Active Convective SIGMET along route — VFR flight strongly discouraged. Obtain official briefing.'
                            : 'Active Center Weather Advisory for thunderstorms along route — conditions hazardous.',
                        concerns: analysis.concerns,
                        recs: ['⚠ Active convective hazard advisory detected. Do not depart VFR into areas of reported convective activity.'].concat(analysis.recs),
                        dataContext: analysis.dataContext,
                        isFutureFlight: analysis.isFutureFlight,
                        anyTaf: analysis.anyTaf,
                        anyMos: analysis.anyMos,
                        allMos: analysis.allMos
                    };
                }
                return analysis;
            }, [analysis, sigmets, cwas]);

            // Auto-scroll chat to bottom on new messages
            useEffect(function() {
                if (chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
            }, [chatMessages]);

            // --- AI Enhanced briefing ---
            var runAiBriefing = useCallback(async function() {
                if (!trip.dep || !trip.arr || !wxData) return;
                setAiLoading(true); setAiError(null);

                var distance = 0;
                for (var i = 0; i < allRoutePts.length - 1; i++) {
                    var p1 = getAirport(allRoutePts[i]);
                    var p2 = getAirport(allRoutePts[i+1]);
                    if (p1 && p2) distance += calcDist(p1.lat, p1.lon, p2.lat, p2.lon);
                }
                var ete = distance / ac.kts;

                var wxLines = wxData.map(w => {
                    var lines = [];
                    if (w.metar) lines.push(`METAR ${w.icao}: ${w.metar.raw}`);
                    if (w.taf && w.taf.rawTAF) lines.push(`TAF ${w.icao}: ${w.taf.rawTAF}`);
                    return lines.join("\n");
                }).join("\n");

                var scoreCtx = detailedScore
                    ? ('Automated Safety Score: ' + detailedScore.total + '/100 — ' + detailedScore.breakdown.map(function(f) { return f.label + ' ' + f.score + '/' + f.max; }).join(', ') + '\n')
                    : '';

                // Build advisory context for AI prompt
                var advisoryCtx = '';
                if (sigmets.length) {
                    advisoryCtx += '\n=== ACTIVE SIGMETS (' + sigmets.length + ') ===\n';
                    sigmets.forEach(function(f) {
                        var p = f.properties || {};
                        advisoryCtx += (p.rawAirSigmet || ('SIGMET · ' + (p.hazard||'') + (p.severity?' SEV:'+p.severity:''))) + '\n';
                    });
                }
                if (gairmets.length) {
                    advisoryCtx += '\n=== ACTIVE AIRMETS (' + gairmets.length + ') ===\n';
                    gairmets.forEach(function(g) {
                        advisoryCtx += 'AIRMET ' + (g.tag||'') + ' · ' + (g.hazard||'') + (g.severity?' '+g.severity:'') + ' Valid:' + (g.validTime||'') + '\n';
                    });
                }
                if (cwas.length) {
                    advisoryCtx += '\n=== ACTIVE CWAs (' + cwas.length + ') ===\n';
                    cwas.forEach(function(c) {
                        advisoryCtx += (c.rawCWA || ('CWA · ' + (c.cwsuId||'') + ' · ' + (c.hazard||''))) + '\n';
                    });
                }
                if (windsAloft.length) {
                    var aptPtsAi = allRoutePts.map(getAirport).filter(Boolean);
                    var altFt = ac.alt || 6000;
                    var windLines = aptPtsAi.map(function(apt) {
                        var stn = closestWindStation(windsAloft, apt.lat, apt.lon);
                        var w = stn ? getWindAtAlt(stn, altFt) : null;
                        if (!w) return null;
                        return apt.icao + ' @ ' + (altFt/1000).toFixed(0) + 'kft: ' + (w.lv ? 'LGT&VRB' : w.wdir+'°@'+w.wspd+'kt') + (w.temp!=null?' '+w.temp+'°C':'');
                    }).filter(Boolean);
                    if (windLines.length) advisoryCtx += '\n=== WINDS ALOFT ===\n' + windLines.join('\n') + '\n';
                }

                var prompt = `TRIP: ${ac.name} (${ac.cat}) cruise ${ac.kts}kt\n` +
                    `DEPARTURE: ${trip.date} at ${trip.time} Local Time\n` +
                    `ROUTE: ${allRoutePts.join(" -> ")}\n` +
                    `Distance: ${Math.round(distance)}nm  ETE: ${Math.floor(ete)}h${Math.round((ete % 1) * 60)}m\n` +
                    scoreCtx +
                    `\n=== LIVE WEATHER DATA ===\n${wxLines || "No live weather available."}` +
                    advisoryCtx;

                const url = "https://api.anthropic.com/v1/messages";
                const payload = {
                    model: "claude-sonnet-4-6",
                    max_tokens: 1800,
                    system: "You are an expert aviation weather analyst (CFI-I level) providing a detailed pre-flight briefing. Be specific with numbers — cite thresholds (e.g., 'ceiling 1200ft OVC = MVFR', 'winds 18G25KT = moderate crosswind risk'). For high-elevation airports, estimate density altitude (DA ≈ Elevation + 120 × (OAT_°C − ISA_°C)). Flag icing risk, convective activity, TFRs, and airspace concerns. Use concise bullet points. Provide the briefing using EXACTLY these headers on their own lines (with ** markers): **GO/NO-GO RECOMMENDATION**, **WEATHER SYNOPSIS**, **DEPARTURE WINDOW**, **EN ROUTE HAZARDS**, **RUNWAY ANALYSIS**, **NOTAM IMPACT**, **ALTERNATE RECOMMENDATIONS**, **FREQUENCY GUIDE**",
                    messages: [{ role: "user", content: prompt }]
                };

                const fetchWithRetry = async (retries = 3) => {
                    const delays = [1000, 2000, 4000];
                    for (let i = 0; i <= retries; i++) {
                        try {
                            const response = await fetch(url, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "x-api-key": apiKey,
                                    "anthropic-version": "2023-06-01",
                                    "anthropic-dangerous-direct-browser-access": "true"
                                },
                                body: JSON.stringify(payload)
                            });
                            if (!response.ok) {
                                const errBody = await response.json().catch(() => ({}));
                                throw new Error(errBody?.error?.message || `HTTP ${response.status}`);
                            }
                            const data = await response.json();
                            const text = data.content?.[0]?.text;
                            if (!text) throw new Error("Empty response from Claude");
                            return text;
                        } catch (err) {
                            if (i === retries) throw err;
                            await new Promise(r => setTimeout(r, delays[i]));
                        }
                    }
                };

                try {
                    setAiResult(await fetchWithRetry());
                } catch (e) {
                    setAiError("Briefing failed: " + (e.message || "Please check your API key and try again."));
                } finally {
                    setAiLoading(false);
                }
            }, [trip, apiKey, wxData, detailedScore]);

            // --- Conversational AI Chat ---
            var sendChat = useCallback(async function() {
                if (!chatInput.trim() || !apiKey || chatLoading) return;
                var userMsg = chatInput.trim();
                setChatInput('');
                var updated = [...chatMessages, { role: 'user', content: userMsg }];
                setChatMessages(updated);
                setChatLoading(true);
                var wxSummary = effectiveWxData ? effectiveWxData.map(function(e) {
                    var wx = e.effectiveWx;
                    return wx ? (e.icao + ': ' + wx.cat + ' wind=' + wx.wind + ' vis=' + wx.vis + ' sky=' + wx.sky) : (e.icao + ': no data');
                }).join('; ') : 'No weather data';
                var systemCtx = 'You are an aviation weather analyst assistant for a specific flight. ' +
                    'Flight: ' + ac.name + ' (' + ac.cat + ') ' + allRoutePts.join('→') + ' on ' + trip.date + ' at ' + trip.time + '. ' +
                    'Safety score: ' + (detailedScore ? detailedScore.total + '/100' : 'N/A') + '. ' +
                    'Current weather: ' + wxSummary + '. ' +
                    'Answer concisely and specifically about this flight. Always recommend consulting official sources before flight.';
                try {
                    var res = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: { 'Content-Type':'application/json', 'x-api-key':apiKey, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
                        body: JSON.stringify({ model:'claude-sonnet-4-6', max_tokens:600, system:systemCtx, messages: updated.map(function(m) { return { role:m.role, content:m.content }; }) })
                    });
                    var data = await res.json();
                    var reply = data.content?.[0]?.text || 'No response.';
                    setChatMessages(function(prev) { return [...prev, { role:'assistant', content:reply }]; });
                } catch(e) {
                    setChatMessages(function(prev) { return [...prev, { role:'assistant', content:'Error: ' + e.message }]; });
                } finally { setChatLoading(false); }
            }, [chatInput, chatMessages, apiKey, effectiveWxData, trip, allRoutePts, ac, chatLoading, detailedScore]);

            // --- Voice output (Text-to-Speech) ---
            function speakBriefing() {
                if (!window.speechSynthesis) return;
                if (speaking) { window.speechSynthesis.cancel(); setSpeaking(false); return; }
                var text = aiResult ? aiResult.replace(/\*\*/g, '').replace(/\*/g, '') : (analysis ? (analysis.verdict + '. ' + analysis.verdictDesc + '. ' + analysis.recs.join('. ')) : 'No briefing available.');
                var utt = new SpeechSynthesisUtterance(text);
                utt.rate = 0.95; utt.pitch = 1; utt.volume = 1;
                utt.onend = function() { setSpeaking(false); };
                utt.onerror = function() { setSpeaking(false); };
                setSpeaking(true);
                window.speechSynthesis.speak(utt);
            }

            var aiSections = useMemo(() => {
                if (!aiResult) return [];
                var out = []; var current = null;
                var validHeaders = ["GO/NO-GO RECOMMENDATION", "WEATHER SYNOPSIS", "DEPARTURE WINDOW", "EN ROUTE HAZARDS", "RUNWAY ANALYSIS", "NOTAM IMPACT", "ALTERNATE RECOMMENDATIONS", "FREQUENCY GUIDE"];
                aiResult.split("\n").forEach(line => {
                    var cleanLine = line.replace(/\*/g, "").trim();
                    if (validHeaders.includes(cleanLine)) {
                        if (current) out.push(current);
                        current = { title: cleanLine, body: "" };
                    } else if (current) {
                        current.body += line + "\n";
                    }
                });
                if (current) out.push(current);
                return out;
            }, [aiResult]);

            var sectionMeta = {
                "GO/NO-GO RECOMMENDATION": { icon: "check_circle", color: "var(--md-sys-color-primary)", bg: "var(--md-sys-color-primary-container)", onBg: "var(--md-sys-color-on-primary-container)" },
                "WEATHER SYNOPSIS": { icon: "routine", color: "var(--md-sys-color-secondary)" },
                "DEPARTURE WINDOW": { icon: "schedule", color: "var(--md-sys-color-tertiary)" },
                "EN ROUTE HAZARDS": { icon: "warning", color: "var(--md-sys-color-error)" },
                "RUNWAY ANALYSIS": { icon: "flight_takeoff", color: "var(--md-sys-color-primary)" },
                "NOTAM IMPACT": { icon: "report", color: "var(--md-sys-color-warning)" },
                "ALTERNATE RECOMMENDATIONS": { icon: "alt_route", color: "var(--md-sys-color-tertiary)" },
                "FREQUENCY GUIDE": { icon: "podcasts", color: "var(--md-sys-color-secondary)" }
            };

            var levelColor = { high: 'var(--md-sys-color-error)', medium: 'var(--cat-mvfr-color)' };

            return (
                <div style={{ paddingBottom: 32 }}>

                    {/* ---- Loading state ---- */}
                    {loadingWx && (
                        <div style={{ textAlign: 'center', padding: '48px 24px', color: 'var(--md-sys-color-on-surface-variant)' }}>
                            <MdIcon name="sync" style={{ fontSize: 40, animation: 'spin 1s linear infinite', marginBottom: 12, display: 'block' }} />
                            <div style={{ fontSize: 14 }}>Fetching live weather from AviationWeather.gov…</div>
                        </div>
                    )}

                    {/* Extended forecast loading indicator */}
                    {!loadingWx && loadingMos && hoursUntilTrip !== null && hoursUntilTrip > 30 && (
                        <div style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '10px 14px', background: 'var(--md-sys-color-surface-container)', borderRadius: 12, marginBottom: 12, fontSize: 13, color: 'var(--md-sys-color-on-surface-variant)' }}>
                            <MdIcon name="sync" style={{ fontSize: 17, animation: 'spin 1s linear infinite', flexShrink: 0 }} />
                            <span>Loading GFS model forecast for departure date…</span>
                        </div>
                    )}

                    {/* ---- Auto briefing ---- */}
                    {effectiveWxData && analysis && finalVerdict && (
                        <>
                            {/* Trip Details card */}
                            <div style={{ background: 'var(--md-sys-color-surface-container)', borderRadius: 16, padding: '16px 20px', marginBottom: 16 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
                                    <MdIcon name="flight" style={{ color: 'var(--md-sys-color-primary)', fontSize: 18, transform: 'rotate(45deg)' }} />
                                    <span style={{ fontWeight: 700, fontSize: 13, textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--md-sys-color-primary)' }}>Trip Details</span>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px 20px' }}>
                                    <div>
                                        <div style={{ fontSize: 10, fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--md-sys-color-on-surface-variant)', marginBottom: 2 }}>Route</div>
                                        <div className="font-mono" style={{ fontSize: 15, fontWeight: 700, color: 'var(--md-sys-color-on-surface)' }}>{allRoutePts.join(' \u2794 ')}</div>
                                        {allRoutePts.length <= 2 && (
                                            <div style={{ fontSize: 11, color: 'var(--md-sys-color-on-surface-variant)' }}>
                                                {(getAirport(allRoutePts[0]) || {}).city || allRoutePts[0]}
                                                {' \u2192 '}
                                                {(getAirport(allRoutePts[allRoutePts.length - 1]) || {}).city || allRoutePts[allRoutePts.length - 1]}
                                            </div>
                                        )}
                                    </div>
                                    <div>
                                        <div style={{ fontSize: 10, fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--md-sys-color-on-surface-variant)', marginBottom: 2 }}>Aircraft</div>
                                        <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--md-sys-color-on-surface)' }}>{ac.name}</div>
                                        <div style={{ fontSize: 11, color: 'var(--md-sys-color-on-surface-variant)' }}>{ac.cat} · {ac.kts} kts cruise</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: 10, fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--md-sys-color-on-surface-variant)', marginBottom: 2 }}>Departure</div>
                                        <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--md-sys-color-on-surface)' }}>{trip.date}</div>
                                        <div style={{ fontSize: 11, color: 'var(--md-sys-color-on-surface-variant)' }}>
                                            {trip.time} local
                                            {tripTargetUtc && (
                                                <span className="font-mono"> · {String(tripTargetUtc.getUTCHours()).padStart(2,'0')}{String(tripTargetUtc.getUTCMinutes()).padStart(2,'0')}Z</span>
                                            )}
                                        </div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: 10, fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--md-sys-color-on-surface-variant)', marginBottom: 2 }}>Distance / ETE</div>
                                        <div className="font-mono" style={{ fontSize: 13, fontWeight: 600, color: 'var(--md-sys-color-on-surface)' }}>{routeDist} NM</div>
                                        <div style={{ fontSize: 11, color: 'var(--md-sys-color-on-surface-variant)' }}>{eteStr} at cruise</div>
                                    </div>
                                </div>
                            </div>

                            {/* Composite Safety Score Breakdown */}
                            {detailedScore && <ScoreBreakdown breakdown={detailedScore.breakdown} total={detailedScore.total} />}

                            {/* Active Hazard Advisories (SIGMETs / AIRMETs / CWAs) */}
                            <HazardAdvisories sigmets={sigmets} gairmets={gairmets} cwas={cwas} loading={loadingAdvisory} />

                            {/* Winds Aloft card */}
                            <WindsAloftCard allRoutePts={allRoutePts} stations={windsAloft} cruiseAlt={ac.alt || 6000} />

                            {/* Go/No-Go banner — uses finalVerdict (may be overridden by convective SIGMET) */}
                            <div style={{ background: finalVerdict.verdictBg, borderRadius: 16, padding: '20px 24px', marginBottom: 16, display: 'flex', alignItems: 'center', gap: 16 }}>
                                <MdIcon name={finalVerdict.verdictIcon} style={{ fontSize: 44, color: finalVerdict.verdictColor, flexShrink: 0 }} />
                                <div>
                                    <div style={{ fontSize: 11, fontWeight: 700, textTransform: 'uppercase', letterSpacing: '1px', color: finalVerdict.verdictColor, opacity: 0.75, marginBottom: 2 }}>Go/No-Go Assessment</div>
                                    <div style={{ fontSize: 30, fontWeight: 800, color: finalVerdict.verdictColor, fontFamily: 'monospace', lineHeight: 1 }}>{finalVerdict.verdict}</div>
                                    <div style={{ fontSize: 13, color: finalVerdict.verdictColor, opacity: 0.85, marginTop: 4, lineHeight: 1.4 }}>{finalVerdict.verdictDesc}</div>
                                </div>
                            </div>

                            {/* Route weather table */}
                            <div style={{ background: 'var(--md-sys-color-surface-container)', borderRadius: 16, padding: '16px', marginBottom: 16 }}>
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 8, marginBottom: 12, flexWrap: 'wrap' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                        <MdIcon name="routine" style={{ color: 'var(--md-sys-color-secondary)', fontSize: 18 }} />
                                        <span style={{ fontWeight: 700, fontSize: 13, textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--md-sys-color-secondary)' }}>Route Weather Summary</span>
                                    </div>
                                    {finalVerdict && finalVerdict.isFutureFlight && (
                                        <span style={{ fontSize: 10, fontWeight: 700,
                                            color: finalVerdict.anyMos ? 'var(--md-sys-color-on-tertiary-container)' : 'var(--md-sys-color-primary)',
                                            background: finalVerdict.anyMos ? 'var(--md-sys-color-tertiary-container)' : 'var(--md-sys-color-primary-container)',
                                            borderRadius: 4, padding: '2px 6px', letterSpacing: '0.5px', textTransform: 'uppercase' }}>
                                            {finalVerdict.anyMos ? 'GFS MODEL' : finalVerdict.anyTaf ? 'TAF FORECAST' : 'FUTURE TRIP'}
                                        </span>
                                    )}
                                </div>
                                {effectiveWxData.map((e, idx) => {
                                    var roleLabel = idx === 0 ? 'DEP' : idx === effectiveWxData.length - 1 ? 'ARR' : 'WPT';
                                    var apt = getAirport(e.icao);
                                    var wx = e.effectiveWx;
                                    var rwyRec = wx ? getRunwayRecommendation(wx, apt) : null;
                                    return (
                                        <div key={e.icao} style={{ display: 'grid', gridTemplateColumns: '40px 1fr auto', gap: '6px 12px', padding: '10px 0', borderBottom: idx < effectiveWxData.length - 1 ? '1px solid var(--md-sys-color-outline-variant)' : 'none', alignItems: 'center' }}>
                                            <span style={{ fontSize: 9, fontWeight: 700, color: 'var(--md-sys-color-on-surface-variant)', textTransform: 'uppercase', background: 'var(--md-sys-color-surface-container-high)', borderRadius: 4, padding: '2px 4px', textAlign: 'center', letterSpacing: '0.5px' }}>{roleLabel}</span>
                                            <div>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 2, flexWrap: 'wrap' }}>
                                                    <span className="font-mono" style={{ fontWeight: 700, fontSize: 14 }}>{e.icao}</span>
                                                    {wx && <span style={{ fontSize: 11, fontWeight: 700, color: catColor(wx.cat) }}>{wx.cat}</span>}
                                                    {!wx && <span style={{ fontSize: 11, color: 'var(--md-sys-color-on-surface-variant)' }}>No data</span>}
                                                    <span style={{ fontSize: 9, fontWeight: 600,
                                                        color: e.source === 'mos' ? 'var(--md-sys-color-on-tertiary-container)' : e.source === 'taf' ? 'var(--md-sys-color-primary)' : 'var(--md-sys-color-on-surface-variant)',
                                                        background: e.source === 'mos' ? 'var(--md-sys-color-tertiary-container)' : e.source === 'taf' ? 'var(--md-sys-color-primary-container)' : 'var(--md-sys-color-surface-container-high)',
                                                        borderRadius: 3, padding: '1px 5px', letterSpacing: '0.3px', textTransform: 'uppercase' }}>{e.sourceLabel}</span>
                                                </div>
                                                {wx && (
                                                    <div className="font-mono" style={{ fontSize: 11, color: 'var(--md-sys-color-on-surface-variant)', lineHeight: 1.5 }}>
                                                        {wx.wind} &middot; {wx.vis} &middot; {wx.sky}
                                                        {rwyRec && <span> &middot; Rwy <span style={{ color: 'var(--md-sys-color-primary)', fontWeight: 600 }}>{rwyRec.rwy}</span> xwind <span style={{ color: rwyRec.crosswind > 15 ? 'var(--md-sys-color-error)' : rwyRec.crosswind > 10 ? 'var(--cat-mvfr-color)' : 'var(--md-sys-color-primary)', fontWeight: 600 }}>{rwyRec.crosswind}kt</span></span>}
                                                    </div>
                                                )}
                                            </div>
                                            {wx && <CatBadge cat={wx.cat} />}
                                        </div>
                                    );
                                })}
                            </div>

                            {/* Key concerns — always shown; positive message when conditions are clear */}
                            <div style={{ background: 'var(--md-sys-color-surface-container)', borderRadius: 16, padding: 16, marginBottom: 16 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
                                    <MdIcon name={finalVerdict.concerns.length > 0 ? 'warning' : 'check_circle'}
                                        style={{ color: finalVerdict.concerns.length > 0 ? 'var(--md-sys-color-error)' : 'var(--cat-vfr-color)', fontSize: 18 }} />
                                    <span style={{ fontWeight: 700, fontSize: 13, textTransform: 'uppercase', letterSpacing: '0.5px',
                                        color: finalVerdict.concerns.length > 0 ? 'var(--md-sys-color-error)' : 'var(--cat-vfr-color)' }}>Key Concerns</span>
                                </div>
                                {finalVerdict.concerns.length === 0 ? (
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                        <MdIcon name="check_circle" style={{ fontSize: 17, color: 'var(--cat-vfr-color)', flexShrink: 0 }} />
                                        <span style={{ fontSize: 13, color: 'var(--md-sys-color-on-surface)', lineHeight: 1.45 }}>
                                            No flight concerns identified — conditions look good across all route airports.
                                        </span>
                                    </div>
                                ) : (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
                                        {finalVerdict.concerns.map((c, i) => (
                                            <div key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: 10 }}>
                                                <MdIcon name={c.icon} style={{ fontSize: 17, color: levelColor[c.level] || 'var(--md-sys-color-on-surface-variant)', flexShrink: 0, marginTop: 1 }} />
                                                <span style={{ fontSize: 13, color: 'var(--md-sys-color-on-surface)', lineHeight: 1.45 }}>{c.text}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* ---- Windy.com visual forecast (shown for GFS model trips >30h) ---- */}
                            {finalVerdict.anyMos && (
                                <div style={{ background: 'var(--md-sys-color-surface-container)', borderRadius: 16, padding: '16px', marginBottom: 16 }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12, flexWrap: 'wrap' }}>
                                        <MdIcon name="air" style={{ color: 'var(--md-sys-color-tertiary)', fontSize: 18 }} />
                                        <span style={{ fontWeight: 700, fontSize: 13, textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--md-sys-color-tertiary)' }}>Visual Forecast</span>
                                        <span style={{ fontSize: 10, fontWeight: 700, background: 'var(--md-sys-color-tertiary-container)', color: 'var(--md-sys-color-on-tertiary-container)', borderRadius: 4, padding: '2px 7px', letterSpacing: '0.5px' }}>WINDY.COM · ECMWF</span>
                                        <span style={{ fontSize: 11, color: 'var(--md-sys-color-on-surface-variant)', marginLeft: 'auto' }}>Centered on {effectiveWxData[0].icao} (dep)</span>
                                    </div>
                                    <WindyEmbed icao={effectiveWxData[0].icao} tripTargetUtc={tripTargetUtc} />
                                    <div style={{ fontSize: 11, color: 'var(--md-sys-color-on-surface-variant)', marginTop: 10, lineHeight: 1.5 }}>
                                        Use the timeline slider in the map to navigate to your departure date/time. Wind barbs show direction and speed in knots.
                                    </div>
                                </div>
                            )}

                            {/* Recommendations */}
                            <div style={{ background: 'var(--md-sys-color-surface-container)', borderRadius: 16, padding: 16, marginBottom: 16 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
                                    <MdIcon name="checklist" style={{ color: 'var(--md-sys-color-tertiary)', fontSize: 18 }} />
                                    <span style={{ fontWeight: 700, fontSize: 13, textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--md-sys-color-tertiary)' }}>Pilot Recommendations</span>
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
                                    {finalVerdict.recs.map((r, i) => (
                                        <div key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: 10 }}>
                                            <MdIcon name={r.startsWith('⚠') ? 'warning' : 'arrow_right'} style={{ fontSize: 17, color: r.startsWith('⚠') ? 'var(--md-sys-color-error)' : 'var(--md-sys-color-tertiary)', flexShrink: 0, marginTop: 1 }} />
                                            <span style={{ fontSize: 13, color: r.startsWith('⚠') ? 'var(--md-sys-color-on-surface)' : 'var(--md-sys-color-on-surface)', lineHeight: 1.45, fontWeight: r.startsWith('⚠') ? 600 : 400 }}>{r.replace(/^⚠ /, '')}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div style={{ fontSize: 11, color: 'var(--md-sys-color-on-surface-variant)', textAlign: 'center', padding: '4px 16px 20px', lineHeight: 1.5 }}>
                                {finalVerdict.anyMos
                                    ? <>GFS model forecast from <strong>AviationWeather.gov</strong> · visual from <strong>Windy.com</strong>. Long-range accuracy is limited — <strong>re-check with TAF 24h before departure</strong>.</>
                                    : finalVerdict.isFutureFlight
                                    ? <>TAF forecast from <strong>AviationWeather.gov</strong> for trip date/time. Conditions may change — <strong>re-check closer to departure</strong>.</>
                                    : <>Live weather from <strong>AviationWeather.gov</strong>. For situational awareness only.</>
                                } Always obtain an official briefing at <strong>1800wxbrief.com</strong> before flight.
                            </div>
                        </>
                    )}

                    {/* ---- Enhanced AI Analysis (collapsible) ---- */}
                    <div style={{ borderTop: '1px solid var(--md-sys-color-outline-variant)', paddingTop: 16 }}>
                        <button onClick={() => setShowAI(!showAI)} style={{ display: 'flex', alignItems: 'center', gap: 10, width: '100%', background: 'none', border: 'none', cursor: 'pointer', padding: '4px 0 12px', color: 'var(--md-sys-color-on-surface)' }}>
                            <MdIcon name="auto_awesome" style={{ color: 'var(--md-sys-color-primary)', fontSize: 20 }} />
                            <span style={{ fontWeight: 600, fontSize: 14, flex: 1, textAlign: 'left' }}>Enhanced AI Analysis</span>
                            <MdIcon name={showAI ? 'expand_less' : 'expand_more'} style={{ fontSize: 20, color: 'var(--md-sys-color-on-surface-variant)' }} />
                        </button>

                        {showAI && (
                            <>
                                <div style={{ marginBottom: 12 }}>
                                    <MdInput label="Anthropic API Key" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="sk-ant-..." type="password" />
                                </div>
                                <div style={{ display: 'flex', gap: 8, marginBottom: 20 }}>
                                    <MdButton
                                        variant={aiLoading ? "tonal" : "sparkle"}
                                        onClick={runAiBriefing}
                                        disabled={aiLoading || !apiKey || loadingWx}
                                        icon="auto_awesome"
                                        style={{ flex: 1, padding: '14px', fontSize: '15px' }}
                                    >
                                        {aiLoading ? "Analyzing with Claude…" : "Generate AI Briefing"}
                                    </MdButton>
                                    {window.speechSynthesis && (aiResult || analysis) && (
                                        <MdButton variant="tonal" icon={speaking ? 'stop_circle' : 'volume_up'} onClick={speakBriefing} title={speaking ? 'Stop reading' : 'Read briefing aloud'} style={{ padding: '14px 16px' }}>
                                            {speaking ? 'Stop' : 'Read'}
                                        </MdButton>
                                    )}
                                </div>

                                {aiError && <MdCard style={{ background: 'var(--md-sys-color-error-container)', color: 'var(--md-sys-color-on-error-container)', marginBottom: 16 }}><MdIcon name="error" style={{ marginRight: 8 }} />{aiError}</MdCard>}

                                {aiSections.map((s, i) => {
                                    var meta = sectionMeta[s.title] || { icon: 'info', color: 'var(--md-sys-color-primary)' };
                                    return (
                                        <div key={i} style={{ background: meta.bg || 'var(--md-sys-color-surface-container)', borderRadius: 16, padding: 20, marginBottom: 16, color: meta.onBg || 'var(--md-sys-color-on-surface)' }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }}>
                                                <MdIcon name={meta.icon} style={{ color: meta.color, fontSize: 24 }} />
                                                <h3 style={{ margin: 0, fontSize: 15, fontWeight: 700, color: meta.color, letterSpacing: '0.5px' }}>{s.title}</h3>
                                            </div>
                                            <div style={{ fontSize: 14, lineHeight: 1.6, whiteSpace: 'pre-wrap', color: meta.onBg || 'var(--md-sys-color-on-surface-variant)' }}>
                                                {s.body.trim().replace(/-/g, '\u2022')}
                                            </div>
                                        </div>
                                    );
                                })}

                                {/* AI Feedback */}
                                {aiResult && !aiLoading && (
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 12, padding: '8px 0 16px', borderBottom: '1px solid var(--md-sys-color-outline-variant)' }}>
                                        <span style={{ fontSize: 12, color: 'var(--md-sys-color-on-surface-variant)' }}>Was this briefing helpful?</span>
                                        <button onClick={() => setAiFeedback('up')} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4, display: 'inline-flex' }}>
                                            <MdIcon name="thumb_up" style={{ fontSize: 20, color: aiFeedback === 'up' ? 'var(--cat-vfr-color)' : 'var(--md-sys-color-outline)' }} />
                                        </button>
                                        <button onClick={() => setAiFeedback('down')} style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4, display: 'inline-flex' }}>
                                            <MdIcon name="thumb_down" style={{ fontSize: 20, color: aiFeedback === 'down' ? 'var(--md-sys-color-error)' : 'var(--md-sys-color-outline)' }} />
                                        </button>
                                        {aiFeedback && <span style={{ fontSize: 11, color: 'var(--md-sys-color-on-surface-variant)' }}>{aiFeedback === 'up' ? 'Thanks! Feedback helps improve AI responses.' : 'Thanks for the feedback.'}</span>}
                                    </div>
                                )}

                                {!aiResult && !aiLoading && (
                                    <div style={{ textAlign: 'center', padding: '24px', color: 'var(--md-sys-color-on-surface-variant)', fontSize: 13 }}>
                                        Claude will analyze live weather + the safety score above to generate a detailed narrative briefing with quantitative risk thresholds.
                                    </div>
                                )}

                                {/* Conversational AI Chat */}
                                {apiKey && (
                                    <div style={{ marginTop: 16, border: '1px solid var(--md-sys-color-outline-variant)', borderRadius: 16, overflow: 'hidden' }}>
                                        <div style={{ padding: '10px 14px', background: 'var(--md-sys-color-surface-container)', borderBottom: chatMessages.length ? '1px solid var(--md-sys-color-outline-variant)' : 'none', display: 'flex', alignItems: 'center', gap: 8 }}>
                                            <MdIcon name="chat" style={{ fontSize: 16, color: 'var(--md-sys-color-primary)' }} />
                                            <span style={{ fontWeight: 600, fontSize: 13, color: 'var(--md-sys-color-on-surface)', flex: 1 }}>Ask AI about this flight</span>
                                            {chatMessages.length > 0 && (
                                                <button onClick={() => setChatMessages([])} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: 11, color: 'var(--md-sys-color-on-surface-variant)', padding: '2px 6px' }}>Clear</button>
                                            )}
                                        </div>
                                        {chatMessages.length > 0 && (
                                            <div style={{ maxHeight: 300, overflowY: 'auto', padding: '12px 14px', display: 'flex', flexDirection: 'column', gap: 8, background: 'var(--md-sys-color-background)' }}>
                                                {chatMessages.map((m, i) => (
                                                    <div key={i} className={m.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}>{m.content}</div>
                                                ))}
                                                {chatLoading && <div className="chat-bubble-ai" style={{ color: 'var(--md-sys-color-on-surface-variant)', fontStyle: 'italic' }}>Thinking…</div>}
                                                <div ref={chatEndRef} />
                                            </div>
                                        )}
                                        <div style={{ display: 'flex', gap: 8, padding: '10px 14px', borderTop: chatMessages.length ? '1px solid var(--md-sys-color-outline-variant)' : 'none', alignItems: 'flex-end', background: 'var(--md-sys-color-surface-container)' }}>
                                            <textarea
                                                value={chatInput}
                                                onChange={e => setChatInput(e.target.value)}
                                                onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); } }}
                                                placeholder={'Ask about this flight — e.g. "What if I leave at noon?" or "Suggest alternates if ' + (trip.arr || 'destination') + ' goes IFR"'}
                                                rows={2}
                                                style={{ flex: 1, background: 'var(--md-sys-color-background)', border: '1px solid var(--md-sys-color-outline-variant)', borderRadius: 12, padding: '8px 12px', fontSize: 13, color: 'var(--md-sys-color-on-surface)', resize: 'none', fontFamily: 'inherit', outline: 'none' }}
                                            />
                                            <MdButton variant="tonal" icon="send" onClick={sendChat} disabled={!chatInput.trim() || chatLoading} style={{ padding: '10px 14px', flexShrink: 0 }} />
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        }

        /* =========================================
           EXPORT / IMPORT MODAL
        ========================================= */
        function DataModal({ trips, onImport, onClose }) {
            var [toast, setToast] = useState('');
            var importRef = React.useRef();

            function showToast(msg) {
                setToast(msg);
                setTimeout(() => setToast(''), 2500);
            }

            function handleExport() {
                var blob = new Blob([JSON.stringify(trips, null, 2)], { type: 'application/json' });
                var url = URL.createObjectURL(blob);
                var a = Object.assign(document.createElement('a'), {
                    href: url,
                    download: 'flightscore-trips-' + new Date().toISOString().slice(0, 10) + '.json'
                });
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Trips exported!');
            }

            function handleImportFile(e) {
                var file = e.target.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = ev => {
                    try {
                        var data = JSON.parse(ev.target.result);
                        if (!Array.isArray(data)) throw new Error();
                        onImport(data);
                        showToast(data.length + ' trip(s) imported!');
                        setTimeout(onClose, 1500);
                    } catch(ex) {
                        showToast('Invalid file — could not import.');
                    }
                    e.target.value = '';
                };
                reader.readAsText(file);
            }

            return (
                <div onClick={e => { if (e.target === e.currentTarget) onClose(); }}
                    style={{ position:'fixed', inset:0, background:'rgba(0,0,0,0.55)', zIndex:2000, display:'flex', alignItems:'center', justifyContent:'center', padding:16 }}>
                    <div style={{ background:'var(--md-sys-color-surface)', borderRadius:28, padding:32, width:'min(420px,100%)', boxShadow:'0 8px 32px rgba(0,0,0,0.3)' }}>
                        <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:20 }}>
                            <div style={{ fontSize:20, fontWeight:500 }}>My Trip Data</div>
                            <MdButton variant="text" icon="close" onClick={onClose} style={{ padding:8 }} />
                        </div>

                        {toast && (
                            <div style={{ background:'var(--md-sys-color-primary-container)', color:'var(--md-sys-color-on-primary-container)', borderRadius:12, padding:'10px 16px', marginBottom:16, fontSize:14, textAlign:'center' }}>{toast}</div>
                        )}

                        <div style={{ fontSize:13, color:'var(--md-sys-color-on-surface-variant)', marginBottom:20, lineHeight:1.6 }}>
                            Trips are automatically saved in this browser. Use export/import to move trips between devices, or to keep a backup.
                        </div>

                        <div style={{ display:'flex', flexDirection:'column', gap:12 }}>
                            <MdButton variant="tonal" icon="download" onClick={handleExport}>
                                Export trips as JSON ({trips.length} trip{trips.length !== 1 ? 's' : ''})
                            </MdButton>
                            <input ref={importRef} type="file" accept=".json,application/json" style={{ display:'none' }} onChange={handleImportFile} />
                            <MdButton variant="outlined" icon="upload" onClick={() => importRef.current && importRef.current.click()}>
                                Import trips from JSON
                            </MdButton>
                        </div>

                        <div style={{ marginTop:20, padding:'14px 16px', background:'var(--md-sys-color-surface-container)', borderRadius:12, fontSize:12, color:'var(--md-sys-color-on-surface-variant)', lineHeight:1.7 }}>
                            <b>Tip:</b> To sync across devices, export on one device and import on another. To share a single trip, use the <MdIcon name="share" style={{ fontSize:14, verticalAlign:'middle' }} /> link button on the trip card.
                        </div>
                    </div>
                </div>
            );
        }

        /* =========================================
           MAIN APPLICATION COMPONENT
        ========================================= */
        function App() {
            var [view, setView] = useState("trips");
            var defaultTimeStr = (new Date(Date.now() + 7200000)).toTimeString().slice(0, 5);

            var [showDataModal, setShowDataModal] = useState(false);

            // Dark mode: JS toggle overrides system @media preference
            var [darkMode, setDarkMode] = useState(function() {
                var saved = localStorage.getItem('flightscore_theme');
                if (saved === 'dark') return true;
                if (saved === 'light') return false;
                return !!(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
            });
            useEffect(function() {
                document.body.classList.toggle('dark-theme', darkMode);
                document.body.classList.toggle('light-theme', !darkMode);
                localStorage.setItem('flightscore_theme', darkMode ? 'dark' : 'light');
            }, [darkMode]);

            // Trips — initialized from localStorage, falling back to sample trips
            var [trips, setTrips] = useState(() => {
                try {
                    var saved = localStorage.getItem('flightscore_trips');
                    if (saved) return JSON.parse(saved);
                } catch(e) {}
                return [
                    { id: 1, dep: "KCLT", arr: "KATL", aircraft: "c172", date: "2026-02-28", time: "09:00", wps: [], name: "Charlotte to Atlanta", goScore: null },
                    { id: 2, dep: "KJFK", arr: "KBOS", aircraft: "sr22", date: "2026-03-01", time: "14:30", wps: ["KORH"], name: "New York to Boston", goScore: null },
                ];
            });
            var [activeTrip, setActiveTrip] = useState(null);
            var [tab, setTab] = useState("brief");
            var [forecastDay, setForecastDay] = useState(0);
            var [newTrip, setNewTrip] = useState({ route: ["", ""], aircraft: "c172", date: "", time: defaultTimeStr, name: "" });
            var [editingTripId, setEditingTripId] = useState(null); // null = creating, non-null = editing existing
            // Bump this counter to force re-renders after async airport fetches resolve
            var [aptVersion, setAptVersion] = useState(0);
            var [copiedTripId, setCopiedTripId] = useState(null);

            useEffect(() => {
                // Score each trip using departure-time weather (TAF/MOS/METAR),
                // matching the same logic as the BriefingPanel's effectiveWxData.
                trips.forEach(t => {
                    var allPts = [t.dep].concat(t.wps || []).concat([t.arr]).filter(Boolean);
                    var dist = 0;
                    for (var i = 0; i < allPts.length - 1; i++) {
                        var p1 = getAirport(allPts[i]), p2 = getAirport(allPts[i + 1]);
                        if (p1 && p2) dist += calcDist(p1.lat, p1.lon, p2.lat, p2.lon);
                    }
                    var routeDist = Math.round(dist);
                    fetchEffectiveWxForTrip(t, allPts).then(wxData => {
                        if (wxData.length > 0) {
                            var score = calcDetailedScore(wxData, routeDist).total;
                            setTrips(prev => prev.map(x => x.id === t.id ? { ...x, goScore: score } : x));
                        }
                    }).catch(() => {});
                });
            }, []);

            // Persist trips to localStorage on every change
            useEffect(() => {
                try { localStorage.setItem('flightscore_trips', JSON.stringify(trips)); } catch(e) {}
            }, [trips]);

            // Handle #share= URL hash — offer to import a shared trip on load
            useEffect(() => {
                var hash = window.location.hash;
                if (!hash.startsWith('#share=')) return;
                try {
                    var encoded = hash.slice(7);
                    var json = decodeURIComponent(escape(atob(encoded)));
                    var sharedTrip = JSON.parse(json);
                    if (sharedTrip && sharedTrip.dep && sharedTrip.arr) {
                        var label = sharedTrip.name || (sharedTrip.dep + ' → ' + sharedTrip.arr);
                        if (window.confirm('Add shared trip "' + label + '" to your list?')) {
                            setTrips(prev => [{ ...sharedTrip, id: Date.now() }, ...prev]);
                        }
                    }
                } catch(e) {}
                history.replaceState(null, '', window.location.pathname + window.location.search);
            }, []);

            function importTrips(data) {
                setTrips(prev => {
                    var existingIds = new Set(prev.map(t => String(t.id)));
                    var toAdd = data.filter(t => !existingIds.has(String(t.id)));
                    return toAdd.length ? [...toAdd, ...prev] : prev;
                });
            }

            function copyTripLink(trip, e) {
                e && e.stopPropagation();
                try {
                    var encoded = btoa(unescape(encodeURIComponent(JSON.stringify(trip))));
                    var url = window.location.href.split('#')[0] + '#share=' + encoded;
                    navigator.clipboard.writeText(url).then(() => {
                        setCopiedTripId(trip.id);
                        setTimeout(() => setCopiedTripId(null), 2000);
                    });
                } catch(ex) {}
            }

            // Auto-fetch real data for any unknown ICAOs typed in the create form
            useEffect(() => {
                const candidates = newTrip.route
                    .map(r => r.trim().toUpperCase())
                    .filter(r => r.length === 4 && !AIRPORTS[r]);
                if (candidates.length === 0) return;
                Promise.all(candidates.map(fetchAirportInfo)).then(results => {
                    if (results.some(Boolean)) setAptVersion(v => v + 1);
                }).catch(() => {});
            }, [newTrip.route.join(',')]);

            function createTrip() {
                var validRoute = newTrip.route
                    .map(r => r.trim().toUpperCase())
                    .filter(r => r.length === 4);
                if (validRoute.length < 2) return;
                var dep = validRoute[0], arr = validRoute[validRoute.length - 1];
                var tripName = newTrip.name || (dep + " to " + arr);

                if (editingTripId) {
                    // ── Update existing trip ──────────────────────────────────────────
                    var editedWps = validRoute.slice(1, -1);
                    setTrips(prev => prev.map(t => t.id === editingTripId ? {
                        ...t,
                        dep, arr, wps: editedWps,
                        aircraft: newTrip.aircraft,
                        date: newTrip.date,
                        time: newTrip.time,
                        name: tripName
                    } : t));
                    // Recompute score using departure-time weather (TAF/MOS/METAR)
                    (function(id, tripObj, dist) {
                        var pts = [tripObj.dep].concat(tripObj.wps||[]).concat([tripObj.arr]);
                        fetchEffectiveWxForTrip(tripObj, pts).then(wxData => {
                            if (wxData.length > 0) setTrips(prev => prev.map(t => t.id === id ? { ...t, goScore: calcDetailedScore(wxData, dist).total } : t));
                        }).catch(() => {});
                    })(editingTripId, { dep, arr, wps: editedWps, date: newTrip.date, time: newTrip.time }, Math.round((function() { var d=0; for(var i=0;i<validRoute.length-1;i++){var p1=getAirport(validRoute[i]),p2=getAirport(validRoute[i+1]);if(p1&&p2)d+=calcDist(p1.lat,p1.lon,p2.lat,p2.lon);}return d; })()));
                    setEditingTripId(null);
                } else {
                    // ── Create new trip ───────────────────────────────────────────────
                    var t = {
                        id: Date.now(), dep, arr, wps: validRoute.slice(1, -1),
                        aircraft: newTrip.aircraft, date: newTrip.date, time: newTrip.time,
                        name: tripName, goScore: null
                    };
                    setTrips(prev => [t].concat(prev));
                    // Score using departure-time weather (TAF/MOS/METAR)
                    (function(tripObj, dist) {
                        var pts = [tripObj.dep].concat(tripObj.wps||[]).concat([tripObj.arr]);
                        fetchEffectiveWxForTrip(tripObj, pts).then(wxData => {
                            if (wxData.length > 0) setTrips(prev => prev.map(x => x.id === tripObj.id ? { ...x, goScore: calcDetailedScore(wxData, dist).total } : x));
                        }).catch(() => {});
                    })(t, Math.round((function() { var d=0; for(var i=0;i<validRoute.length-1;i++){var p1=getAirport(validRoute[i]),p2=getAirport(validRoute[i+1]);if(p1&&p2)d+=calcDist(p1.lat,p1.lon,p2.lat,p2.lon);}return d; })()));
                }
                setNewTrip({ route: ["", ""], aircraft: "c172", date: "", time: defaultTimeStr, name: "" });
                setView("trips");
            }

            function editTrip(trip, e) {
                e.stopPropagation();
                setEditingTripId(trip.id);
                setNewTrip({
                    route: [trip.dep].concat(trip.wps || []).concat([trip.arr]),
                    aircraft: trip.aircraft,
                    date: trip.date,
                    time: trip.time,
                    name: trip.name || ''
                });
                setView("create");
            }

            function openTrip(trip) {
                // Keep the existing goScore while the briefing panel loads;
                // onScoreUpdate will replace it with calcDetailedScore once weather arrives
                setActiveTrip(trip); setTab("brief"); setForecastDay(0);
                setView("briefing");
            }

            function deleteTrip(id) {
                setTrips(prev => prev.filter(t => t.id !== id));
                if (activeTrip && activeTrip.id === id) { setActiveTrip(null); setView("trips"); }
            }

            var tabList = [
                { id: "brief", label: "Briefing", icon: "auto_awesome" },
                { id: "wx", label: "Weather", icon: "partly_cloudy_day" },
                { id: "notam", label: "NOTAMs", icon: "warning" },
                { id: "freq", label: "Freqs", icon: "cell_tower" },
                { id: "map", label: "Map", icon: "map" },
                { id: "fbo", label: "FBO", icon: "local_gas_station" },
                { id: "export", label: "Export", icon: "print" }
            ];

            return (
                <div style={{ display: "flex", flexDirection: "column", height: "100vh", overflow: "hidden" }}>
                    
                    {/* MD3 Top App Bar */}
                    <header style={{ 
                        height: "64px", display: "flex", alignItems: "center", justifyContent: "space-between", 
                        padding: "0 16px", background: "var(--md-sys-color-surface)", 
                        color: "var(--md-sys-color-on-surface)",
                        boxShadow: "0 1px 2px rgba(0,0,0,0.05)", zIndex: 10 
                    }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 16 }}>
                            {view === "briefing" ? (
                                <MdButton variant="text" icon="arrow_back" onClick={() => { setView("trips"); setActiveTrip(null); }} style={{ padding: '8px' }} />
                            ) : (
                                <MdIcon name="flight" style={{ color: 'var(--md-sys-color-primary)', fontSize: 28, marginLeft: 8 }} />
                            )}
                            <div style={{ fontSize: 22, fontWeight: 500 }}>FlightScore</div>
                        </div>
                        <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                            <MdButton variant="tonal" icon="add" onClick={() => setView("create")}>New Trip</MdButton>
                            <MdButton variant="text" icon={darkMode ? 'light_mode' : 'dark_mode'} title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'} onClick={() => setDarkMode(function(d) { return !d; })} style={{ padding: '8px' }} />
                            <MdButton variant="text" icon="import_export" title="Export / Import trips" onClick={() => setShowDataModal(true)} style={{ padding: '8px' }} />
                        </div>
                    </header>
                    {showDataModal && <DataModal trips={trips} onImport={importTrips} onClose={() => setShowDataModal(false)} />}

                    <main style={{ flex: 1, overflowY: "auto", background: "var(--md-sys-color-background)" }}>
                        
                        {/* TRIPS LIST */}
                        {view === "trips" && (
                            <div style={{ maxWidth: 840, margin: "0 auto", padding: "32px 16px" }}>
                                <h1 style={{ fontSize: 32, fontWeight: 400, margin: "0 0 24px", color: "var(--md-sys-color-on-background)" }}>My Trips</h1>
                                <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
                                    {trips.map(trip => {
                                        var ac = AIRCRAFT.find(a => a.id === trip.aircraft) || AIRCRAFT[0];
                                        
                                        var fullRoute = [trip.dep].concat(trip.wps || []).concat([trip.arr]).map(r => r ? r.trim().toUpperCase() : r);
                                        var validRoutePts = fullRoute.filter(r => r && getAirport(r));
                                        var d = 0;
                                        for (var i = 0; i < validRoutePts.length - 1; i++) {
                                            var p1 = getAirport(validRoutePts[i]);
                                            var p2 = getAirport(validRoutePts[i+1]);
                                            if (p1 && p2) d += calcDist(p1.lat, p1.lon, p2.lat, p2.lon);
                                        }
                                        var ete = ac ? d / ac.kts : 0;

                                        var depApt = getAirport(trip.dep);
                                        var tripTarget = (trip.date && trip.time && depApt) ? getTripTargetUtc(trip, depApt.lon) : null;
                                        var tripCountdown = null;
                                        if (tripTarget) {
                                            var msUntil = tripTarget.getTime() - Date.now();
                                            var hUntil = msUntil / 3600000;
                                            if (msUntil < 0) {
                                                tripCountdown = { label: 'Trip Is Outdated', past: true, soon: false };
                                            } else {
                                                var totalMins = Math.round(msUntil / 60000);
                                                var cdLabel;
                                                if (totalMins < 60) {
                                                    cdLabel = 'In ' + totalMins + 'm';
                                                } else if (hUntil < 24) {
                                                    var hh = Math.floor(hUntil), mm = Math.round((hUntil - hh) * 60);
                                                    cdLabel = 'In ' + hh + 'h' + (mm > 0 ? ' ' + mm + 'm' : '');
                                                } else if (Math.round(hUntil / 24) === 1) {
                                                    cdLabel = 'Tomorrow';
                                                } else if (hUntil < 168) {
                                                    cdLabel = 'In ' + Math.round(hUntil / 24) + ' days';
                                                } else if (hUntil < 720) {
                                                    var wks = Math.round(hUntil / 168);
                                                    cdLabel = 'In ' + wks + (wks === 1 ? ' week' : ' weeks');
                                                } else {
                                                    var mos = Math.round(hUntil / 720);
                                                    cdLabel = 'In ' + mos + (mos === 1 ? ' month' : ' months');
                                                }
                                                tripCountdown = { label: cdLabel, past: false, soon: hUntil < 2 };
                                            }
                                        }

                                        return (
                                            <MdCard key={trip.id} onClick={() => openTrip(trip)} style={{ padding: 0, overflow: 'hidden' }}>
                                                <div style={{ display: "flex", alignItems: "stretch" }}>
                                                    <div style={{ width: 100, display: "flex", alignItems: "center", justifyContent: "center", padding: 16, background: "var(--md-sys-color-surface-container-highest)" }}>
                                                        {trip.goScore ? <GoScoreRing score={trip.goScore} size={70} /> : <MdIcon name="pending" />}
                                                    </div>
                                                    <div style={{ flex: 1, padding: "16px 20px" }}>
                                                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 8 }}>
                                                            <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
                                                                {fullRoute.map((rt, idx) => (
                                                                    <React.Fragment key={idx}>
                                                                        <span className="font-mono" style={{ fontSize: 20, fontWeight: 700, color: idx === 0 ? "var(--md-sys-color-primary)" : idx === fullRoute.length - 1 ? "var(--md-sys-color-tertiary)" : "var(--md-sys-color-secondary)" }}>{rt}</span>
                                                                        {idx < fullRoute.length - 1 && <MdIcon name="flight" style={{ color: "var(--md-sys-color-outline)", transform: "rotate(45deg)", fontSize: "18px" }} />}
                                                                    </React.Fragment>
                                                                ))}
                                                            </div>
                                                            <div style={{ display:'flex', gap:0 }}>
                                                                <MdButton variant="text" icon={copiedTripId === trip.id ? "check" : "share"} title="Copy shareable link" onClick={(e) => copyTripLink(trip, e)} style={{ padding: '8px', color: copiedTripId === trip.id ? 'var(--md-sys-color-primary)' : 'var(--md-sys-color-outline)' }} />
                                                                <MdButton variant="text" icon="edit" title="Edit trip" onClick={(e) => editTrip(trip, e)} style={{ padding: '8px', color: 'var(--md-sys-color-outline)' }} />
                                                                <MdButton variant="text" icon="delete" onClick={(e) => { e.stopPropagation(); deleteTrip(trip.id); }} style={{ padding: '8px', color: 'var(--md-sys-color-outline)' }} />
                                                            </div>
                                                        </div>
                                                        <div style={{ display: "flex", alignItems: "center", gap: 16, fontSize: 14, color: "var(--md-sys-color-on-surface-variant)", flexWrap: "wrap" }}>
                                                            <span>{fullRoute.map(rt => getAirport(rt)?.city).filter(Boolean).join(" \u2794 ")}</span>
                                                            <span className="font-mono" style={{ background: 'var(--md-sys-color-surface-variant)', padding: '2px 8px', borderRadius: '4px', fontSize: 12 }}>{Math.round(d)} NM</span>
                                                            {ete > 0 && <span className="font-mono" style={{ background: 'var(--md-sys-color-surface-variant)', padding: '2px 8px', borderRadius: '4px', fontSize: 12 }}>{Math.floor(ete)}h{Math.round((ete % 1) * 60)}m</span>}
                                                            <span>{ac.name}</span>
                                                        </div>
                                                        {(trip.date || trip.time) && (
                                                            <div style={{ fontSize: 13, color: "var(--md-sys-color-on-surface-variant)", marginTop: 8, display: 'flex', alignItems: 'center', gap: 6, flexWrap: 'wrap' }}>
                                                                <MdIcon name="calendar_today" style={{ fontSize: 14 }} />
                                                                <span>{trip.date}{trip.time && ` \u2022 ${trip.time}`}</span>
                                                                {tripCountdown && (
                                                                    <span style={{
                                                                        fontSize: 11, fontWeight: 700, letterSpacing: '0.3px',
                                                                        padding: '2px 9px', borderRadius: 12,
                                                                        background: tripCountdown.past
                                                                            ? 'var(--md-sys-color-error-container)'
                                                                            : tripCountdown.soon
                                                                                ? 'rgba(255,152,0,0.18)'
                                                                                : 'var(--md-sys-color-primary-container)',
                                                                        color: tripCountdown.past
                                                                            ? 'var(--md-sys-color-on-error-container)'
                                                                            : tripCountdown.soon
                                                                                ? '#b45309'
                                                                                : 'var(--md-sys-color-on-primary-container)',
                                                                    }}>
                                                                        {tripCountdown.label}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </MdCard>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* CREATE TRIP */}
                        {view === "create" && (
                            <div style={{ maxWidth: 600, margin: "0 auto", padding: "32px 16px" }}>
                                <MdButton variant="text" icon="arrow_back" onClick={() => { setEditingTripId(null); setView("trips"); }} style={{ marginLeft: '-16px', marginBottom: '16px' }}>Back</MdButton>
                                <h1 style={{ fontSize: 32, fontWeight: 400, margin: "0 0 24px", color: "var(--md-sys-color-on-background)" }}>{editingTripId ? "Edit Flight" : "Plan a Flight"}</h1>
                                
                                <MdCard style={{ padding: 24 }}>
                                    <div style={{ display: "flex", flexDirection: "column", gap: 16, marginBottom: 24 }}>
                                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                                            <div style={{ fontSize: 14, fontWeight: 500, color: "var(--md-sys-color-on-surface)" }}>Flight Route (Up to 5 legs)</div>
                                            {newTrip.route.length < 6 && (
                                                <MdButton variant="tonal" icon="add" onClick={() => {
                                                    let r = [...newTrip.route];
                                                    r.splice(r.length - 1, 0, "");
                                                    setNewTrip({...newTrip, route: r});
                                                }} style={{ padding: '6px 12px', fontSize: 12 }}>Add Leg</MdButton>
                                            )}
                                        </div>
                                        
                                        {newTrip.route.map((r, i) => {
                                            let isDep = i === 0;
                                            let isArr = i === newTrip.route.length - 1;
                                            let label = isDep ? "Departure ICAO" : isArr ? "Destination ICAO" : `Waypoint ${i} ICAO`;
                                            let icon = isDep ? "flight_takeoff" : isArr ? "flight_land" : "location_on";
                                            
                                            return (
                                                <div key={i} style={{ display: "flex", alignItems: "flex-end", gap: 12 }}>
                                                    <MdIcon name={icon} style={{ color: "var(--md-sys-color-on-surface-variant)", marginBottom: 12, flexShrink: 0 }} />
                                                    <AirportInput
                                                        label={label}
                                                        value={r}
                                                        onChange={function(v) {
                                                            let newRoute = [...newTrip.route];
                                                            newRoute[i] = v;
                                                            setNewTrip({...newTrip, route: newRoute});
                                                        }}
                                                        placeholder={isDep ? "KCLT" : isArr ? "KATL" : "KORD"}
                                                        containerStyle={{ flex: 1 }}
                                                    />
                                                    {(!isDep && !isArr && newTrip.route.length > 2) && (
                                                        <MdButton variant="text" icon="close" onClick={() => {
                                                            let newRoute = [...newTrip.route];
                                                            newRoute.splice(i, 1);
                                                            setNewTrip({...newTrip, route: newRoute});
                                                        }} style={{ padding: '8px', color: "var(--md-sys-color-error)", marginBottom: 4 }} />
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 24 }}>
                                        <MdSelect label="Aircraft" value={newTrip.aircraft} onChange={e => setNewTrip({...newTrip, aircraft: e.target.value})} options={AIRCRAFT.map(a => ({value: a.id, label: `${a.name} (${a.cat})`}))} />
                                        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                                            <MdInput type="date" label="Date" value={newTrip.date} onChange={e => setNewTrip({...newTrip, date: e.target.value})} />
                                            <MdInput type="time" label="Time" value={newTrip.time} onChange={e => setNewTrip({...newTrip, time: e.target.value})} />
                                        </div>
                                    </div>
                                    
                                    {(() => {
                                        var validRoutePts = newTrip.route
                                            .map(r => r.trim().toUpperCase())
                                            .filter(r => r.length === 4 && getAirport(r));
                                        if (validRoutePts.length < 2) return null;
                                        var dist = 0;
                                        for (var i = 0; i < validRoutePts.length - 1; i++) {
                                            var p1 = getAirport(validRoutePts[i]);
                                            var p2 = getAirport(validRoutePts[i+1]);
                                            dist += calcDist(p1.lat, p1.lon, p2.lat, p2.lon);
                                        }
                                        var ac = AIRCRAFT.find(x => x.id === newTrip.aircraft) || AIRCRAFT[0];
                                        var ete = dist / ac.kts;
                                        return (
                                            <div className="font-mono" style={{ background: "var(--md-sys-color-surface-container-high)", borderRadius: 12, padding: 16, marginBottom: 24, display: "flex", justifyContent: "space-around", fontSize: 13 }}>
                                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)" }}>DIST </span><span style={{ color: "var(--md-sys-color-primary)", fontWeight: 700 }}>{Math.round(dist)} NM</span></div>
                                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)" }}>ETE </span><span style={{ color: "var(--md-sys-color-primary)", fontWeight: 700 }}>{Math.floor(ete)}h {Math.round((ete % 1) * 60)}m</span></div>
                                            </div>
                                        );
                                    })()}

                                    <div style={{ display: "flex", gap: 12, justifyContent: "flex-end", marginTop: 16 }}>
                                        <MdButton variant="text" onClick={() => { setEditingTripId(null); setView("trips"); }}>Cancel</MdButton>
                                        <MdButton variant="primary" onClick={createTrip} disabled={newTrip.route.filter(r => r.length === 4).length < 2}>{editingTripId ? "Save Changes" : "Create Trip"}</MdButton>
                                    </div>
                                </MdCard>

                                <div style={{ marginTop: 24 }}>
                                    <div style={{ fontSize: 13, fontWeight: 500, color: "var(--md-sys-color-on-surface-variant)", marginBottom: 12 }}>Popular Hubs</div>
                                    <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                                        {Object.keys(AIRPORTS).slice(0, 15).map(k => (
                                            <span key={k} onClick={() => {
                                                let newRoute = [...newTrip.route];
                                                let emptyIdx = newRoute.findIndex(r => !r || r.length < 4);
                                                if (emptyIdx !== -1) {
                                                    newRoute[emptyIdx] = k;
                                                    setNewTrip({...newTrip, route: newRoute});
                                                } else if (newRoute.length < 6) {
                                                    newRoute.splice(newRoute.length - 1, 0, k);
                                                    setNewTrip({...newTrip, route: newRoute});
                                                }
                                            }} className="font-mono" style={{ 
                                                fontSize: 12, color: "var(--md-sys-color-on-surface)", 
                                                background: "var(--md-sys-color-surface-container)", 
                                                padding: "6px 12px", borderRadius: "16px", cursor: "pointer",
                                                border: "1px solid var(--md-sys-color-outline-variant)" 
                                            }}>{k}</span>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* TRIP BRIEFING */}
                        {view === "briefing" && activeTrip && (() => {
                            var ac = AIRCRAFT.find(a => a.id === activeTrip.aircraft) || AIRCRAFT[0];
                            var fullRoute = [activeTrip.dep].concat(activeTrip.wps || []).concat([activeTrip.arr]);
                            
                            return (
                                <div style={{ display: "flex", height: "100%" }}>
                                    {/* MD3 Navigation Rail (hidden on mobile via .nav-rail CSS class) */}
                                    <div className="nav-rail" style={{
                                        width: "80px", background: "var(--md-sys-color-surface)",
                                        borderRight: "1px solid var(--md-sys-color-outline-variant)",
                                        display: "flex", flexDirection: "column", alignItems: "center", paddingTop: 16, gap: 12
                                    }}>
                                        {tabList.map(t => {
                                            var active = tab === t.id;
                                            return (
                                                <button key={t.id} onClick={() => setTab(t.id)} style={{
                                                    background: "none", border: "none", display: "flex", flexDirection: "column", 
                                                    alignItems: "center", cursor: "pointer", width: "100%", padding: "8px 0"
                                                }}>
                                                    <div style={{ 
                                                        background: active ? "var(--md-sys-color-secondary-container)" : "transparent",
                                                        color: active ? "var(--md-sys-color-on-secondary-container)" : "var(--md-sys-color-on-surface-variant)",
                                                        borderRadius: "16px", padding: "4px 16px", transition: "background 0.2s"
                                                    }}>
                                                        <MdIcon name={t.icon} style={{ fontSize: 24 }} />
                                                    </div>
                                                    <span style={{ 
                                                        fontSize: 11, fontWeight: active ? 600 : 400, marginTop: 4,
                                                        color: active ? "var(--md-sys-color-on-surface)" : "var(--md-sys-color-on-surface-variant)"
                                                    }}>{t.label}</span>
                                                </button>
                                            )
                                        })}
                                    </div>

                                    {/* Mobile Bottom Navigation (CSS makes it visible on small screens) */}
                                    <div className="mobile-bottom-nav">
                                        {tabList.map(function(t) {
                                            var active = tab === t.id;
                                            return (
                                                <button key={t.id} onClick={() => setTab(t.id)} style={{ background:'none', border:'none', cursor:'pointer', display:'flex', flexDirection:'column', alignItems:'center', gap:2, padding:'6px 10px', minWidth:48 }}>
                                                    <MdIcon name={t.icon} style={{ fontSize:22, color: active ? 'var(--md-sys-color-primary)' : 'var(--md-sys-color-on-surface-variant)' }} />
                                                    <span style={{ fontSize:10, fontWeight: active ? 600 : 400, color: active ? 'var(--md-sys-color-primary)' : 'var(--md-sys-color-on-surface-variant)' }}>{t.label}</span>
                                                </button>
                                            );
                                        })}
                                    </div>

                                    {/* Content Area */}
                                    <div style={{ flex: 1, display: "flex", flexDirection: "column", overflow: "hidden", background: "var(--md-sys-color-background)" }}>
                                        {/* Trip Header Banner */}
                                        <div style={{ padding: "16px 24px", display: "flex", alignItems: "center", gap: 24, borderBottom: "1px solid var(--md-sys-color-surface-variant)" }}>
                                            <GoScoreRing score={activeTrip.goScore || 50} size={56} />
                                            <div>
                                                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4, flexWrap: "wrap" }}>
                                                    {fullRoute.map((rt, idx) => (
                                                        <React.Fragment key={idx}>
                                                            <span className="font-mono" style={{ fontSize: 22, fontWeight: 700, color: idx === 0 ? "var(--md-sys-color-primary)" : idx === fullRoute.length - 1 ? "var(--md-sys-color-tertiary)" : "var(--md-sys-color-secondary)" }}>{rt}</span>
                                                            {idx < fullRoute.length - 1 && <MdIcon name="flight" style={{ color: "var(--md-sys-color-outline)", transform: "rotate(45deg)", fontSize: "18px" }} />}
                                                        </React.Fragment>
                                                    ))}
                                                </div>
                                                <div style={{ fontSize: 13, color: "var(--md-sys-color-on-surface-variant)" }}>
                                                    {ac.name} {'•'} {activeTrip.date}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Scrollable Tab Content */}
                                        <div className="briefing-content" style={{ flex: 1, overflowY: "auto", padding: "24px", maxWidth: "900px", margin: "0 auto", width: "100%" }}>
                                            {tab === "brief" && <BriefingPanel trip={activeTrip} onScoreUpdate={score => {
                                                setActiveTrip(prev => prev ? { ...prev, goScore: score } : prev);
                                                setTrips(prev => prev.map(t => t.id === activeTrip.id ? { ...t, goScore: score } : t));
                                            }} />}
                                            
                                            {tab === "wx" && (
                                                <div style={{display: 'flex', flexDirection: 'column', gap: '24px'}}>
                                                    {fullRoute.map((rt, idx) => {
                                                        let label = idx === 0 ? "Departure" : idx === fullRoute.length - 1 ? "Destination" : `Waypoint ${idx}`;
                                                        return (
                                                            <div key={idx}>
                                                                <h2 style={{fontSize: 16, fontWeight: 500, margin: "0 0 12px", color: "var(--md-sys-color-on-surface)"}}>
                                                                    {label} - {getAirport(rt)?.city || rt}
                                                                </h2>
                                                                <WeatherDetail icao={rt} label={label} />
                                                                <ForecastStrip icao={rt} selectedDay={forecastDay} onSelect={setForecastDay} />
                                                            </div>
                                                        );
                                                    })}

                                                    <WindyMap dep={activeTrip.dep} arr={activeTrip.arr} wps={activeTrip.wps || []} />

                                                    <div>
                                                        <h2 style={{fontSize: 16, fontWeight: 500, margin: "0 0 12px", color: "var(--md-sys-color-on-surface)"}}>En Route PIREPs</h2>
                                                        <LivePireps dep={activeTrip.dep} arr={activeTrip.arr} />
                                                    </div>
                                                </div>
                                            )}

                                            {tab === "notam" && (
                                                <div style={{display: 'flex', flexDirection: 'column', gap: '24px'}}>
                                                    {fullRoute.map((rt, idx) => (
                                                        <div key={idx}>
                                                            <h2 style={{fontSize: 16, fontWeight: 500, margin: "0 0 12px", color: "var(--md-sys-color-on-surface)"}}>
                                                                NOTAMs - {rt}
                                                            </h2>
                                                            <NotamsPanel icao={rt} />
                                                        </div>
                                                    ))}
                                                </div>
                                            )}

                                            {tab === "freq" && (
                                                <div style={{display: 'flex', flexDirection: 'column', gap: '24px'}}>
                                                    {fullRoute.map((rt, idx) => (
                                                        <FreqPanel key={idx} icao={rt} />
                                                    ))}
                                                </div>
                                            )}

                                            {tab === "map" && (
                                                <RouteMap dep={activeTrip.dep} arr={activeTrip.arr} wps={activeTrip.wps || []} />
                                            )}

                                            {tab === "fbo" && (
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0' }}>
                                                    {fullRoute.map((rt, idx) => {
                                                        let label = idx === 0 ? "Departure" : idx === fullRoute.length - 1 ? "Destination" : `Waypoint ${idx}`;
                                                        return <FBOPanel key={idx} icao={rt} label={label} />;
                                                    })}
                                                </div>
                                            )}

                                            {tab === "export" && (() => {
                                                var now = new Date();
                                                var nowUtcStr = `${String(now.getUTCHours()).padStart(2,'0')}${String(now.getUTCMinutes()).padStart(2,'0')}Z ${now.getUTCFullYear()}-${String(now.getUTCMonth()+1).padStart(2,'0')}-${String(now.getUTCDate()).padStart(2,'0')}`;
                                                var depUtcStr = tripTargetUtc
                                                    ? `${String(tripTargetUtc.getUTCHours()).padStart(2,'0')}${String(tripTargetUtc.getUTCMinutes()).padStart(2,'0')}Z`
                                                    : '--';
                                                var altFt = ac.alt || 6000;

                                                function catClr(c) { return ({VFR:'#1b5e20',MVFR:'#1565c0',IFR:'#b71c1c',LIFR:'#6a1b9a'})[c]||'#555'; }
                                                function catBg(c)  { return ({VFR:'#e8f5e9',MVFR:'#e3f2fd',IFR:'#ffebee',LIFR:'#f3e5f5'})[c]||'#eee'; }
                                                function scoreClr(pct) { return pct >= 0.85 ? '#2e7d32' : pct >= 0.65 ? '#1565c0' : '#c62828'; }

                                                var verd = finalVerdict || analysis;
                                                var vClr = !verd ? '#1b5e20' : verd.verdict === 'GO' ? '#1b5e20' : verd.verdict === 'CAUTION' ? '#e65100' : '#b71c1c';
                                                var vBg  = !verd ? '#e8f5e9' : verd.verdict === 'GO' ? '#e8f5e9' : verd.verdict === 'CAUTION' ? '#fff3e0' : '#ffebee';

                                                var windRows = allRoutePts.map(icao => {
                                                    var apt = getAirport(icao);
                                                    if (!apt) return { icao, w: null };
                                                    var stn = closestWindStation(windsAloft, apt.lat, apt.lon);
                                                    return { icao, w: stn ? getWindAtAlt(stn, altFt) : null };
                                                });

                                                var advisoryCount = sigmets.length + gairmets.length + cwas.length;

                                                var sh = { fontSize: 11, fontWeight: 700, textTransform: 'uppercase', letterSpacing: '1px', color: '#0b57d0', borderBottom: '2px solid #0b57d0', paddingBottom: 5, marginBottom: 12, marginTop: 0 };
                                                var cell = { fontSize: 13, padding: '7px 10px', borderBottom: '1px solid #e8e8e8' };
                                                var cellHd = { ...cell, fontSize: 10, fontWeight: 700, color: '#777', background: '#f5f5f5', textTransform: 'uppercase', letterSpacing: '0.5px' };

                                                return (
                                                    <div>
                                                        {/* Toolbar — hidden when printing */}
                                                        <div className="no-print" style={{ display: 'flex', alignItems: 'center', gap: 16, paddingBottom: 20, flexWrap: 'wrap' }}>
                                                            <button onClick={() => window.print()} style={{ display: 'flex', alignItems: 'center', gap: 8, background: '#0b57d0', color: '#fff', border: 'none', borderRadius: 20, padding: '10px 24px', fontSize: 14, fontWeight: 600, cursor: 'pointer', boxShadow: '0 2px 8px rgba(11,87,208,0.3)' }}>
                                                                <MdIcon name="print" style={{ fontSize: 18 }} /> Print / Save as PDF
                                                            </button>
                                                            <span style={{ fontSize: 12, color: 'var(--md-sys-color-on-surface-variant)', lineHeight: 1.5 }}>
                                                                Choose <strong>Save as PDF</strong> in the print dialog to export a file.
                                                            </span>
                                                        </div>

                                                        {/* ══ PRINTABLE REGION ══ */}
                                                        <div id="export-printable" style={{ background: '#fff', color: '#1a1a1a', fontFamily: 'Roboto, Arial, sans-serif', border: '1px solid #ddd', borderRadius: 10, overflow: 'hidden', boxShadow: '0 4px 24px rgba(0,0,0,0.10)' }}>

                                                            {/* ── Header band ── */}
                                                            <div style={{ background: 'linear-gradient(135deg,#0b57d0 0%,#1a73e8 100%)', color: '#fff', padding: '20px 28px', display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 16 }}>
                                                                <div style={{ display: 'flex', alignItems: 'center', gap: 14 }}>
                                                                    <MdIcon name="flight" style={{ fontSize: 32, opacity: 0.9 }} />
                                                                    <div>
                                                                        <div style={{ fontSize: 10, fontWeight: 700, letterSpacing: '2.5px', textTransform: 'uppercase', opacity: 0.75, marginBottom: 2 }}>FlightScore</div>
                                                                        <div style={{ fontSize: 22, fontWeight: 800, letterSpacing: '-0.5px', lineHeight: 1 }}>FLIGHT BRIEF</div>
                                                                        {trip.name && <div style={{ fontSize: 12, opacity: 0.8, marginTop: 3 }}>{trip.name}</div>}
                                                                    </div>
                                                                </div>
                                                                {detailedScore && verd && (
                                                                    <div style={{ display: 'flex', alignItems: 'center', gap: 14 }}>
                                                                        <div style={{ textAlign: 'right' }}>
                                                                            <div style={{ fontSize: 42, fontWeight: 900, lineHeight: 1, fontFamily: 'monospace' }}>{detailedScore.total}</div>
                                                                            <div style={{ fontSize: 9, fontWeight: 700, opacity: 0.7, letterSpacing: '1.5px', textTransform: 'uppercase' }}>/ 100 SCORE</div>
                                                                        </div>
                                                                        <div style={{ background: vBg, color: vClr, borderRadius: 10, padding: '8px 18px', textAlign: 'center', minWidth: 88 }}>
                                                                            <MdIcon name={verd.verdictIcon} style={{ fontSize: 24, display: 'block', margin: '0 auto 3px' }} />
                                                                            <div style={{ fontSize: 15, fontWeight: 900, letterSpacing: '1px' }}>{verd.verdict}</div>
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>

                                                            {/* ── Trip meta bar ── */}
                                                            <div style={{ background: '#f7f9ff', borderBottom: '1px solid #e0e0e0', padding: '14px 28px', display: 'grid', gridTemplateColumns: 'auto 1fr', gap: '0 36px', alignItems: 'center' }}>
                                                                <div>
                                                                    <div style={{ fontSize: 10, color: '#888', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: 3 }}>Route</div>
                                                                    <div style={{ fontFamily: 'monospace', fontWeight: 800, fontSize: 22, letterSpacing: '1px', color: '#0b57d0' }}>
                                                                        {allRoutePts.join(' → ')}
                                                                    </div>
                                                                </div>
                                                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '4px 20px' }}>
                                                                    {[
                                                                        ['Aircraft', ac.name],
                                                                        ['Date', trip.date],
                                                                        ['Departure', `${trip.time} local · ${depUtcStr}`],
                                                                        ['ETE / Dist', `${eteStr} · ${routeDist} NM`],
                                                                    ].map(([lbl, val]) => (
                                                                        <div key={lbl}>
                                                                            <div style={{ fontSize: 10, color: '#999', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.3px' }}>{lbl}</div>
                                                                            <div style={{ fontSize: 12, fontWeight: 600, color: '#222', fontFamily: lbl==='Departure'||lbl==='ETE / Dist'?'monospace':'inherit' }}>{val}</div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>

                                                            {/* ── Body sections ── */}
                                                            <div style={{ padding: '22px 28px', display: 'flex', flexDirection: 'column', gap: 26 }}>

                                                                {/* Route table */}
                                                                <div>
                                                                    <div style={sh}>Route Airports</div>
                                                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                                                        <thead><tr>{['ICAO','Airport Name','City / State','Role','Leg'].map(h=><th key={h} style={{...cellHd,textAlign:'left'}}>{h}</th>)}</tr></thead>
                                                                        <tbody>
                                                                            {allRoutePts.map((icao, idx) => {
                                                                                var apt = getAirport(icao);
                                                                                var role = idx===0 ? 'Departure' : idx===allRoutePts.length-1 ? 'Destination' : `Waypoint ${idx}`;
                                                                                var legDist = '—';
                                                                                if (idx > 0) { var prev=getAirport(allRoutePts[idx-1]); if(prev&&apt) legDist=Math.round(calcDist(prev.lat,prev.lon,apt.lat,apt.lon))+' NM'; }
                                                                                return (
                                                                                    <tr key={icao} style={{background: idx%2===0?'#fff':'#fafafa'}}>
                                                                                        <td style={{...cell,fontFamily:'monospace',fontWeight:800,fontSize:15,color:'#0b57d0'}}>{icao}</td>
                                                                                        <td style={cell}>{apt?apt.name:'—'}</td>
                                                                                        <td style={{...cell,color:'#555'}}>{apt?`${apt.city}, ${apt.state}`:'—'}</td>
                                                                                        <td style={{...cell,color:'#777',fontSize:12}}>{role}</td>
                                                                                        <td style={{...cell,fontFamily:'monospace',color:'#555'}}>{legDist}</td>
                                                                                    </tr>
                                                                                );
                                                                            })}
                                                                        </tbody>
                                                                    </table>
                                                                    <div style={{fontSize:11,color:'#888',marginTop:6}}>
                                                                        Total distance: <strong>{routeDist} NM</strong> · Est. time en route: <strong>{eteStr}</strong> @ {ac.kts} kts · Cruise: <strong>{(altFt/1000).toFixed(1)}k ft</strong>
                                                                    </div>
                                                                </div>

                                                                {/* Score breakdown */}
                                                                {detailedScore && (
                                                                    <div>
                                                                        <div style={sh}>Composite Safety Score — {detailedScore.total} / 100</div>
                                                                        <div style={{display:'flex',flexDirection:'column',gap:10}}>
                                                                            {detailedScore.breakdown.map((b,i) => (
                                                                                <div key={i} style={{display:'grid',gridTemplateColumns:'140px 1fr 58px 130px',alignItems:'center',gap:10}}>
                                                                                    <span style={{fontSize:12,fontWeight:600,color:'#333'}}>{b.label}</span>
                                                                                    <div style={{height:9,background:'#ececec',borderRadius:5,overflow:'hidden'}}>
                                                                                        <div style={{height:'100%',width:(b.score/b.max*100)+'%',background:scoreClr(b.score/b.max),borderRadius:5,transition:'width 0.5s'}} />
                                                                                    </div>
                                                                                    <span style={{fontFamily:'monospace',fontSize:12,fontWeight:700,textAlign:'right',color:scoreClr(b.score/b.max)}}>{b.score}/{b.max}</span>
                                                                                    <span style={{fontSize:11,color:'#666',textAlign:'right'}}>{b.detail}</span>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                        {verd && <div style={{marginTop:12,padding:'10px 14px',background:vBg,borderRadius:8,border:`1px solid ${vClr}22`,fontSize:12,color:vClr,lineHeight:1.5}}>{verd.verdictDesc}</div>}
                                                                    </div>
                                                                )}

                                                                {/* Weather table */}
                                                                {effectiveWxData && (
                                                                    <div>
                                                                        <div style={sh}>Weather at Route Airports</div>
                                                                        <table style={{width:'100%',borderCollapse:'collapse'}}>
                                                                            <thead><tr>{['ICAO','Cat','Wind','Vis','Sky / Clouds','Temp','Altm','Source'].map(h=><th key={h} style={{...cellHd,textAlign:'left'}}>{h}</th>)}</tr></thead>
                                                                            <tbody>
                                                                                {effectiveWxData.map((e,idx) => {
                                                                                    var m = e.effectiveWx;
                                                                                    var cat = m ? m.cat : '—';
                                                                                    return (
                                                                                        <tr key={e.icao} style={{background:idx%2===0?'#fff':'#fafafa'}}>
                                                                                            <td style={{...cell,fontFamily:'monospace',fontWeight:800,color:'#0b57d0'}}>{e.icao}</td>
                                                                                            <td style={cell}>{m&&<span style={{background:catBg(cat),color:catClr(cat),borderRadius:4,padding:'2px 8px',fontSize:11,fontWeight:700,whiteSpace:'nowrap'}}>{cat}</span>}</td>
                                                                                            <td style={{...cell,fontFamily:'monospace',fontSize:12}}>{m?m.wind:'—'}</td>
                                                                                            <td style={{...cell,fontFamily:'monospace',fontSize:12}}>{m?m.vis:'—'}</td>
                                                                                            <td style={{...cell,fontFamily:'monospace',fontSize:12}}>{m?m.sky:'—'}</td>
                                                                                            <td style={{...cell,fontFamily:'monospace',fontSize:12}}>{m?m.temp:'—'}</td>
                                                                                            <td style={{...cell,fontFamily:'monospace',fontSize:12}}>{m?m.alt:'—'}</td>
                                                                                            <td style={{...cell,fontSize:11,color:'#666'}}>{e.sourceLabel}</td>
                                                                                        </tr>
                                                                                    );
                                                                                })}
                                                                            </tbody>
                                                                        </table>
                                                                        {/* Raw METAR strings */}
                                                                        {effectiveWxData.some(e=>e.effectiveWx&&e.effectiveWx.raw) && (
                                                                            <div style={{marginTop:10,display:'flex',flexDirection:'column',gap:4}}>
                                                                                {effectiveWxData.filter(e=>e.effectiveWx&&e.effectiveWx.raw).map(e=>(
                                                                                    <div key={e.icao} style={{fontFamily:'monospace',fontSize:11,background:'#f5f5f5',borderRadius:5,padding:'6px 10px',color:'#444',lineHeight:1.6,wordBreak:'break-all'}}>{e.effectiveWx.raw}</div>
                                                                                ))}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}

                                                                {/* Key concerns */}
                                                                {finalVerdict && (
                                                                    <div>
                                                                        <div style={sh}>Key Concerns</div>
                                                                        {finalVerdict.concerns.length === 0 ? (
                                                                            <div style={{display:'flex',alignItems:'center',gap:9,color:'#2e7d32',fontSize:13,fontWeight:500}}>
                                                                                <MdIcon name="check_circle" style={{fontSize:18}} />
                                                                                No flight concerns identified — conditions look good across all route airports.
                                                                            </div>
                                                                        ) : (
                                                                            <div style={{display:'flex',flexDirection:'column',gap:7}}>
                                                                                {finalVerdict.concerns.map((c,i)=>(
                                                                                    <div key={i} style={{display:'flex',alignItems:'flex-start',gap:9,fontSize:13,color:c.level==='high'?'#b71c1c':'#e65100'}}>
                                                                                        <MdIcon name={c.icon} style={{fontSize:15,marginTop:2,flexShrink:0}} />
                                                                                        <span>{c.text}</span>
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}

                                                                {/* Winds aloft */}
                                                                {windsAloft.length > 0 && windRows.some(r=>r.w) && (
                                                                    <div>
                                                                        <div style={sh}>Winds Aloft — {(altFt/1000).toFixed(0)}K ft (FD)</div>
                                                                        <table style={{width:'100%',borderCollapse:'collapse'}}>
                                                                            <thead><tr>{['Airport','Direction','Speed','Temp'].map(h=><th key={h} style={{...cellHd,textAlign:'left'}}>{h}</th>)}</tr></thead>
                                                                            <tbody>
                                                                                {windRows.map(({icao,w},idx)=>(
                                                                                    <tr key={icao} style={{background:idx%2===0?'#fff':'#fafafa'}}>
                                                                                        <td style={{...cell,fontFamily:'monospace',fontWeight:700}}>{icao}</td>
                                                                                        <td style={{...cell,fontFamily:'monospace'}}>{w?(w.lv?'LGT & VRB':`${w.wdir}°`):'No data'}</td>
                                                                                        <td style={{...cell,fontFamily:'monospace'}}>{w&&!w.lv?`${w.wspd} kt`:'—'}</td>
                                                                                        <td style={{...cell,fontFamily:'monospace'}}>{w&&w.temp!=null?`${w.temp>0?'+':''}${w.temp}°C`:'—'}</td>
                                                                                    </tr>
                                                                                ))}
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                )}

                                                                {/* Recommendations */}
                                                                {finalVerdict && finalVerdict.recs && finalVerdict.recs.length > 0 && (
                                                                    <div>
                                                                        <div style={sh}>Recommendations</div>
                                                                        <div style={{display:'flex',flexDirection:'column',gap:6}}>
                                                                            {finalVerdict.recs.map((r,i)=>(
                                                                                <div key={i} style={{display:'flex',alignItems:'flex-start',gap:9,fontSize:13,color:'#222'}}>
                                                                                    <span style={{color:'#0b57d0',fontWeight:700,flexShrink:0,marginTop:1}}>•</span>
                                                                                    <span style={{lineHeight:1.5}}>{r}</span>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {/* Active advisories */}
                                                                {advisoryCount > 0 && (
                                                                    <div>
                                                                        <div style={{...sh,color:'#b71c1c',borderBottomColor:'#b71c1c'}}>Active Advisories ({advisoryCount})</div>
                                                                        <div style={{display:'flex',flexDirection:'column',gap:5}}>
                                                                            {sigmets.length > 0 && <div style={{fontSize:13,color:'#b71c1c'}}><strong>{sigmets.length} SIGMET(s)</strong> active along route — obtain full text from aviationweather.gov.</div>}
                                                                            {gairmets.length > 0 && <div style={{fontSize:13,color:'#e65100'}}><strong>{gairmets.length} G-AIRMET(s)</strong> active — review for IFR conditions, turbulence, or icing.</div>}
                                                                            {cwas.length > 0 && <div style={{fontSize:13,color:'#b71c1c'}}><strong>{cwas.length} Center Weather Advisory(s)</strong> — check for convective activity.</div>}
                                                                        </div>
                                                                    </div>
                                                                )}

                                                            </div>{/* end body */}

                                                            {/* ── Footer ── */}
                                                            <div style={{background:'#f5f7fa',borderTop:'1px solid #e0e0e0',padding:'12px 28px',display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:8}}>
                                                                <div style={{fontSize:11,color:'#555'}}>
                                                                    Generated by <strong>FlightScore</strong> · {nowUtcStr}
                                                                </div>
                                                                <div style={{fontSize:11,color:'#888',textAlign:'right',maxWidth:380,lineHeight:1.5}}>
                                                                    For flight planning reference only. Always obtain an official briefing at <strong>1800wxbrief.com</strong> before departure.
                                                                </div>
                                                            </div>
                                                        </div>{/* end #export-printable */}
                                                    </div>
                                                );
                                            })()}
                                        </div>
                                    </div>
                                </div>
                            );
                        })()}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
