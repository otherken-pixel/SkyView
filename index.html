<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyClear Aviation Dashboard</title>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for in-browser JSX compiling -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Google Fonts & Material Symbols (MD3) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;600;700&family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <style>
        /* Material Design 3 (Material You) Token System */
        :root {
            /* LIGHT THEME (Default) */
            --md-sys-color-primary: #0b57d0;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #d3e3fd;
            --md-sys-color-on-primary-container: #041e49;
            
            --md-sys-color-secondary: #535f70;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #d7e3f7;
            --md-sys-color-on-secondary-container: #101c2b;
            
            --md-sys-color-tertiary: #6b5778;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #f2daff;
            --md-sys-color-on-tertiary-container: #251431;

            --md-sys-color-error: #b3261e;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #f9dedc;
            --md-sys-color-on-error-container: #410e0b;

            --md-sys-color-warning: #855400;
            --md-sys-color-warning-container: #ffddb3;
            --md-sys-color-on-warning-container: #2a1700;

            --md-sys-color-background: #fdfbff;
            --md-sys-color-on-background: #1a1c1e;
            
            --md-sys-color-surface: #fdfbff;
            --md-sys-color-on-surface: #1a1c1e;
            --md-sys-color-surface-variant: #dfe2eb;
            --md-sys-color-on-surface-variant: #43474e;
            
            --md-sys-color-surface-container-lowest: #ffffff;
            --md-sys-color-surface-container-low: #f3f3fa;
            --md-sys-color-surface-container: #ece6f0;
            --md-sys-color-surface-container-high: #e6e0e9;
            --md-sys-color-surface-container-highest: #e0dce3;
            
            --md-sys-color-outline: #73777f;
            --md-sys-color-outline-variant: #c3c6cf;
            
            /* Flight Category Colors */
            --cat-vfr-color: #0f5223;
            --cat-vfr-bg: #c4eed0;
            --cat-mvfr-color: #0b57d0;
            --cat-mvfr-bg: #d3e3fd;
            --cat-ifr-color: #b3261e;
            --cat-ifr-bg: #f9dedc;
            --cat-lifr-color: #6b5778;
            --cat-lifr-bg: #f2daff;

            --font-sans: 'Roboto', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* DARK THEME */
                --md-sys-color-primary: #a8c7fa;
                --md-sys-color-on-primary: #062e6f;
                --md-sys-color-primary-container: #0842a0;
                --md-sys-color-on-primary-container: #d3e3fd;
                
                --md-sys-color-secondary: #bbc7db;
                --md-sys-color-on-secondary: #253140;
                --md-sys-color-secondary-container: #3b4858;
                --md-sys-color-on-secondary-container: #d7e3f7;
                
                --md-sys-color-tertiary: #d6bdfb;
                --md-sys-color-on-tertiary: #3a2948;
                --md-sys-color-tertiary-container: #523f5f;
                --md-sys-color-on-tertiary-container: #f2daff;

                --md-sys-color-error: #ffb4ab;
                --md-sys-color-on-error: #690005;
                --md-sys-color-error-container: #93000a;
                --md-sys-color-on-error-container: #ffdad6;

                --md-sys-color-warning: #ffb951;
                --md-sys-color-warning-container: #653e00;
                --md-sys-color-on-warning-container: #ffddb3;

                --md-sys-color-background: #111114;
                --md-sys-color-on-background: #e2e2e6;
                
                --md-sys-color-surface: #111114;
                --md-sys-color-on-surface: #e2e2e6;
                --md-sys-color-surface-variant: #43474e;
                --md-sys-color-on-surface-variant: #c3c6cf;
                
                --md-sys-color-surface-container-lowest: #0c0f12;
                --md-sys-color-surface-container-low: #191c20;
                --md-sys-color-surface-container: #1d2024;
                --md-sys-color-surface-container-high: #282a2f;
                --md-sys-color-surface-container-highest: #33353a;
                
                --md-sys-color-outline: #8d9199;
                --md-sys-color-outline-variant: #43474e;

                /* Flight Category Colors (Dark) */
                --cat-vfr-color: #6dd58c;
                --cat-vfr-bg: #0d381e;
                --cat-mvfr-color: #a8c7fa;
                --cat-mvfr-bg: #0842a0;
                --cat-ifr-color: #ffb4ab;
                --cat-ifr-bg: #93000a;
                --cat-lifr-color: #d6bdfb;
                --cat-lifr-bg: #523f5f;
            }
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            font-family: var(--font-sans);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        * {
            box-sizing: border-box;
        }

        /* Material Icons Setup */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            display: inline-block;
            vertical-align: middle;
            line-height: 1;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--md-sys-color-background); }
        ::-webkit-scrollbar-thumb { background: var(--md-sys-color-surface-variant); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--md-sys-color-outline); }

        /* General Utilities */
        .font-mono { font-family: var(--font-mono); }
        
        /* Interactive element transitions */
        button, a, .interactive {
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        }

        /* Spin animation for loading indicator */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Leaflet map overrides */
        .leaflet-container { z-index: 0; font-family: var(--font-sans); }
        .leaflet-control-attribution { font-size: 10px !important; }
        .route-icao-label {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 12px;
            color: #1a1c1e;
            text-shadow: 0 0 4px #fff, 0 0 4px #fff, 0 0 4px #fff;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        /* =========================================
           DATA & UTILITIES
        ========================================= */
        const AIRPORTS = {
            KCLT: { name: "Charlotte Douglas Intl", city: "Charlotte", state: "NC", lat: 35.214, lon: -80.943, elev: 748, rwy: ["18L/36R", "18C/36C", "18R/36L"], artcc: "Washington Ctr", freq: { atis: "127.235", twr: "119.9", gnd: "121.9", app: "124.0", dep: "120.05", clnc: "118.55" } },
            KATL: { name: "Hartsfield-Jackson Atlanta", city: "Atlanta", state: "GA", lat: 33.641, lon: -84.428, elev: 1026, rwy: ["08L/26R", "08R/26L", "09L/27R"], artcc: "Atlanta Ctr", freq: { atis: "125.55", twr: "119.1", gnd: "121.9", app: "119.8", dep: "125.0", clnc: "121.65" } },
            KJFK: { name: "John F Kennedy Intl", city: "New York", state: "NY", lat: 40.641, lon: -73.778, elev: 13, rwy: ["04L/22R", "04R/22L", "13L/31R"], artcc: "New York Ctr", freq: { atis: "128.725", twr: "119.1", gnd: "121.9", app: "120.8", dep: "123.7", clnc: "135.05" } },
            KORD: { name: "O'Hare Intl", city: "Chicago", state: "IL", lat: 41.974, lon: -87.907, elev: 672, rwy: ["09L/27R", "09C/27C", "10L/28R"], artcc: "Chicago Ctr", freq: { atis: "135.4", twr: "120.75", gnd: "121.75", app: "124.35", dep: "125.0", clnc: "118.95" } },
            KLAX: { name: "Los Angeles Intl", city: "Los Angeles", state: "CA", lat: 33.943, lon: -118.408, elev: 128, rwy: ["06L/24R", "07L/25R", "07R/25L"], artcc: "Los Angeles Ctr", freq: { atis: "133.8", twr: "120.95", gnd: "121.75", app: "124.5", dep: "125.2", clnc: "133.65" } },
            KSFO: { name: "San Francisco Intl", city: "San Francisco", state: "CA", lat: 37.621, lon: -122.379, elev: 13, rwy: ["01L/19R", "10L/28R", "10R/28L"], artcc: "Oakland Ctr", freq: { atis: "118.85", twr: "120.5", gnd: "121.8", app: "120.35", dep: "120.9", clnc: "118.2" } },
            KDFW: { name: "Dallas/Fort Worth Intl", city: "Dallas", state: "TX", lat: 32.9, lon: -97.04, elev: 607, rwy: ["13L/31R", "17C/35C", "18L/36R"], artcc: "Fort Worth Ctr", freq: { atis: "134.9", twr: "118.75", gnd: "121.65", app: "124.15", dep: "119.2", clnc: "128.25" } },
            KDEN: { name: "Denver Intl", city: "Denver", state: "CO", lat: 39.856, lon: -104.674, elev: 5431, rwy: ["07/25", "08/26", "16L/34R", "17L/35R"], artcc: "Denver Ctr", freq: { atis: "132.35", twr: "118.3", gnd: "121.85", app: "120.8", dep: "128.25", clnc: "134.0" } },
            KMIA: { name: "Miami Intl", city: "Miami", state: "FL", lat: 25.796, lon: -80.287, elev: 8, rwy: ["08L/26R", "08R/26L", "12/30"], artcc: "Miami Ctr", freq: { atis: "132.45", twr: "118.3", gnd: "121.8", app: "124.6", dep: "125.2", clnc: "130.45" } },
            KSEA: { name: "Seattle-Tacoma Intl", city: "Seattle", state: "WA", lat: 47.45, lon: -122.309, elev: 433, rwy: ["16C/34C", "16L/34R"], artcc: "Seattle Ctr", freq: { atis: "118.0", twr: "119.9", gnd: "121.7", app: "120.4", dep: "120.1", clnc: "128.0" } },
            KBOS: { name: "Boston Logan Intl", city: "Boston", state: "MA", lat: 42.366, lon: -71.01, elev: 20, rwy: ["04L/22R", "09/27", "15L/33R"], artcc: "Boston Ctr", freq: { atis: "128.8", twr: "119.1", gnd: "121.9", app: "120.6", dep: "133.0", clnc: "121.65" } },
            KPHX: { name: "Phoenix Sky Harbor", city: "Phoenix", state: "AZ", lat: 33.437, lon: -112.008, elev: 1135, rwy: ["07L/25R", "07R/25L"], artcc: "Albuquerque Ctr", freq: { atis: "127.575", twr: "118.7", gnd: "119.75", app: "119.2", dep: "120.7", clnc: "120.65" } },
            KMCO: { name: "Orlando Intl", city: "Orlando", state: "FL", lat: 28.431, lon: -81.308, elev: 96, rwy: ["17L/35R", "17R/35L"], artcc: "Jacksonville Ctr", freq: { atis: "124.8", twr: "118.45", gnd: "121.8", app: "124.8", dep: "125.85", clnc: "121.15" } },
            KCHS: { name: "Charleston Intl", city: "Charleston", state: "SC", lat: 32.899, lon: -80.041, elev: 46, rwy: ["03/21", "15/33"], artcc: "Jacksonville Ctr", freq: { atis: "128.475", twr: "118.6", gnd: "121.8", app: "119.3", dep: "126.0", clnc: "121.75" } },
            KGSP: { name: "Greenville-Spartanburg", city: "Greenville", state: "SC", lat: 34.896, lon: -82.219, elev: 964, rwy: ["04/22"], artcc: "Atlanta Ctr", freq: { atis: "121.1", twr: "120.5", gnd: "121.7", app: "119.0", dep: "124.4", clnc: "121.8" } },
            KCAE: { name: "Columbia Metropolitan", city: "Columbia", state: "SC", lat: 33.939, lon: -81.12, elev: 236, rwy: ["05/23", "11/29"], artcc: "Atlanta Ctr", freq: { atis: "119.3", twr: "119.5", gnd: "121.9", app: "119.0", dep: "124.4", clnc: "124.0" } },
            KRDU: { name: "Raleigh-Durham Intl", city: "Raleigh", state: "NC", lat: 35.878, lon: -78.788, elev: 435, rwy: ["05L/23R", "05R/23L"], artcc: "Washington Ctr", freq: { atis: "128.0", twr: "118.3", gnd: "121.9", app: "124.8", dep: "125.3", clnc: "121.15" } },
            KIAD: { name: "Washington Dulles Intl", city: "Washington", state: "DC", lat: 38.947, lon: -77.46, elev: 313, rwy: ["01L/19R", "01C/19C"], artcc: "Washington Ctr", freq: { atis: "134.85", twr: "120.1", gnd: "121.9", app: "120.45", dep: "125.05", clnc: "118.55" } },
            KMSY: { name: "New Orleans Intl", city: "New Orleans", state: "LA", lat: 29.993, lon: -90.258, elev: 4, rwy: ["02/20", "11/29"], artcc: "Houston Ctr", freq: { atis: "128.35", twr: "119.45", gnd: "121.9", app: "123.8", dep: "120.6", clnc: "119.05" } },
            KCVG: { name: "Cincinnati/N Kentucky", city: "Cincinnati", state: "OH", lat: 39.049, lon: -84.662, elev: 896, rwy: ["09/27", "18C/36C"], artcc: "Indianapolis Ctr", freq: { atis: "127.375", twr: "118.3", gnd: "121.7", app: "119.7", dep: "125.8", clnc: "121.75" } }
        };

        const AIRCRAFT = [
            { id: "c172", name: "Cessna 172 Skyhawk", cat: "SEL", kts: 120 },
            { id: "c182", name: "Cessna 182 Skylane", cat: "SEL", kts: 145 },
            { id: "pa28", name: "Piper Cherokee", cat: "SEL", kts: 128 },
            { id: "be36", name: "Bonanza A36", cat: "SEL", kts: 170 },
            { id: "sr22", name: "Cirrus SR22", cat: "SEL", kts: 180 },
            { id: "pa44", name: "Piper Seminole", cat: "MEL", kts: 163 },
            { id: "be58", name: "Baron 58", cat: "MEL", kts: 200 },
            { id: "tbm9", name: "TBM 960", cat: "SET", kts: 330 },
            { id: "pc12", name: "Pilatus PC-12", cat: "SET", kts: 280 },
            { id: "other", name: "Other", cat: "-", kts: 150 },
        ];

        // Returns airport from cache (sync). Trims whitespace before lookup.
        function getAirport(icao) {
            if (!icao) return null;
            icao = icao.trim().toUpperCase();
            return AIRPORTS[icao] || null;
        }

        // In-flight fetch guard to prevent duplicate API calls
        const _fetchingIcaos = new Set();

        // Fetch real airport data from Aviation Weather Center API and cache it.
        // Returns a promise that resolves with the airport object (or null on failure).
        async function fetchAirportInfo(icao) {
            if (!icao) return null;
            icao = icao.trim().toUpperCase();
            if (icao.length !== 4) return null;
            if (AIRPORTS[icao]) return AIRPORTS[icao];
            if (_fetchingIcaos.has(icao)) return null;
            _fetchingIcaos.add(icao);
            try {
                const res = await fetch(
                    `https://aviationweather.gov/api/data/airport?ids=${icao}&format=json`,
                    { signal: AbortSignal.timeout(6000) }
                );
                if (!res.ok) return null;
                const data = await res.json();
                if (!data || data.length === 0) return null;
                const a = data[0];
                if (!a.lat || !a.lon) return null;
                const apt = {
                    name: a.name || icao + " Airport",
                    city: a.city || icao,
                    state: a.state || "US",
                    lat: parseFloat(a.lat),
                    lon: parseFloat(a.lon),
                    elev: parseInt(a.elev) || 0,
                    rwy: ["18/36", "09/27"],
                    artcc: "Center",
                    freq: { atis: "120.0", twr: "118.0", gnd: "121.9", app: "124.0", dep: "125.0", clnc: "121.5" }
                };
                AIRPORTS[icao] = apt;
                return apt;
            } catch(e) {
                return null;
            } finally {
                _fetchingIcaos.delete(icao);
            }
        }

        function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function randInt(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }

        function calcDist(lat1, lon1, lat2, lon2) {
            var R = 3440.065;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function calcBearing(lat1, lon1, lat2, lon2) {
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
            var x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) - Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
            return ((Math.atan2(y, x) * 180 / Math.PI) + 360) % 360;
        }

        function makeMetar(icao) {
            var apt = getAirport(icao);
            if (!apt) { return null; }
            var now = new Date();
            var dd = String(now.getUTCDate()).padStart(2, "0");
            var hh = String(now.getUTCHours()).padStart(2, "0");
            var mm = String(now.getUTCMinutes()).padStart(2, "0");
            var wdir = pick(["18", "24", "27", "33", "36", "09", "VRB"]);
            var wspd = randInt(4, 22);
            var gust = wspd > 12 ? "G" + (wspd + randInt(5, 12)) : "";
            var wind = wdir === "VRB" ? "VRB" + String(wspd).padStart(2, "0") + "KT" : wdir + "0" + String(wspd).padStart(2, "0") + gust + "KT";
            var vis = pick(["10SM", "10SM", "P6SM", "8SM", "6SM", "3SM", "1 1/2SM"]);
            var skyOptions = [
                { raw: "CLR", cat: "VFR" }, { raw: "FEW040", cat: "VFR" }, { raw: "FEW250", cat: "VFR" },
                { raw: "SCT025", cat: "MVFR" }, { raw: "SCT045 BKN120", cat: "MVFR" },
                { raw: "BKN015", cat: "MVFR" }, { raw: "BKN030", cat: "MVFR" },
                { raw: "OVC008", cat: "IFR" }, { raw: "OVC004", cat: "LIFR" }
            ];
            var sky = pick(skyOptions);
            var temp = randInt(5, 35);
            var dewp = temp - randInt(2, 10);
            var tempStr = (temp < 10 ? "0" : "") + temp + "/" + (dewp < 0 ? "M" : "") + (Math.abs(dewp) < 10 ? "0" : "") + Math.abs(dewp);
            var alt = "A" + pick(["2976", "2985", "2992", "2998", "3001", "3005", "3012"]);
            var cat = sky.cat;
            if (vis === "3SM" || vis === "1 1/2SM") { cat = "IFR"; }
            var wdirNum = wdir === "VRB" ? null : parseInt(wdir) * 10;
            return {
                raw: icao + " " + dd + hh + mm + "Z " + wind + " " + vis + " " + sky.raw + " " + tempStr + " " + alt + " RMK AO2",
                wind: wind, vis: vis, sky: sky.raw, temp: tempStr, alt: alt, cat: cat, wspd: wspd, wdir: wdirNum
            };
        }

        function makeTaf(icao) {
            var now = new Date();
            var dd = String(now.getUTCDate()).padStart(2, "0");
            var hh = String(now.getUTCHours()).padStart(2, "0");
            var h6 = String((parseInt(hh) + 6) % 24).padStart(2, "0");
            var h12 = String((parseInt(hh) + 12) % 24).padStart(2, "0");
            var h18 = String((parseInt(hh) + 18) % 24).padStart(2, "0");
            return "TAF " + icao + " " + dd + hh + "00Z 24012KT P6SM FEW040 SCT250 TEMPO 28015G22KT BKN030 FM" + h12 + "00 18008KT P6SM SCT060 BECMG " + h18 + "00 VRB05KT FEW250";
        }

        function makeNotams(icao) {
            var all = [
                { type: "RWY", severity: "warning", text: "!" + icao + " RWY 18L/36R CLSD MAINT 0600-1400Z" },
                { type: "OBST", severity: "tertiary", text: "!" + icao + " CRANE 450FT AGL 1.2NM NW LGTD" },
                { type: "TFR", severity: "error", text: "!" + icao + " TFR 3NM SFC-3000FT VIP" }
            ];
            return all.slice(0, 1 + randInt(0, 2));
        }

        function makePireps(dep, arr) {
            return [
                { type: "UA", text: "/OV " + dep + "-" + arr + "/FL085/TP C172/SK SCT045/TB LGT/RM SMOOTH ABV 060" },
                { type: "UA", text: "/OV " + dep + "090020/FL120/TP B738/TB MDT 080-120/IC LGT RIME" }
            ].slice(0, 1 + randInt(0, 1));
        }

        function makeForecast(icao) {
            var forecasts = [];
            var now = new Date();
            for (var i = 0; i < 7; i++) {
                var dt = new Date(now);
                dt.setDate(dt.getDate() + i);
                var seed = (icao.charCodeAt(1) + i * 7) % 10;
                var cat, hi, lo, ws, pr;
                if (seed <= 4) { cat = "VFR"; hi = randInt(65, 85); lo = hi - randInt(12, 20); ws = randInt(4, 12); pr = 0; }
                else if (seed <= 6) { cat = "MVFR"; hi = randInt(55, 75); lo = hi - randInt(10, 18); ws = randInt(8, 18); pr = randInt(10, 40); }
                else if (seed <= 8) { cat = "IFR"; hi = randInt(45, 65); lo = hi - randInt(8, 15); ws = randInt(12, 25); pr = randInt(50, 80); }
                else { cat = "LIFR"; hi = randInt(40, 60); lo = hi - randInt(5, 12); ws = randInt(5, 15); pr = randInt(60, 95); }
                forecasts.push({
                    dayName: dt.toLocaleDateString("en-US", { weekday: "short" }),
                    dateStr: dt.toLocaleDateString("en-US", { month: "short", day: "numeric" }),
                    cat: cat, hi: hi, lo: lo, ws: ws, pr: pr
                });
            }
            return forecasts;
        }

        function calcGoScore(dep, arr) {
            var dm = makeMetar(dep);
            var am = makeMetar(arr);
            if (!dm || !am) { return 50; }
            var catScores = { VFR: 95, MVFR: 65, IFR: 30, LIFR: 10 };
            var windPen = Math.max(0, (dm.wspd - 15) * 3) + Math.max(0, (am.wspd - 15) * 3);
            var score = Math.round((catScores[dm.cat] || 50) * 0.45 + (catScores[am.cat] || 50) * 0.45 - windPen + randInt(-5, 5));
            return Math.max(5, Math.min(99, score));
        }

        function getGoColor(s) { return s >= 75 ? "var(--md-sys-color-primary)" : s >= 50 ? "var(--md-sys-color-warning)" : "var(--md-sys-color-error)"; }

        // Fetch live METAR from Aviation Weather Center API
        async function fetchLiveMetar(icao) {
            if (!icao) return null;
            icao = icao.trim().toUpperCase();
            try {
                const res = await fetch(
                    `https://aviationweather.gov/api/data/metar?ids=${icao}&format=json&hours=2`,
                    { signal: AbortSignal.timeout(8000) }
                );
                if (!res.ok) return null;
                const data = await res.json();
                if (!data || data.length === 0) return null;
                const m = data[0];
                const wspd = m.wspd || 0;
                const wdir = m.wdir || 0;
                const wgst = m.wgst || 0;
                const visib = m.visib != null ? m.visib : 10;
                const temp = m.temp != null ? m.temp : 15;
                const dewp = m.dewp != null ? m.dewp : 5;
                const altim = m.altim || 29.92;
                const wdirStr = wdir === 0 ? "VRB" : String(wdir).padStart(3, "0");
                const wspdStr = String(wspd).padStart(2, "0");
                const gustStr = wgst > 0 ? `G${String(wgst).padStart(2, "0")}` : "";
                const wind = `${wdirStr}${wspdStr}${gustStr}KT`;
                const visStr = visib >= 6 ? "P6SM" : `${visib}SM`;
                let skyStr = "CLR";
                if (m.skyCondition && m.skyCondition.length > 0) {
                    skyStr = m.skyCondition.map(s => `${s.skyCover}${s.cloudBase ? String(Math.round(s.cloudBase / 100)).padStart(3, "0") : ""}`).join(" ");
                }
                const tI = Math.round(temp), dI = Math.round(dewp);
                const tempStr = `${tI < 0 ? "M" : ""}${Math.abs(tI) < 10 ? "0" : ""}${Math.abs(tI)}/${dI < 0 ? "M" : ""}${Math.abs(dI) < 10 ? "0" : ""}${Math.abs(dI)}`;
                const altStr = `A${String(Math.round(altim * 100)).padStart(4, "0")}`;
                return {
                    raw: m.rawOb || `${icao} LIVE METAR`,
                    wind, vis: visStr, sky: skyStr, temp: tempStr, alt: altStr,
                    cat: m.fltcat || "VFR", wspd, wdir: wdir > 0 ? wdir : null
                };
            } catch(e) { return null; }
        }

        // Fetch live TAF from Aviation Weather Center API
        async function fetchLiveTaf(icao) {
            if (!icao) return null;
            icao = icao.trim().toUpperCase();
            try {
                const res = await fetch(
                    `https://aviationweather.gov/api/data/taf?ids=${icao}&format=json`,
                    { signal: AbortSignal.timeout(8000) }
                );
                if (!res.ok) return null;
                const data = await res.json();
                if (!data || data.length === 0) return null;
                return data[0].rawTAF || null;
            } catch(e) { return null; }
        }

        // Fetch 7-day forecast from NWS API for a lat/lon
        async function fetchNwsForecast(lat, lon) {
            if (lat == null || lon == null) return null;
            try {
                const pointsRes = await fetch(
                    `https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`,
                    { signal: AbortSignal.timeout(8000), headers: { "Accept": "application/geo+json" } }
                );
                if (!pointsRes.ok) return null;
                const pointsData = await pointsRes.json();
                const forecastUrl = pointsData?.properties?.forecast;
                if (!forecastUrl) return null;
                const forecastRes = await fetch(forecastUrl, { signal: AbortSignal.timeout(8000), headers: { "Accept": "application/geo+json" } });
                if (!forecastRes.ok) return null;
                const forecastData = await forecastRes.json();
                const periods = forecastData?.properties?.periods;
                if (!periods || periods.length === 0) return null;
                var days = [];
                for (var i = 0; i < periods.length && days.length < 7; i++) {
                    var p = periods[i];
                    if (p.isDaytime) {
                        var dt = new Date(p.startTime);
                        var cat = "VFR";
                        var name = (p.shortForecast || "").toLowerCase();
                        if (name.includes("fog") || name.includes("freezing")) cat = "LIFR";
                        else if (name.includes("rain") || name.includes("snow") || name.includes("storm") || name.includes("shower")) cat = "IFR";
                        else if (name.includes("cloud") || name.includes("overcast") || name.includes("drizzle")) cat = "MVFR";
                        days.push({
                            dayName: dt.toLocaleDateString("en-US", { weekday: "short" }),
                            dateStr: dt.toLocaleDateString("en-US", { month: "short", day: "numeric" }),
                            cat, hi: p.temperature,
                            lo: periods[i + 1]?.temperature || (p.temperature - 15),
                            ws: parseInt(p.windSpeed) || 0, pr: 0
                        });
                    }
                }
                return days.length > 0 ? days : null;
            } catch(e) { return null; }
        }

        // Calculate Go/No-Go score from live METAR objects
        function calcGoScoreFromMetars(depMetar, arrMetar) {
            if (!depMetar || !arrMetar) return 50;
            var catScores = { VFR: 95, MVFR: 65, IFR: 30, LIFR: 10 };
            var windPen = Math.max(0, (depMetar.wspd - 15) * 3) + Math.max(0, (arrMetar.wspd - 15) * 3);
            var score = Math.round(
                (catScores[depMetar.cat] || 50) * 0.45 +
                (catScores[arrMetar.cat] || 50) * 0.45 - windPen
            );
            return Math.max(5, Math.min(99, score));
        }

        /* =========================================
           MATERIAL DESIGN 3 REACT COMPONENTS
        ========================================= */

        const MdIcon = ({ name, style, className = '' }) => (
            <span className={`material-symbols-outlined ${className}`} style={style}>{name}</span>
        );

        const MdButton = ({ onClick, variant = 'primary', icon, children, disabled, style = {} }) => {
            const baseStyle = {
                display: 'inline-flex', alignItems: 'center', justifyContent: 'center', gap: '8px',
                padding: '10px 24px', borderRadius: '9999px', fontSize: '14px', fontWeight: '500',
                border: 'none', cursor: disabled ? 'not-allowed' : 'pointer',
                fontFamily: 'inherit', letterSpacing: '0.1px',
                opacity: disabled ? 0.5 : 1, ...style
            };

            const variants = {
                primary: {
                    background: 'var(--md-sys-color-primary)',
                    color: 'var(--md-sys-color-on-primary)'
                },
                tonal: {
                    background: 'var(--md-sys-color-secondary-container)',
                    color: 'var(--md-sys-color-on-secondary-container)'
                },
                text: {
                    background: 'transparent',
                    color: 'var(--md-sys-color-primary)',
                    padding: '10px 16px'
                },
                sparkle: {
                    background: 'linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary))',
                    color: 'var(--md-sys-color-on-primary)',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
                }
            };

            return (
                <button 
                    onClick={onClick} 
                    disabled={disabled}
                    style={{ ...baseStyle, ...variants[variant] }}
                    onMouseOver={(e) => { if (!disabled) e.currentTarget.style.filter = 'brightness(0.9)'; }}
                    onMouseOut={(e) => { if (!disabled) e.currentTarget.style.filter = 'none'; }}
                >
                    {icon && <MdIcon name={icon} style={{ fontSize: '18px' }} />}
                    {children}
                </button>
            );
        };

        const MdCard = ({ children, style = {}, onClick }) => {
            return (
                <div 
                    onClick={onClick}
                    style={{
                        background: 'var(--md-sys-color-surface-container)',
                        borderRadius: '16px',
                        padding: '16px',
                        color: 'var(--md-sys-color-on-surface)',
                        cursor: onClick ? 'pointer' : 'default',
                        transition: 'background 0.2s',
                        ...style
                    }}
                    onMouseOver={(e) => { if (onClick) e.currentTarget.style.background = 'var(--md-sys-color-surface-container-high)'; }}
                    onMouseOut={(e) => { if (onClick) e.currentTarget.style.background = 'var(--md-sys-color-surface-container)'; }}
                >
                    {children}
                </div>
            );
        };

        const MdInput = ({ label, value, onChange, type = "text", placeholder, maxLength, containerStyle = {} }) => {
            return (
                <div style={{ display: "flex", flexDirection: "column", gap: "4px", minWidth: 0, ...containerStyle }}>
                    {label && <label style={{ fontSize: "12px", fontWeight: "500", color: "var(--md-sys-color-on-surface-variant)" }}>{label}</label>}
                    <input 
                        type={type} value={value} onChange={onChange} placeholder={placeholder} maxLength={maxLength}
                        style={{
                            background: "var(--md-sys-color-surface-variant)",
                            border: "none",
                            borderBottom: "2px solid var(--md-sys-color-outline)",
                            borderRadius: "4px 4px 0 0",
                            padding: "12px 16px",
                            color: "var(--md-sys-color-on-surface)",
                            fontFamily: "inherit", fontSize: "16px", outline: "none",
                            width: "100%", boxSizing: "border-box"
                        }}
                        onFocus={(e) => e.target.style.borderBottomColor = "var(--md-sys-color-primary)"}
                        onBlur={(e) => e.target.style.borderBottomColor = "var(--md-sys-color-outline)"}
                    />
                </div>
            );
        };

        const MdSelect = ({ label, value, onChange, options, containerStyle = {} }) => {
            return (
                <div style={{ display: "flex", flexDirection: "column", gap: "4px", minWidth: 0, ...containerStyle }}>
                    {label && <label style={{ fontSize: "12px", fontWeight: "500", color: "var(--md-sys-color-on-surface-variant)" }}>{label}</label>}
                    <select 
                        value={value} onChange={onChange}
                        style={{
                            background: "var(--md-sys-color-surface-variant)",
                            border: "none", borderBottom: "2px solid var(--md-sys-color-outline)",
                            borderRadius: "4px 4px 0 0", padding: "12px 16px",
                            color: "var(--md-sys-color-on-surface)",
                            fontFamily: "inherit", fontSize: "16px", outline: "none",
                            width: "100%", boxSizing: "border-box"
                        }}
                        onFocus={(e) => e.target.style.borderBottomColor = "var(--md-sys-color-primary)"}
                        onBlur={(e) => e.target.style.borderBottomColor = "var(--md-sys-color-outline)"}
                    >
                        {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                    </select>
                </div>
            );
        };

        function CatBadge({ cat }) {
            const lc = cat.toLowerCase();
            return (
                <span className="font-mono" style={{ 
                    display: "inline-flex", padding: "2px 12px", borderRadius: "12px", 
                    fontSize: "11px", fontWeight: "700",
                    background: `var(--cat-${lc}-bg)`, color: `var(--cat-${lc}-color)` 
                }}>{cat}</span>
            );
        }

        /* =========================================
           APP COMPONENTS
        ========================================= */

        function GoScoreRing({ score, size = 100 }) {
            var r = (size - 10) / 2;
            var circ = 2 * Math.PI * r;
            var col = getGoColor(score);
            return (
                <div style={{ position: "relative", width: size, height: size }}>
                    <svg width={size} height={size} style={{ transform: "rotate(-90deg)" }}>
                        <circle cx={size / 2} cy={size / 2} r={r} fill="none" stroke="var(--md-sys-color-surface-container-highest)" strokeWidth="6" />
                        <circle cx={size / 2} cy={size / 2} r={r} fill="none" stroke={col} strokeWidth="6" strokeDasharray={circ} strokeDashoffset={circ * (1 - score / 100)} strokeLinecap="round" style={{ transition: "stroke-dashoffset 0.8s ease-out" }} />
                    </svg>
                    <div style={{ position: "absolute", inset: 0, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center" }}>
                        <div style={{ fontSize: size * 0.3, fontWeight: 700, color: col, lineHeight: 1 }}>{score}</div>
                        <div className="font-mono" style={{ fontSize: size * 0.1, color: "var(--md-sys-color-on-surface-variant)", fontWeight: 600, letterSpacing: "0.05em", marginTop: 2 }}>SCORE</div>
                    </div>
                </div>
            );
        }

        function RouteMap({ dep, arr, wps }) {
            const { useRef: useRefMap, useEffect: useEffectMap } = React;
            const mapContainerRef = useRefMap(null);
            const leafletMapRef = useRefMap(null);
            const layersRef = useRefMap([]);

            var allCodes = [dep].concat(wps || []).concat([arr]).filter(c => c && c.trim().length === 4);
            var allPts = allCodes.map(c => getAirport(c)).filter(Boolean);

            var totalDist = 0;
            var heading = 0;
            if (allPts.length >= 2) {
                for (var di = 0; di < allPts.length - 1; di++) {
                    totalDist += calcDist(allPts[di].lat, allPts[di].lon, allPts[di+1].lat, allPts[di+1].lon);
                }
                heading = calcBearing(allPts[0].lat, allPts[0].lon, allPts[allPts.length-1].lat, allPts[allPts.length-1].lon);
            }

            useEffectMap(() => {
                const L = window.L;
                if (!L || !mapContainerRef.current) return;

                // Initialize map once
                if (!leafletMapRef.current) {
                    leafletMapRef.current = L.map(mapContainerRef.current, { zoomControl: true });
                    L.tileLayer(
                        'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
                        { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>', subdomains: 'abcd', maxZoom: 19 }
                    ).addTo(leafletMapRef.current);
                }
                const map = leafletMapRef.current;

                // Remove previous route layers
                layersRef.current.forEach(l => map.removeLayer(l));
                layersRef.current = [];

                if (allPts.length < 2) return;

                const latLngs = allPts.map(p => [p.lat, p.lon]);

                // Route polyline
                const line = L.polyline(latLngs, { color: '#0b57d0', weight: 3, dashArray: '8 5', opacity: 0.9 });
                line.addTo(map);
                layersRef.current.push(line);

                // Waypoint markers
                const colors = { dep: '#0b57d0', arr: '#6b5778', wp: '#535f70' };
                allPts.forEach((p, i) => {
                    const isDep = i === 0, isArr = i === allPts.length - 1;
                    const color = isDep ? colors.dep : isArr ? colors.arr : colors.wp;
                    const marker = L.circleMarker([p.lat, p.lon], {
                        radius: (isDep || isArr) ? 9 : 7,
                        fillColor: color, color: '#fff', weight: 2, fillOpacity: 1
                    });
                    marker.addTo(map);
                    marker.bindTooltip(allCodes[i], { permanent: true, direction: 'top', offset: [0, -8], className: 'route-icao-label' });
                    layersRef.current.push(marker);
                });

                map.fitBounds(latLngs, { padding: [50, 50] });
            }, [dep, arr, JSON.stringify(wps), allPts.length]);

            // Cleanup on unmount
            useEffectMap(() => {
                return () => {
                    if (leafletMapRef.current) {
                        leafletMapRef.current.remove();
                        leafletMapRef.current = null;
                    }
                };
            }, []);

            if (allPts.length < 2) {
                return (
                    <div style={{ display: "flex", alignItems: "center", justifyContent: "center", background: "var(--md-sys-color-surface-container-lowest)", borderRadius: "16px", minHeight: "420px" }}>
                        <span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: "14px" }}>Enter valid route to view map</span>
                    </div>
                );
            }

            return (
                <div style={{ position: "relative", borderRadius: "16px", overflow: "hidden" }}>
                    <div ref={mapContainerRef} style={{ width: "100%", height: "420px" }} />
                    <div className="font-mono" style={{ position: "absolute", bottom: 36, left: 12, zIndex: 1000, display: "flex", gap: 8, fontSize: 12, pointerEvents: "none" }}>
                        <div style={{ background: "rgba(255,255,255,0.95)", borderRadius: "8px", padding: "6px 12px", color: "#1a1c1e", boxShadow: "0 2px 6px rgba(0,0,0,0.18)" }}>
                            <span style={{ color: "#73777f" }}>DIST </span><span style={{ fontWeight: 700 }}>{Math.round(totalDist)} NM</span>
                        </div>
                        <div style={{ background: "rgba(255,255,255,0.95)", borderRadius: "8px", padding: "6px 12px", color: "#1a1c1e", boxShadow: "0 2px 6px rgba(0,0,0,0.18)" }}>
                            <span style={{ color: "#73777f" }}>HDG </span><span style={{ fontWeight: 700 }}>{String(Math.round(heading)).padStart(3, "0")}&deg;</span>
                        </div>
                    </div>
                </div>
            );
        }

        function ForecastStrip({ icao, selectedDay, onSelect }) {
            const [forecasts, setForecasts] = useState(null);
            const [isLive, setIsLive] = useState(false);

            useEffect(() => {
                setForecasts(null);
                setIsLive(false);
                var apt = getAirport(icao);
                if (apt) {
                    fetchNwsForecast(apt.lat, apt.lon).then(data => {
                        if (data) { setForecasts(data); setIsLive(true); }
                        else setForecasts(makeForecast(icao));
                    }).catch(() => setForecasts(makeForecast(icao)));
                } else {
                    fetchAirportInfo(icao).then(a => {
                        if (a) {
                            fetchNwsForecast(a.lat, a.lon).then(data => {
                                if (data) { setForecasts(data); setIsLive(true); }
                                else setForecasts(makeForecast(icao));
                            }).catch(() => setForecasts(makeForecast(icao)));
                        } else {
                            setForecasts(makeForecast(icao));
                        }
                    }).catch(() => setForecasts(makeForecast(icao)));
                }
            }, [icao]);

            var items = forecasts || makeForecast(icao);

            return (
                <div>
                    <div style={{ fontSize: 11, color: "var(--md-sys-color-on-surface-variant)", marginBottom: 6, display: "flex", alignItems: "center", gap: 4 }}>
                        <MdIcon name="calendar_month" style={{ fontSize: 13 }} />
                        7-Day Forecast
                        {isLive && <span style={{ color: "var(--md-sys-color-primary)", fontWeight: 700, fontSize: 10, background: "var(--md-sys-color-primary-container)", borderRadius: 4, padding: "1px 5px", marginLeft: 4 }}>NWS LIVE</span>}
                    </div>
                    <div style={{ display: "flex", gap: 8, overflowX: "auto", padding: "4px 0", WebkitOverflowScrolling: "touch" }}>
                        {items.map((f, i) => {
                            var selected = selectedDay === i;
                            var lc = f.cat.toLowerCase();
                            return (
                                <button key={i} onClick={() => onSelect(i)} style={{
                                    flex: "0 0 auto", minWidth: 72, padding: "12px 8px", borderRadius: "12px",
                                    border: selected ? `2px solid var(--cat-${lc}-color)` : "2px solid transparent",
                                    background: selected ? `var(--cat-${lc}-bg)` : "var(--md-sys-color-surface-container-high)",
                                    cursor: "pointer", textAlign: "center", transition: "all 0.2s"
                                }}>
                                    <div style={{ fontSize: 12, fontWeight: 700, color: selected ? `var(--cat-${lc}-color)` : "var(--md-sys-color-on-surface)", marginBottom: 2 }}>{f.dayName}</div>
                                    <div style={{ fontSize: 10, color: "var(--md-sys-color-on-surface-variant)", marginBottom: 8 }}>{f.dateStr}</div>
                                    <CatBadge cat={f.cat} />
                                    <div style={{ fontSize: 12, color: "var(--md-sys-color-on-surface)", marginTop: 8, fontWeight: 500 }}>{f.hi}&deg; <span style={{color: "var(--md-sys-color-on-surface-variant)"}}>{f.lo}&deg;</span></div>
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function WindyMap({ dep, arr, wps }) {
            var allPts = useMemo(() => [dep, ...(wps || []), arr].map(getAirport).filter(Boolean), [dep, arr, JSON.stringify(wps)]);
            if (allPts.length < 2) return null;
            var midLat = allPts.reduce((s, p) => s + p.lat, 0) / allPts.length;
            var midLon = allPts.reduce((s, p) => s + p.lon, 0) / allPts.length;
            var src = `https://embed.windy.com/embed2.html?lat=${midLat.toFixed(2)}&lon=${midLon.toFixed(2)}&detailLat=${midLat.toFixed(2)}&detailLon=${midLon.toFixed(2)}&zoom=6&level=surface&overlay=wind&product=ecmwf&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=kt&metricTemp=%C2%B0F&radarRange=-1`;
            return (
                <div style={{ marginTop: 24 }}>
                    <h2 style={{ fontSize: 16, fontWeight: 500, margin: "0 0 12px", color: "var(--md-sys-color-on-surface)", display: "flex", alignItems: "center", gap: 8 }}>
                        <MdIcon name="storm" style={{ color: "var(--md-sys-color-primary)" }} />
                        Live Wind &amp; Weather Radar
                    </h2>
                    <div style={{ borderRadius: "16px", overflow: "hidden", border: "1px solid var(--md-sys-color-outline-variant)" }}>
                        <iframe src={src} style={{ width: "100%", height: "450px", border: "none" }} allowFullScreen title="Windy Weather Radar" />
                    </div>
                </div>
            );
        }

        // Returns the best runway and crosswind component given a metar and airport.
        // Picks the runway end with the smallest crosswind component.
        function getRunwayRecommendation(metar, apt) {
            if (!metar || !apt || !apt.rwy || apt.rwy.length === 0) return null;
            if (metar.wdir == null || !metar.wspd || metar.wspd < 3) return null;
            var windDir = metar.wdir;
            var windSpd = metar.wspd;
            var best = null;
            var bestCross = Infinity;
            apt.rwy.forEach(function(rwyPair) {
                rwyPair.split("/").forEach(function(rwyEnd) {
                    var m = rwyEnd.match(/^(\d+)/);
                    if (!m) return;
                    var rwyHdg = parseInt(m[1]) * 10;
                    var angle = ((windDir - rwyHdg) % 360 + 360) % 360;
                    if (angle > 180) angle -= 360;
                    var rad = angle * Math.PI / 180;
                    var cross = Math.abs(windSpd * Math.sin(rad));
                    var head = windSpd * Math.cos(rad);
                    if (cross < bestCross) {
                        bestCross = cross;
                        best = { rwy: rwyEnd, crosswind: Math.round(cross), headwind: Math.round(head) };
                    }
                });
            });
            return best;
        }

        function WeatherDetail({ icao, label }) {
            const [expanded, setExpanded] = useState(false);
            const [aptReady, setAptReady] = useState(!!AIRPORTS[icao]);
            const [liveMetar, setLiveMetar] = useState(null);
            const [liveTaf, setLiveTaf] = useState(null);
            const [loadingWx, setLoadingWx] = useState(true);

            useEffect(() => {
                if (!AIRPORTS[icao]) {
                    fetchAirportInfo(icao).then(a => { if (a) setAptReady(true); });
                }
            }, [icao]);

            useEffect(() => {
                setLoadingWx(true);
                setLiveMetar(null);
                setLiveTaf(null);
                Promise.all([fetchLiveMetar(icao), fetchLiveTaf(icao)]).then(([m, t]) => {
                    setLiveMetar(m);
                    setLiveTaf(t);
                    setLoadingWx(false);
                });
            }, [icao]);

            var metar = liveMetar || (aptReady ? makeMetar(icao) : null);
            var taf = liveTaf || makeTaf(icao);
            var apt = getAirport(icao);
            if (!apt && !loadingWx) { return null; }
            if (!metar && !loadingWx) { return null; }

            return (
                <MdCard style={{ marginBottom: '16px' }}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 16 }}>
                        <div>
                            <div style={{ fontSize: 12, fontWeight: 600, color: "var(--md-sys-color-primary)", textTransform: "uppercase", letterSpacing: "0.5px", marginBottom: 4 }}>{label}</div>
                            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                <span className="font-mono" style={{ fontSize: 20, fontWeight: 700 }}>{icao}</span>
                                {apt && <span style={{ fontSize: 14, color: "var(--md-sys-color-on-surface-variant)" }}>{apt.city}, {apt.state}</span>}
                                {liveMetar && <span style={{ fontSize: 10, color: "var(--md-sys-color-primary)", background: "var(--md-sys-color-primary-container)", borderRadius: 4, padding: "2px 6px", fontWeight: 700, letterSpacing: "0.5px" }}>LIVE</span>}
                                {loadingWx && <MdIcon name="sync" style={{ fontSize: 14, color: "var(--md-sys-color-on-surface-variant)", animation: "spin 1s linear infinite" }} />}
                            </div>
                        </div>
                        {metar && <CatBadge cat={metar.cat} />}
                    </div>

                    {loadingWx && !metar && (
                        <div style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 13, padding: "8px 0" }}>Fetching live weather data...</div>
                    )}

                    {metar && (
                        <>
                            <div className="font-mono" style={{ background: "var(--md-sys-color-surface-container-lowest)", borderRadius: "8px", padding: "12px", fontSize: 13, color: "var(--md-sys-color-on-surface)", lineHeight: 1.6, wordBreak: "break-all", marginBottom: 16, border: "1px solid var(--md-sys-color-outline-variant)" }}>{metar.raw}</div>

                            <div className="font-mono" style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(100px, 1fr))", gap: "12px 16px", fontSize: 13 }}>
                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 11, display: 'block' }}>WIND</span><span style={{ fontWeight: 600 }}>{metar.wind}</span></div>
                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 11, display: 'block' }}>VIS</span><span style={{ fontWeight: 600 }}>{metar.vis}</span></div>
                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 11, display: 'block' }}>SKY</span><span style={{ fontWeight: 600 }}>{metar.sky}</span></div>
                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 11, display: 'block' }}>TEMP</span><span style={{ fontWeight: 600 }}>{metar.temp}</span></div>
                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 11, display: 'block' }}>ALTM</span><span style={{ fontWeight: 600 }}>{metar.alt}</span></div>
                            </div>

                            {(() => {
                                var rec = getRunwayRecommendation(metar, apt);
                                if (!rec) return null;
                                var crossColor = rec.crosswind <= 10
                                    ? "var(--md-sys-color-primary)"
                                    : rec.crosswind <= 15
                                        ? "var(--cat-mvfr-color)"
                                        : "var(--md-sys-color-error)";
                                return (
                                    <div style={{ marginTop: 12, paddingTop: 12, borderTop: "1px solid var(--md-sys-color-outline-variant)", display: "flex", alignItems: "center", gap: 24, flexWrap: "wrap" }}>
                                        <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                                            <MdIcon name="airline_stops" style={{ fontSize: 16, color: "var(--md-sys-color-on-surface-variant)" }} />
                                            <span style={{ fontSize: 11, color: "var(--md-sys-color-on-surface-variant)", textTransform: "uppercase", letterSpacing: "0.5px" }}>Recommended Runway</span>
                                        </div>
                                        <span className="font-mono" style={{ fontWeight: 700, fontSize: 15 }}>{rec.rwy}</span>
                                        <div>
                                            <span style={{ fontSize: 11, color: "var(--md-sys-color-on-surface-variant)", textTransform: "uppercase", letterSpacing: "0.5px" }}>Crosswind </span>
                                            <span className="font-mono" style={{ fontWeight: 700, fontSize: 14, color: crossColor }}>{rec.crosswind}KT</span>
                                        </div>
                                        {rec.headwind > 0 && (
                                            <div>
                                                <span style={{ fontSize: 11, color: "var(--md-sys-color-on-surface-variant)", textTransform: "uppercase", letterSpacing: "0.5px" }}>Headwind </span>
                                                <span className="font-mono" style={{ fontWeight: 700, fontSize: 14 }}>{rec.headwind}KT</span>
                                            </div>
                                        )}
                                    </div>
                                );
                            })()}

                            <div style={{ marginTop: 16, paddingTop: 16, borderTop: "1px solid var(--md-sys-color-outline-variant)" }}>
                                <MdButton variant="text" onClick={() => setExpanded(!expanded)} icon={expanded ? "expand_less" : "expand_more"} style={{ padding: '4px 8px', margin: '-4px -8px' }}>
                                    {expanded ? "Hide TAF" : "View TAF"}
                                </MdButton>
                                {expanded && <div className="font-mono" style={{ background: "var(--md-sys-color-surface-container-lowest)", borderRadius: "8px", padding: "12px", fontSize: 12, color: "var(--md-sys-color-on-surface)", lineHeight: 1.8, marginTop: 12 }}>{taf}</div>}
                            </div>
                        </>
                    )}
                </MdCard>
            );
        }

        function NotamsPanel({ icao }) {
            var notams = useMemo(() => makeNotams(icao), [icao]);
            var sevColors = { 
                warning: "var(--md-sys-color-error)", 
                tertiary: "var(--md-sys-color-tertiary)", 
                error: "var(--md-sys-color-error)" 
            };
            
            return (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {notams.map((n, i) => (
                        <div key={i} style={{ 
                            background: "var(--md-sys-color-surface-container)", 
                            borderRadius: "12px", padding: "12px", 
                            borderLeft: `4px solid ${sevColors[n.severity] || "var(--md-sys-color-outline)"}` 
                        }}>
                            <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4 }}>
                                <MdIcon name={n.type === 'RWY' ? 'edit_road' : n.type === 'TFR' ? 'block' : 'warning'} style={{ fontSize: 16, color: sevColors[n.severity] }} />
                                <span className="font-mono" style={{ fontSize: 12, fontWeight: 700, color: sevColors[n.severity] }}>{n.type}</span>
                            </div>
                            <div className="font-mono" style={{ fontSize: 12, color: "var(--md-sys-color-on-surface)", lineHeight: 1.5 }}>{n.text}</div>
                        </div>
                    ))}
                </div>
            );
        }

        function FreqPanel({ icao }) {
            const [aptReady, setAptReady] = useState(!!AIRPORTS[icao]);
            useEffect(() => {
                if (!AIRPORTS[icao]) {
                    fetchAirportInfo(icao).then(a => { if (a) setAptReady(true); });
                }
            }, [icao]);
            var apt = getAirport(icao);
            if (!apt) return null;
            var labels = { atis: "ATIS", twr: "Tower", gnd: "Ground", app: "Approach", dep: "Departure", clnc: "Clearance" };
            
            return (
                <MdCard style={{ marginBottom: '16px' }}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                            <MdIcon name="cell_tower" style={{ color: 'var(--md-sys-color-primary)' }} />
                            <span className="font-mono" style={{ fontSize: 18, fontWeight: 700 }}>{icao}</span>
                        </div>
                        <span style={{ fontSize: 12, color: "var(--md-sys-color-on-surface-variant)" }}>{apt.artcc}</span>
                    </div>
                    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "12px 24px" }}>
                        {Object.entries(apt.freq).map(([key, val]) => (
                            <div key={key} style={{ display: "flex", justifyContent: "space-between", alignItems: 'center', borderBottom: '1px solid var(--md-sys-color-outline-variant)', paddingBottom: 4 }}>
                                <span style={{ color: "var(--md-sys-color-on-surface-variant)", fontSize: 13 }}>{labels[key] || key}</span>
                                <span className="font-mono" style={{ color: "var(--md-sys-color-primary)", fontWeight: 600, fontSize: 15 }}>{val}</span>
                            </div>
                        ))}
                    </div>
                </MdCard>
            );
        }

        function AIBriefing({ trip }) {
            var [result, setResult] = useState(null);
            var [loading, setLoading] = useState(false);
            var [error, setError] = useState(null);
            var [apiKey, setApiKey] = useState("");

            var runBriefing = useCallback(async function() {
                if (!trip.dep || !trip.arr) return;
                setLoading(true); setError(null);

                var ac = AIRCRAFT.find(a => a.id === trip.aircraft) || AIRCRAFT[0];
                var allRoutePts = [trip.dep].concat(trip.wps || []).concat([trip.arr]);

                var distance = 0;
                for (var i = 0; i < allRoutePts.length - 1; i++) {
                    var p1 = getAirport(allRoutePts[i]);
                    var p2 = getAirport(allRoutePts[i+1]);
                    if (p1 && p2) distance += calcDist(p1.lat, p1.lon, p2.lat, p2.lon);
                }
                var ete = distance / ac.kts;

                // Pre-fetch live METARs and TAFs for all waypoints
                var wxData = await Promise.all(allRoutePts.map(async icao => {
                    var [m, t] = await Promise.all([fetchLiveMetar(icao), fetchLiveTaf(icao)]);
                    return { icao, metar: m, taf: t };
                }));

                var wxLines = wxData.map(w => {
                    var lines = [];
                    if (w.metar) lines.push(`METAR ${w.icao}: ${w.metar.raw}`);
                    if (w.taf) lines.push(`TAF ${w.icao}: ${w.taf}`);
                    return lines.join("\n");
                }).join("\n");

                var prompt = `TRIP: ${ac.name} (${ac.cat}) cruise ${ac.kts}kt\n` +
                    `DEPARTURE: ${trip.date} at ${trip.time} Local Time\n` +
                    `ROUTE: ${allRoutePts.join(" -> ")}\n` +
                    `Distance: ${Math.round(distance)}nm  ETE: ${Math.floor(ete)}h${Math.round((ete % 1) * 60)}m\n\n` +
                    `=== LIVE WEATHER DATA ===\n${wxLines || "No live weather available."}`;

                const url = "https://api.anthropic.com/v1/messages";
                const payload = {
                    model: "claude-sonnet-4-6",
                    max_tokens: 1500,
                    system: "You are an expert aviation weather analyst providing a flight briefing. Use bullet points. Provide the briefing using EXACTLY these headers on their own lines: **GO/NO-GO RECOMMENDATION**, **WEATHER SYNOPSIS**, **DEPARTURE WINDOW**, **EN ROUTE HAZARDS**, **RUNWAY ANALYSIS**, **NOTAM IMPACT**, **ALTERNATE RECOMMENDATIONS**, **FREQUENCY GUIDE**",
                    messages: [{ role: "user", content: prompt }]
                };

                const fetchWithRetry = async (retries = 3) => {
                    const delays = [1000, 2000, 4000];
                    for (let i = 0; i <= retries; i++) {
                        try {
                            const response = await fetch(url, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "x-api-key": apiKey,
                                    "anthropic-version": "2023-06-01",
                                    "anthropic-dangerous-direct-browser-access": "true"
                                },
                                body: JSON.stringify(payload)
                            });
                            if (!response.ok) {
                                const errBody = await response.json().catch(() => ({}));
                                throw new Error(errBody?.error?.message || `HTTP ${response.status}`);
                            }
                            const data = await response.json();
                            const text = data.content?.[0]?.text;
                            if (!text) throw new Error("Empty response from Claude");
                            return text;
                        } catch (err) {
                            if (i === retries) throw err;
                            await new Promise(r => setTimeout(r, delays[i]));
                        }
                    }
                };

                try {
                    const responseText = await fetchWithRetry();
                    setResult(responseText);
                } catch (e) {
                    setError("Briefing failed: " + (e.message || "Please check your API key and try again."));
                } finally {
                    setLoading(false);
                }
            }, [trip, apiKey]);

            var sections = useMemo(() => {
                if (!result) return [];
                var out = []; var current = null;
                var validHeaders = ["GO/NO-GO RECOMMENDATION", "WEATHER SYNOPSIS", "DEPARTURE WINDOW", "EN ROUTE HAZARDS", "RUNWAY ANALYSIS", "NOTAM IMPACT", "ALTERNATE RECOMMENDATIONS", "FREQUENCY GUIDE"];

                result.split("\n").forEach(line => {
                    var cleanLine = line.replace(/\*/g, "").trim();
                    if (validHeaders.includes(cleanLine)) {
                        if (current) out.push(current);
                        current = { title: cleanLine, body: "" };
                    } else if (current) {
                        current.body += line + "\n";
                    }
                });
                if (current) out.push(current);
                return out;
            }, [result]);

            var sectionMeta = {
                "GO/NO-GO RECOMMENDATION": { icon: "check_circle", color: "var(--md-sys-color-primary)", bg: "var(--md-sys-color-primary-container)", onBg: "var(--md-sys-color-on-primary-container)" },
                "WEATHER SYNOPSIS": { icon: "routine", color: "var(--md-sys-color-secondary)" },
                "DEPARTURE WINDOW": { icon: "schedule", color: "var(--md-sys-color-tertiary)" },
                "EN ROUTE HAZARDS": { icon: "warning", color: "var(--md-sys-color-error)" },
                "RUNWAY ANALYSIS": { icon: "flight_takeoff", color: "var(--md-sys-color-primary)" },
                "NOTAM IMPACT": { icon: "report", color: "var(--md-sys-color-warning)" },
                "ALTERNATE RECOMMENDATIONS": { icon: "alt_route", color: "var(--md-sys-color-tertiary)" },
                "FREQUENCY GUIDE": { icon: "podcasts", color: "var(--md-sys-color-secondary)" }
            };

            return (
                <div style={{ paddingBottom: '32px' }}>
                    <div style={{ marginBottom: 16 }}>
                        <MdInput
                            label="Anthropic API Key"
                            value={apiKey}
                            onChange={e => setApiKey(e.target.value)}
                            placeholder="sk-ant-..."
                            type="password"
                        />
                    </div>
                    <MdButton
                        variant={loading ? "tonal" : "sparkle"}
                        onClick={runBriefing}
                        disabled={loading || !trip.dep || !trip.arr || !apiKey}
                        icon="auto_awesome"
                        style={{ width: "100%", padding: "16px", marginBottom: "24px", fontSize: "16px" }}
                    >
                        {loading ? "Fetching live weather & analyzing..." : "Generate AI Briefing"}
                    </MdButton>

                    {error && <MdCard style={{ background: "var(--md-sys-color-error-container)", color: "var(--md-sys-color-on-error-container)", marginBottom: "16px" }}><MdIcon name="error" style={{marginRight: 8}}/>{error}</MdCard>}
                    
                    {sections.map((s, i) => {
                        var meta = sectionMeta[s.title] || { icon: "info", color: "var(--md-sys-color-primary)" };
                        return (
                            <div key={i} style={{ 
                                background: meta.bg || "var(--md-sys-color-surface-container)", 
                                borderRadius: "16px", padding: "20px", marginBottom: "16px",
                                color: meta.onBg || "var(--md-sys-color-on-surface)"
                            }}>
                                <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 12 }}>
                                    <MdIcon name={meta.icon} style={{ color: meta.color, fontSize: 24 }} />
                                    <h3 style={{ margin: 0, fontSize: 16, fontWeight: 700, color: meta.color, letterSpacing: '0.5px' }}>{s.title}</h3>
                                </div>
                                <div style={{ fontSize: 14, lineHeight: 1.6, whiteSpace: "pre-wrap", color: meta.onBg || "var(--md-sys-color-on-surface-variant)" }}>
                                    {s.body.trim().replace(/-/g, "\u2022")}
                                </div>
                            </div>
                        );
                    })}
                    {!result && !loading && (
                        <div style={{ textAlign: "center", padding: "48px 24px", color: "var(--md-sys-color-on-surface-variant)" }}>
                            <MdIcon name="robot_2" style={{ fontSize: 48, opacity: 0.5, marginBottom: 16 }} />
                            <div style={{ fontSize: 16, maxWidth: "400px", margin: "0 auto", lineHeight: 1.5 }}>
                                Claude AI will fetch live METARs &amp; TAFs from AviationWeather.gov, then generate a comprehensive flight briefing. Enter your Anthropic API key above.
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        /* =========================================
           MAIN APPLICATION COMPONENT
        ========================================= */
        function App() {
            var [view, setView] = useState("trips");
            var defaultTimeStr = (new Date(Date.now() + 7200000)).toTimeString().slice(0, 5);

            var [trips, setTrips] = useState([
                { id: 1, dep: "KCLT", arr: "KATL", aircraft: "c172", date: "2026-02-28", time: "09:00", wps: [], name: "Charlotte to Atlanta", goScore: null },
                { id: 2, dep: "KJFK", arr: "KBOS", aircraft: "sr22", date: "2026-03-01", time: "14:30", wps: ["KORH"], name: "New York to Boston", goScore: null },
            ]);
            var [activeTrip, setActiveTrip] = useState(null);
            var [tab, setTab] = useState("brief");
            var [forecastDay, setForecastDay] = useState(0);
            var [newTrip, setNewTrip] = useState({ route: ["", ""], aircraft: "c172", date: "", time: defaultTimeStr, name: "" });
            // Bump this counter to force re-renders after async airport fetches resolve
            var [aptVersion, setAptVersion] = useState(0);

            useEffect(() => {
                // Fetch live METARs for each trip to compute live Go/No-Go scores
                trips.forEach(t => {
                    Promise.all([fetchLiveMetar(t.dep), fetchLiveMetar(t.arr)]).then(([dm, am]) => {
                        var score = dm && am ? calcGoScoreFromMetars(dm, am)
                            : (getAirport(t.dep) && getAirport(t.arr) ? calcGoScore(t.dep, t.arr) : 50);
                        setTrips(prev => prev.map(x => x.id === t.id ? { ...x, goScore: score } : x));
                    }).catch(() => {});
                });
            }, []);

            // Auto-fetch real data for any unknown ICAOs typed in the create form
            useEffect(() => {
                const candidates = newTrip.route
                    .map(r => r.trim().toUpperCase())
                    .filter(r => r.length === 4 && !AIRPORTS[r]);
                if (candidates.length === 0) return;
                Promise.all(candidates.map(fetchAirportInfo)).then(results => {
                    if (results.some(Boolean)) setAptVersion(v => v + 1);
                }).catch(() => {});
            }, [newTrip.route.join(',')]);

            function createTrip() {
                var validRoute = newTrip.route
                    .map(r => r.trim().toUpperCase())
                    .filter(r => r.length === 4);
                if (validRoute.length < 2) return;

                var t = {
                    id: Date.now(),
                    dep: validRoute[0],
                    arr: validRoute[validRoute.length - 1],
                    wps: validRoute.slice(1, -1),
                    aircraft: newTrip.aircraft,
                    date: newTrip.date,
                    time: newTrip.time,
                    name: newTrip.name || (validRoute[0] + " to " + validRoute[validRoute.length - 1]),
                    goScore: calcGoScore(validRoute[0], validRoute[validRoute.length - 1])
                };
                setTrips(prev => [t].concat(prev));
                // Async update go score with live METARs
                Promise.all([fetchLiveMetar(t.dep), fetchLiveMetar(t.arr)]).then(([dm, am]) => {
                    if (dm && am) setTrips(prev => prev.map(x => x.id === t.id ? { ...x, goScore: calcGoScoreFromMetars(dm, am) } : x));
                }).catch(() => {});
                setNewTrip({ route: ["", ""], aircraft: "c172", date: "", time: defaultTimeStr, name: "" });
                setView("trips");
            }

            function openTrip(trip) {
                var updated = { ...trip, goScore: calcGoScore(trip.dep, trip.arr) };
                setActiveTrip(updated); setTab("brief"); setForecastDay(0);
                setView("briefing");
                // Async refresh go score with live METARs
                Promise.all([fetchLiveMetar(trip.dep), fetchLiveMetar(trip.arr)]).then(([dm, am]) => {
                    if (dm && am) setActiveTrip(prev => prev && prev.id === trip.id ? { ...prev, goScore: calcGoScoreFromMetars(dm, am) } : prev);
                }).catch(() => {});
            }

            function deleteTrip(id) {
                setTrips(prev => prev.filter(t => t.id !== id));
                if (activeTrip && activeTrip.id === id) { setActiveTrip(null); setView("trips"); }
            }

            var tabList = [
                { id: "brief", label: "Briefing", icon: "auto_awesome" },
                { id: "wx", label: "Weather", icon: "partly_cloudy_day" },
                { id: "notam", label: "NOTAMs", icon: "warning" },
                { id: "freq", label: "Freqs", icon: "cell_tower" },
                { id: "map", label: "Map", icon: "map" }
            ];

            return (
                <div style={{ display: "flex", flexDirection: "column", height: "100vh", overflow: "hidden" }}>
                    
                    {/* MD3 Top App Bar */}
                    <header style={{ 
                        height: "64px", display: "flex", alignItems: "center", justifyContent: "space-between", 
                        padding: "0 16px", background: "var(--md-sys-color-surface)", 
                        color: "var(--md-sys-color-on-surface)",
                        boxShadow: "0 1px 2px rgba(0,0,0,0.05)", zIndex: 10 
                    }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 16 }}>
                            {view === "briefing" ? (
                                <MdButton variant="text" icon="arrow_back" onClick={() => { setView("trips"); setActiveTrip(null); }} style={{ padding: '8px' }} />
                            ) : (
                                <MdIcon name="flight" style={{ color: 'var(--md-sys-color-primary)', fontSize: 28, marginLeft: 8 }} />
                            )}
                            <div style={{ fontSize: 22, fontWeight: 500 }}>SkyClear</div>
                        </div>
                        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                            <MdButton variant="tonal" icon="add" onClick={() => setView("create")}>New Trip</MdButton>
                            <MdButton variant="text" icon="account_circle" style={{ padding: '8px' }} />
                        </div>
                    </header>

                    <main style={{ flex: 1, overflowY: "auto", background: "var(--md-sys-color-background)" }}>
                        
                        {/* TRIPS LIST */}
                        {view === "trips" && (
                            <div style={{ maxWidth: 840, margin: "0 auto", padding: "32px 16px" }}>
                                <h1 style={{ fontSize: 32, fontWeight: 400, margin: "0 0 24px", color: "var(--md-sys-color-on-background)" }}>My Trips</h1>
                                <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
                                    {trips.map(trip => {
                                        var ac = AIRCRAFT.find(a => a.id === trip.aircraft) || AIRCRAFT[0];
                                        
                                        var fullRoute = [trip.dep].concat(trip.wps || []).concat([trip.arr]).map(r => r ? r.trim().toUpperCase() : r);
                                        var validRoutePts = fullRoute.filter(r => r && getAirport(r));
                                        var d = 0;
                                        for (var i = 0; i < validRoutePts.length - 1; i++) {
                                            var p1 = getAirport(validRoutePts[i]);
                                            var p2 = getAirport(validRoutePts[i+1]);
                                            if (p1 && p2) d += calcDist(p1.lat, p1.lon, p2.lat, p2.lon);
                                        }
                                        var ete = ac ? d / ac.kts : 0;
                                        
                                        return (
                                            <MdCard key={trip.id} onClick={() => openTrip(trip)} style={{ padding: 0, overflow: 'hidden' }}>
                                                <div style={{ display: "flex", alignItems: "stretch" }}>
                                                    <div style={{ width: 100, display: "flex", alignItems: "center", justifyContent: "center", padding: 16, background: "var(--md-sys-color-surface-container-highest)" }}>
                                                        {trip.goScore ? <GoScoreRing score={trip.goScore} size={70} /> : <MdIcon name="pending" />}
                                                    </div>
                                                    <div style={{ flex: 1, padding: "16px 20px" }}>
                                                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 8 }}>
                                                            <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
                                                                {fullRoute.map((rt, idx) => (
                                                                    <React.Fragment key={idx}>
                                                                        <span className="font-mono" style={{ fontSize: 20, fontWeight: 700, color: idx === 0 ? "var(--md-sys-color-primary)" : idx === fullRoute.length - 1 ? "var(--md-sys-color-tertiary)" : "var(--md-sys-color-secondary)" }}>{rt}</span>
                                                                        {idx < fullRoute.length - 1 && <MdIcon name="flight" style={{ color: "var(--md-sys-color-outline)", transform: "rotate(45deg)", fontSize: "18px" }} />}
                                                                    </React.Fragment>
                                                                ))}
                                                            </div>
                                                            <MdButton variant="text" icon="delete" onClick={(e) => { e.stopPropagation(); deleteTrip(trip.id); }} style={{ padding: '8px', margin: '-8px', color: 'var(--md-sys-color-outline)' }} />
                                                        </div>
                                                        <div style={{ display: "flex", alignItems: "center", gap: 16, fontSize: 14, color: "var(--md-sys-color-on-surface-variant)", flexWrap: "wrap" }}>
                                                            <span>{fullRoute.map(rt => getAirport(rt)?.city).filter(Boolean).join(" \u2794 ")}</span>
                                                            <span className="font-mono" style={{ background: 'var(--md-sys-color-surface-variant)', padding: '2px 8px', borderRadius: '4px', fontSize: 12 }}>{Math.round(d)} NM</span>
                                                            {ete > 0 && <span className="font-mono" style={{ background: 'var(--md-sys-color-surface-variant)', padding: '2px 8px', borderRadius: '4px', fontSize: 12 }}>{Math.floor(ete)}h{Math.round((ete % 1) * 60)}m</span>}
                                                            <span>{ac.name}</span>
                                                        </div>
                                                        {(trip.date || trip.time) && <div style={{ fontSize: 13, color: "var(--md-sys-color-on-surface-variant)", marginTop: 8, display: 'flex', alignItems: 'center', gap: 4 }}><MdIcon name="calendar_today" style={{fontSize: 14}}/> {trip.date} {trip.time && `\u2022 ${trip.time}`}</div>}
                                                    </div>
                                                </div>
                                            </MdCard>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* CREATE TRIP */}
                        {view === "create" && (
                            <div style={{ maxWidth: 600, margin: "0 auto", padding: "32px 16px" }}>
                                <MdButton variant="text" icon="arrow_back" onClick={() => setView("trips")} style={{ marginLeft: '-16px', marginBottom: '16px' }}>Back</MdButton>
                                <h1 style={{ fontSize: 32, fontWeight: 400, margin: "0 0 24px", color: "var(--md-sys-color-on-background)" }}>Plan a Flight</h1>
                                
                                <MdCard style={{ padding: 24 }}>
                                    <div style={{ display: "flex", flexDirection: "column", gap: 16, marginBottom: 24 }}>
                                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                                            <div style={{ fontSize: 14, fontWeight: 500, color: "var(--md-sys-color-on-surface)" }}>Flight Route (Up to 5 legs)</div>
                                            {newTrip.route.length < 6 && (
                                                <MdButton variant="tonal" icon="add" onClick={() => {
                                                    let r = [...newTrip.route];
                                                    r.splice(r.length - 1, 0, "");
                                                    setNewTrip({...newTrip, route: r});
                                                }} style={{ padding: '6px 12px', fontSize: 12 }}>Add Leg</MdButton>
                                            )}
                                        </div>
                                        
                                        {newTrip.route.map((r, i) => {
                                            let isDep = i === 0;
                                            let isArr = i === newTrip.route.length - 1;
                                            let label = isDep ? "Departure ICAO" : isArr ? "Destination ICAO" : `Waypoint ${i} ICAO`;
                                            let icon = isDep ? "flight_takeoff" : isArr ? "flight_land" : "location_on";
                                            
                                            return (
                                                <div key={i} style={{ display: "flex", alignItems: "flex-end", gap: 12 }}>
                                                    <MdIcon name={icon} style={{ color: "var(--md-sys-color-on-surface-variant)", marginBottom: 12 }} />
                                                    <MdInput 
                                                        label={label}
                                                        value={r} 
                                                        onChange={e => {
                                                            let newRoute = [...newTrip.route];
                                                            newRoute[i] = e.target.value.trim().toUpperCase();
                                                            setNewTrip({...newTrip, route: newRoute});
                                                        }} 
                                                        placeholder={isDep ? "KCLT" : isArr ? "KATL" : "KORD"} 
                                                        maxLength={4} 
                                                        containerStyle={{ flex: 1 }}
                                                    />
                                                    {(!isDep && !isArr && newTrip.route.length > 2) && (
                                                        <MdButton variant="text" icon="close" onClick={() => {
                                                            let newRoute = [...newTrip.route];
                                                            newRoute.splice(i, 1);
                                                            setNewTrip({...newTrip, route: newRoute});
                                                        }} style={{ padding: '8px', color: "var(--md-sys-color-error)", marginBottom: 4 }} />
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 24 }}>
                                        <MdSelect label="Aircraft" value={newTrip.aircraft} onChange={e => setNewTrip({...newTrip, aircraft: e.target.value})} options={AIRCRAFT.map(a => ({value: a.id, label: `${a.name} (${a.cat})`}))} />
                                        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                                            <MdInput type="date" label="Date" value={newTrip.date} onChange={e => setNewTrip({...newTrip, date: e.target.value})} />
                                            <MdInput type="time" label="Time" value={newTrip.time} onChange={e => setNewTrip({...newTrip, time: e.target.value})} />
                                        </div>
                                    </div>
                                    
                                    {(() => {
                                        var validRoutePts = newTrip.route
                                            .map(r => r.trim().toUpperCase())
                                            .filter(r => r.length === 4 && getAirport(r));
                                        if (validRoutePts.length < 2) return null;
                                        var dist = 0;
                                        for (var i = 0; i < validRoutePts.length - 1; i++) {
                                            var p1 = getAirport(validRoutePts[i]);
                                            var p2 = getAirport(validRoutePts[i+1]);
                                            dist += calcDist(p1.lat, p1.lon, p2.lat, p2.lon);
                                        }
                                        var ac = AIRCRAFT.find(x => x.id === newTrip.aircraft) || AIRCRAFT[0];
                                        var ete = dist / ac.kts;
                                        return (
                                            <div className="font-mono" style={{ background: "var(--md-sys-color-surface-container-high)", borderRadius: 12, padding: 16, marginBottom: 24, display: "flex", justifyContent: "space-around", fontSize: 13 }}>
                                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)" }}>DIST </span><span style={{ color: "var(--md-sys-color-primary)", fontWeight: 700 }}>{Math.round(dist)} NM</span></div>
                                                <div><span style={{ color: "var(--md-sys-color-on-surface-variant)" }}>ETE </span><span style={{ color: "var(--md-sys-color-primary)", fontWeight: 700 }}>{Math.floor(ete)}h {Math.round((ete % 1) * 60)}m</span></div>
                                            </div>
                                        );
                                    })()}

                                    <div style={{ display: "flex", gap: 12, justifyContent: "flex-end", marginTop: 16 }}>
                                        <MdButton variant="text" onClick={() => setView("trips")}>Cancel</MdButton>
                                        <MdButton variant="primary" onClick={createTrip} disabled={newTrip.route.filter(r => r.length === 4).length < 2}>Create Trip</MdButton>
                                    </div>
                                </MdCard>

                                <div style={{ marginTop: 24 }}>
                                    <div style={{ fontSize: 13, fontWeight: 500, color: "var(--md-sys-color-on-surface-variant)", marginBottom: 12 }}>Popular Hubs</div>
                                    <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                                        {Object.keys(AIRPORTS).slice(0, 15).map(k => (
                                            <span key={k} onClick={() => {
                                                let newRoute = [...newTrip.route];
                                                let emptyIdx = newRoute.findIndex(r => !r || r.length < 4);
                                                if (emptyIdx !== -1) {
                                                    newRoute[emptyIdx] = k;
                                                    setNewTrip({...newTrip, route: newRoute});
                                                } else if (newRoute.length < 6) {
                                                    newRoute.splice(newRoute.length - 1, 0, k);
                                                    setNewTrip({...newTrip, route: newRoute});
                                                }
                                            }} className="font-mono" style={{ 
                                                fontSize: 12, color: "var(--md-sys-color-on-surface)", 
                                                background: "var(--md-sys-color-surface-container)", 
                                                padding: "6px 12px", borderRadius: "16px", cursor: "pointer",
                                                border: "1px solid var(--md-sys-color-outline-variant)" 
                                            }}>{k}</span>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* TRIP BRIEFING */}
                        {view === "briefing" && activeTrip && (() => {
                            var ac = AIRCRAFT.find(a => a.id === activeTrip.aircraft) || AIRCRAFT[0];
                            var fullRoute = [activeTrip.dep].concat(activeTrip.wps || []).concat([activeTrip.arr]);
                            
                            return (
                                <div style={{ display: "flex", height: "100%" }}>
                                    {/* MD3 Navigation Rail */}
                                    <div style={{ 
                                        width: "80px", background: "var(--md-sys-color-surface)", 
                                        borderRight: "1px solid var(--md-sys-color-outline-variant)",
                                        display: "flex", flexDirection: "column", alignItems: "center", paddingTop: 16, gap: 12
                                    }}>
                                        {tabList.map(t => {
                                            var active = tab === t.id;
                                            return (
                                                <button key={t.id} onClick={() => setTab(t.id)} style={{
                                                    background: "none", border: "none", display: "flex", flexDirection: "column", 
                                                    alignItems: "center", cursor: "pointer", width: "100%", padding: "8px 0"
                                                }}>
                                                    <div style={{ 
                                                        background: active ? "var(--md-sys-color-secondary-container)" : "transparent",
                                                        color: active ? "var(--md-sys-color-on-secondary-container)" : "var(--md-sys-color-on-surface-variant)",
                                                        borderRadius: "16px", padding: "4px 16px", transition: "background 0.2s"
                                                    }}>
                                                        <MdIcon name={t.icon} style={{ fontSize: 24 }} />
                                                    </div>
                                                    <span style={{ 
                                                        fontSize: 11, fontWeight: active ? 600 : 400, marginTop: 4,
                                                        color: active ? "var(--md-sys-color-on-surface)" : "var(--md-sys-color-on-surface-variant)"
                                                    }}>{t.label}</span>
                                                </button>
                                            )
                                        })}
                                    </div>

                                    {/* Content Area */}
                                    <div style={{ flex: 1, display: "flex", flexDirection: "column", overflow: "hidden", background: "var(--md-sys-color-background)" }}>
                                        {/* Trip Header Banner */}
                                        <div style={{ padding: "16px 24px", display: "flex", alignItems: "center", gap: 24, borderBottom: "1px solid var(--md-sys-color-surface-variant)" }}>
                                            <GoScoreRing score={activeTrip.goScore || 50} size={56} />
                                            <div>
                                                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4, flexWrap: "wrap" }}>
                                                    {fullRoute.map((rt, idx) => (
                                                        <React.Fragment key={idx}>
                                                            <span className="font-mono" style={{ fontSize: 22, fontWeight: 700, color: idx === 0 ? "var(--md-sys-color-primary)" : idx === fullRoute.length - 1 ? "var(--md-sys-color-tertiary)" : "var(--md-sys-color-secondary)" }}>{rt}</span>
                                                            {idx < fullRoute.length - 1 && <MdIcon name="flight" style={{ color: "var(--md-sys-color-outline)", transform: "rotate(45deg)", fontSize: "18px" }} />}
                                                        </React.Fragment>
                                                    ))}
                                                </div>
                                                <div style={{ fontSize: 13, color: "var(--md-sys-color-on-surface-variant)" }}>
                                                    {ac.name} \u2022 {activeTrip.date}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Scrollable Tab Content */}
                                        <div style={{ flex: 1, overflowY: "auto", padding: "24px", maxWidth: "900px", margin: "0 auto", width: "100%" }}>
                                            {tab === "brief" && <AIBriefing trip={activeTrip} />}
                                            
                                            {tab === "wx" && (
                                                <div style={{display: 'flex', flexDirection: 'column', gap: '24px'}}>
                                                    {fullRoute.map((rt, idx) => {
                                                        let label = idx === 0 ? "Departure" : idx === fullRoute.length - 1 ? "Destination" : `Waypoint ${idx}`;
                                                        return (
                                                            <div key={idx}>
                                                                <h2 style={{fontSize: 16, fontWeight: 500, margin: "0 0 12px", color: "var(--md-sys-color-on-surface)"}}>
                                                                    {label} - {getAirport(rt)?.city || rt}
                                                                </h2>
                                                                <WeatherDetail icao={rt} label={label} />
                                                                <ForecastStrip icao={rt} selectedDay={forecastDay} onSelect={setForecastDay} />
                                                            </div>
                                                        );
                                                    })}

                                                    <WindyMap dep={activeTrip.dep} arr={activeTrip.arr} wps={activeTrip.wps || []} />

                                                    <div>
                                                        <h2 style={{fontSize: 16, fontWeight: 500, margin: "0 0 12px", color: "var(--md-sys-color-on-surface)"}}>En Route PIREPs</h2>
                                                        <MdCard style={{ padding: 12 }}>
                                                            {makePireps(activeTrip.dep, activeTrip.arr).map((p, i) => (
                                                                <div key={i} className="font-mono" style={{ background: "var(--md-sys-color-surface-container-highest)", borderRadius: "8px", padding: "12px", marginBottom: i===0?8:0, borderLeft: "4px solid var(--md-sys-color-primary)", fontSize: 12, color: "var(--md-sys-color-on-surface)", lineHeight: 1.6 }}>
                                                                    <span style={{ color: "var(--md-sys-color-primary)", fontWeight: 700, marginRight: 8 }}>{p.type}</span>{p.text}
                                                                </div>
                                                            ))}
                                                        </MdCard>
                                                    </div>
                                                </div>
                                            )}

                                            {tab === "notam" && (
                                                <div style={{display: 'flex', flexDirection: 'column', gap: '24px'}}>
                                                    {fullRoute.map((rt, idx) => (
                                                        <div key={idx}>
                                                            <h2 style={{fontSize: 16, fontWeight: 500, margin: "0 0 12px", color: "var(--md-sys-color-on-surface)"}}>
                                                                NOTAMs - {rt}
                                                            </h2>
                                                            <NotamsPanel icao={rt} />
                                                        </div>
                                                    ))}
                                                </div>
                                            )}

                                            {tab === "freq" && (
                                                <div style={{display: 'flex', flexDirection: 'column', gap: '24px'}}>
                                                    {fullRoute.map((rt, idx) => (
                                                        <FreqPanel key={idx} icao={rt} />
                                                    ))}
                                                </div>
                                            )}

                                            {tab === "map" && (
                                                <RouteMap dep={activeTrip.dep} arr={activeTrip.arr} wps={activeTrip.wps || []} />
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })()}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
